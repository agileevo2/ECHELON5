<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>KOMMANDOPORTAL // ECHELON 5</title>
    <!-- S√∏rger for at den ser bra ut p√• mobil -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <style>
        /* --- GRUNNLEGGENDE STIL --- */
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Consolas', 'Courier New', monospace; /* Agent/Terminal-font */
            background-color: #0a0a0a; /* Svart bakunn */
            color: #d4d4d4; /* Lys gr√• tekst */
            font-size: 15px;
            line-height: 1.6;
        }

        /* --- HOVEDLAYOUT --- */
        #portal {
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Fyller hele skjermen */
            max-width: 700px; /* God lesebredde */
            margin: 0 auto;
            border-left: 1px solid #333;
            border-right: 1px solid #333;
        }

        /* --- HEADER --- */
        #header {
            background-color: #1a1a1a;
            border-bottom: 2px solid #ff9900; /* Aksentfarge (oransje/amber) */
            padding: 12px 20px;
            text-align: center;
        }

        #header h1 {
            margin: 0;
            color: #ff9900;
            font-size: 1.1rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* --- MELDINGSVISNING --- */
        #message-display {
            padding: 20px;
            flex-grow: 1; /* Tar opp all ledig plass */
            background-color: #111;
        }

        /* Meldingstitler (f.eks. CLASSIFIED MESSAGE) */
        #message-display h4 {
            color: #ff9900;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
            margin-top: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.1rem;
        }

        /* Undertitler (f.eks. Reiseordre) */
        #message-display h5 {
            color: #b5b5b5;
            text-transform: uppercase;
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        #message-display p {
            margin-bottom: 15px;
        }

        /* Punktlister */
        #message-display ol {
             margin-left: 20px;
            padding-left: 10px;
        }
        #message-display ul {
            list-style-type: '‚Ä¢ ';
            margin-left: 20px;
            padding-left: 10px;
        }

        #message-display li {
            margin-bottom: 8px;
        }

        /* Uthevet tekst (f.eks. koordinater) */
        #message-display strong {
            color: #ffc266; /* Lysere oransje */
            font-weight: normal; /* Fonten er allerede "bold" */
        }
        
        /* Spesiell klasse for advarsler */
        .warning {
            color: #ff5555 !important; /* R√∏d for feilmeldinger */
        }
        
        /* Lenker til kart */
        .location-link {
            color: #ffc266;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 3px;
        }
        .location-link:hover {
            color: #ffd9a6;
        }
        
        /* Nedlastingsknapp / GPS-knapp */
        .download-button {
            display: block;
            background-color: #ff9900;
            color: #111;
            text-decoration: none;
            text-align: center;
            padding: 15px 20px;
            margin-top: 25px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 4px;
            cursor: pointer;
            border: none; /* S√∏rger for at button-elementer ser like ut */
            font-family: 'Consolas', 'Courier New', monospace; /* Arver font */
            font-size: 0.9rem; /* Justert st√∏rrelse */
        }
        .download-button:hover {
            background-color: #ffc266;
        }
        .download-button:disabled {
            background-color: #555;
            color: #999;
            cursor: not-allowed;
        }


        /* Laste-animasjon */
        .loader {
            text-align: center;
            padding: 40px 20px;
            color: #ff9900;
            font-size: 1.1rem;
            animation: flicker 1.5s infinite alternate;
        }

        @keyframes flicker {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* --- INNTASTINGSOMR√ÖDE --- */
        /* Klistrer seg til bunnen av skjermen p√• mobil */
        #input-form {
            background-color: #1a1a1a;
            border-top: 2px solid #ff9900;
            padding: 15px;
            display: none; /* --- NYTT: Skjult som standard --- */
            position: sticky;
            bottom: 0;
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
        }

        #code-input {
            flex-grow: 1; /* Tar opp mesteparten av plassen */
            background: #222;
            border: 1px solid #444;
            color: #d4d4d4;
            padding: 14px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 1rem;
            border-radius: 4px 0 0 4px;
        }
        #code-input:focus {
            outline: none;
            border-color: #ff9900;
            background-color: #333;
        }

        #submit-btn {
            background-color: #ff9900;
            border: none;
            color: #111;
            padding: 14px 18px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 0 4px 4px 0; /* OPPDATERT */
            font-size: 1rem;
        }

        /* --- NY STYLING FOR ARKIV-KNAPP --- */
        #menu-btn {
            background-color: #444;
            border: none;
            color: #d4d4d4;
            padding: 14px 18px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            font-size: 1rem;
            /* Fjerner border-radius for √• passe i midten */
            border-radius: 0; 
            /* Legger til tynne skiller */
            border-left: 1px solid #0a0a0a;
            border-right: 1px solid #0a0a0a;
            transition: background-color 0.2s;
        }
        #menu-btn:hover {
            background-color: #666;
        }
        /* --- SLUTT P√Ö NY STYLING --- */

        /* --- NY STYLING FOR KODENAVN-INNLOGGING --- */
        #login-form-container {
            margin-top: 20px;
        }
        #codename-input {
            display: block;
            width: 100%;
            background: #222;
            border: 1px solid #444;
            color: #d4d4d4;
            padding: 14px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 1rem;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        #codename-input:focus {
            outline: none;
            border-color: #ff9900;
            background-color: #333;
        }
        #codename-submit-btn {
            display: block;
            width: 100%;
            background-color: #ff9900;
            border: none;
            color: #111;
            padding: 14px 18px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 4px;
            font-size: 1rem;
        }
        #login-feedback {
            padding: 10px 0;
            text-align: center;
        }
        /* --- SLUTT P√Ö NY STYLING --- */


        /* --- NY STYLING FOR MASTER PORTAL --- */
        .master-list {
            border-top: 1px solid #444;
            margin-top: 20px;
        }
        .master-link {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 1px solid #333;
            text-decoration: none;
            color: #d4d4d4;
            transition: background-color 0.2s;
        }
        .master-link:hover {
            background-color: #1f1f1f;
            color: #ffc266;
        }
        .master-link strong {
            font-size: 1.1rem;
            color: #ffc266;
        }
        .master-link span {
            font-size: 0.9rem;
            color: #888;
        }
        /* --- SLUTT P√Ö MASTER PORTAL STYLING --- */


        /* Omr√•de for feilmeldinger */
        #feedback {
            padding: 0 15px;
            text-align: center;
        }

    </style>
</head>
<body>

    <div id="portal">
        
        <!-- 1. HEADER -->
        <header id="header">
            <h1>ECHELON 5 // KOMMANDOPORTAL</h1>
        </header>

        <!-- 2. MELDINGSBOKS (Her vises alt innhold) -->
        <main id="message-display">
            <!-- Innholdet settes n√• dynamisk av JavaScript -->
            <!-- Viser en "laster"-melding mens Firebase initialiserer -->
            <div class="loader">
                ETABLERER TILKOBLING TIL ECHELON 5...<br>
                VENTER P√Ö SIKKERT SIGNAL...
            </div>
        </main>

        <!-- 3. TILBAKEMELDING (For "Adgang Nektet") -->
        <div id="feedback"></div>

        <!-- 4. INNTASTINGSFELT (Klistret til bunnen) -->
        <form id="input-form">
            <input type="text" id="code-input" placeholder="Skriv autorisasjonskode..." autocomplete="off">
            <!-- NY ARKIV-KNAPP -->
            <button type="button" id="menu-btn">Arkiv</button>
            <button type="submit" id="submit-btn">DEKRYPTER</button>
        </form>

    </div>

    <!-- 
      ======================================================
      --- ALL APPLIKASJONSLOGIKK SAMLET HER ---
      Dette er en mer robust m√•te √• forhindre "race conditions"
      ======================================================
    -->
    <script type="module">
        // --- 1. IMPORTER FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, getDoc, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 2. VENT TIL HELE SIDEN ER LASTET ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 3. DEFINER GLOBALE VARIABLER OG DATABASER ---

            // --- MANUELL FIREBASE KONFIGURASJON ---
            // N√∏klene er n√• lagt inn manuelt
            const firebaseConfig = {
                apiKey: "AIzaSyCDcowm--WHC7saXt-YWtg2a2pXC93KSLI",
                authDomain: "echelon-6.firebaseapp.com",
                projectId: "echelon-6",
                storageBucket: "echelon-6.firebasestorage.app",
                messagingSenderId: "1037789395235",
                appId: "1:1037789395235:web:b1b25339342d7e4514f496",
                measurementId: "G-0RQLGZEV5V"
            };

            // Globale Firebase-variabler
            let db, auth, userId, isAuthReady = false;

            // Liste over gyldige kodenavn
            const validCodenames = ['raven', 'falcon', 'viper', 'cobra', 'shadow'];

            // Hent kjerne-HTML-elementer
            const messageDisplay = document.getElementById('message-display');
            const codeInput = document.getElementById('code-input');
            const feedbackDisplay = document.getElementById('feedback');
            const inputForm = document.getElementById('input-form');
            const menuBtn = document.getElementById('menu-btn');
            const submitBtn = document.getElementById('submit-btn');

            // Sjekk om elementene finnes
            if (!messageDisplay || !codeInput || !feedbackDisplay || !inputForm || !menuBtn || !submitBtn) {
                console.error("KRITISK FEIL: Kunne ikke finne kjerne-HTML-elementer.");
                document.body.innerHTML = "<h1 style='color: red; text-align: center; margin-top: 50px;'>KRITISK SYSTEMFEIL.<br>KUNNE IKKE LASTE PORTAL.</h1>";
                return;
            }

            // --- 4. DEFINER MELDINGS-DATABASER ---

            const briefings = {
                
                // --- FASE 1: OSLO ---
                'team oslo': `
                    <h4>CLASSIFIED MESSAGE ‚Äî CELL O</h4>
                    <h5>Clearance Level: ECHELON 4</h5>
                    <p>Agent <strong>RAVEN</strong> og Agent <strong>FALCON</strong>, dere er n√• aktivert som Airborne Division. Etterretningen har registrert aktivitet i s√∏r.</p>
                    <p><strong>Din rolle:</strong> Observasjon og identifikasjon.</p>
                    
                    <h5>Reiseordre:</h5>
                    <ul>
                        <li>Transportmiddel: <strong>Tog</strong></li>
                        <li>Avreisedato: <strong>27. november</strong></li>
                        <li>Avgang: <strong>Oslo S kl. 09:25</strong></li>
                        <li>Destinasjon: <strong>Fortrolig</strong></li>
                    </ul>
                    <p>Ved ankomst skal dere ta dere til f√∏lgende observasjonspunkt:<br>
                    <a href="https://www.google.com/maps/search/?api=1&query=58%C2%B008'40.6%22N+7%C2%B¬∞59'20.2%22E" target="_blank" class="location-link"><strong>58¬∞08'40.6"N 7¬∞59'20.2"E</strong></a></p>
                    
                    <h5>Oppdrag:</h5>
                    <p>Overv√•k omr√•det fra avstand. Et kj√∏ret√∏y med registreringsnummer <strong>SD73382</strong> skal ankomme. F√∏reren har informasjon som er relevant for oppdragets videre fase.</p>
                    <p><strong>Ikke gj√∏r kontakt</strong> f√∏r situasjonen er vurdert som trygg. N√•r observasjonen er fullf√∏rt, vent p√• nytt signal.</p>
                    <p>Kodeord-del tildelt: <strong>AURORA</strong><br>(Behold dette ‚Äì brukes senere.)</p>
                    <p>‚Äî Command Out.</p>
                    <a href="#" class="download-button" onclick="downloadPakkliste()">Last ned Pakkliste (Echelon 3)</a>
                `,

                // --- FASE 1: STAVANGER ---
                'team stavanger': `
                    <h4>CLASSIFIED MESSAGE ‚Äî CELL S</h4>
                    <h5>Clearance Level: ECHELON 4</h5>
                    <p>Agenter <strong>VIPER</strong>, <strong>COBRA</strong> og <strong>SHADOW</strong> ‚Äî dere er n√• aktivert som Ground Intelligence Unit. Etterretningen har registrert aktivitet i s√∏r.</p>
                    <p><strong>Din rolle:</strong> Infiltrasjon og feltobservasjon.</p>

                    <h5>Reiseordre:</h5>
                    <ul>
                        <li>Transportmiddel: <strong>Bil</strong></li>
                        <li>Avreisedato: <strong>27. november</strong></li>
                        <li>Avgang: <strong>Stavanger kl. 11:30</strong></li>
                        <li>Destinasjon: <strong>Fortrolig</strong></li>
                    </ul>
                    <p>Ved ankomst skal dere posisjonere dere ved f√∏lgende koordinater:<br>
                    <a href="https://www.google.com/maps/search/?api=1&query=58%C2%B¬∞08'40.6%22N+7%C2%B¬∞59'20.2%22E" target="_blank" class="location-link"><strong>58¬∞08'40.6"N 7¬∞59'20.2"E</strong></a></p>

                    <h5>Oppdrag:</h5>
                    <p>Etabler observasjonspunkt p√• parkeringsplassen. Dere vil bli kontaktet av en person som vet at dere kommer. Be om √• f√• kodeordet.</p>
                    <p>V√¶r √•rv√•kne ‚Äî omr√•det kan v√¶re under overv√•king.</p>
                    <p>Kodeord-del tildelt: <strong>BOREALIS</strong><br>(Behold dette ‚Äì brukes senere.)</p>
                    <p>‚Äî Command Out.</p>
                    <a href="#" class="download-button" onclick="downloadPakkliste()">Last ned Pakkliste (Echelon 3)</a>
                `,

                // --- FASE 2: SAMMENSL√ÖING ---
                'aurora borealis': `
                    <h4>DIREKTIV K ‚Äî VERIFISERT</h4>
                    <p>Sammensl√•ing av celler godkjent. Nytt direktiv:</p>
                    <p>Dere skal ta ferjen som g√•r til Hirtshals <strong>16:30</strong>.</p>
                    <p><a href="https://storage.googleapis.com/files_webpage/Privat/Colourline%20bilett.pdf" target="_blank" class="location-link"><strong>Referanse: Ferjebilletter</strong></a></p>
                    <p>N√•r dere er ombord p√• b√•ten f√•r dere videre instruksjoner av Agent <strong>SHADOW</strong>.</p>
                    <p>‚Äî Command Out.</p>
                `,

                // --- FASE 2: FERGE (KODE 1) ---
                'jylland': `
                    <h4>CLASSIFIED TRANSMISSION ‚Äî SHIPBOARD DIRECTIVE</h4>
                    <p>Godkjent tilgang.</p>
                    <p>Under overfarten har systemet fanget opp et fragmentert signal med seks elementer. Hvert element representerer b√•de en bokstav og et tall, men bare en av delene er korrekt.</p>
                    <p>Krypteringsmetoden f√∏lger <strong>NORSE‚Äì6-protokollen</strong> ‚Äì en kombinasjon av fonetisk og numerisk substitusjon.</p>

                    <h5>Intercepted sequence:</h5>
                    <p><strong>11-K, 15-O, 14-N, 22-V, 15-O, 25-Y</strong></p>

                    <h5>For √• finne riktig bokstavkode m√• dere:</h5>
                    <ol>
                        <li><strong>Avdekke m√∏nsteret:</strong><br>
                        Tallene refererer til alfabetets posisjoner (A = 1 ‚Ä¶ Z = 26). Men <strong>noen</strong> av tallene er falske; de skjuler seg bak primtall. Finn hvilke tall i sekvensen som er primtall, og bytt ut tilh√∏rende bokstaver med bokstaven som kommer <strong>f√∏r</strong> i alfabetet.</li>
                        
                        <li><strong>Bruk NATO-fonetisk filtrering:</strong><br>
                        Skriv hele den nye sekvensen i NATO-fonetisk form. Ta den <strong>tredje bokstaven</strong> i hvert fonetiske ord og skriv dem sammen.</li>
                        
                        <li><strong>Resultatet danner Transit Code Alpha (bokstavkode).</strong></li>
                    </ol>
                    <p>Skriv inn koden i portalen n√•r dere er enige.</p>
                    <p>‚Äî Command Out.</p>
                `,

                // --- FASE 2: FERGE (KODE 2) --- (N√• med GPS-sjekk)
                'lcvccn': `
                    <h4>TRANSIT CODE ALPHA ‚Äî VERIFIED</h4>
                    <p>Kryptert kommunikasjon gjenopprettet. Neste waypoint er aktivert.</p>
                    
                    <h5>Safehouse koordinater:</h5>
                    <p><a href="https://www.google.com/maps/search/?api=1&query=57%C2%B¬∞03'48.6%22N+9%C2%B¬∞54'47.6%22E" target="_blank" class="location-link"><strong>57¬∞03'48.6"N 9¬∞54'47.6"E</strong></a></p>
                    <p><strong>Lokasjon:</strong> N√∏rresundby</p>
                    <p>G√• direkte til disse koordinatene. Hold lav profil. N√•r lokasjonen er sikret, m√• du verifisere din posisjon for √• motta neste direktiv.</p>
                    
                    <!-- NY KNAPP FOR GPS-SJEKK -->
                    <button id="verify-location-btn" class="download-button" onclick="verifySafehouseLocation()">
                        VERIFISER POSISJON
                    </button>
                    
                    <!-- Omr√•de for GPS-tilbakemelding -->
                    <div id="location-feedback" style="margin-top: 15px; color: #ff9900; font-weight: bold;"></div>
                `,
                
                // --- FASE 3: SAFEHOUSE ---
                'safehouse check-in': `
                    <h4>CLASSIFIED DIRECTIVE ‚Äî FLIGHT OPS</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Godt jobbet, agenter. Lokasjon sikret.</p>
                    <p>Etter den vellykkede overf√∏ringen fra fergen er situasjonen endret. V√•re analyser viser at GNM-modulen har v√¶rt aktiv i nettverkssporene vi overv√•ker.</p>
                    <p>For √• sikre at minst ett lag kan rykke inn dersom situasjonen eskalerer, skal dere gjennomf√∏re akutt pilotoppl√¶ring i et kontrollert milj√∏.</p>
                    
                    <p><strong>Lokasjon:</strong> <a href="https://www.google.com/maps/search/?api=1&query=57%C2%B¬∞05'13.0%22N+9%C2%B¬∞52'18.1%22E" target="_blank" class="location-link"><strong>57¬∞05'13.0"N 9¬∞52'18.1"E</strong></a><br>
                        <strong>Tid:</strong> 10:00 i morgen</p>
                    
                    <p>Dere vil gjennomf√∏re et fullt <strong>pilottreningsprogram</strong> basert p√• F-16-plattformen. Forbered dere p√• h√∏yde, hastighet og presisjon.</p>
                    <p>Etter fullf√∏rt √∏kt vil vertskapet gi dere neste autorisasjonskode.</p>
                    <p>‚Äî Command Out.</p>
                `,

                // --- FASE 4: ETTER FLIGHT OPS --- (N√• med GPS-sjekk)
                'fuelcheck': `
                    <h4>CLASSIFIED MESSAGE ‚Äî POST FLIGHT OPS DIRECTIVE</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Flight-sekvens fullf√∏rt. Data bekrefter operativ beredskap hos alle enheter.</p>
                    <p>Nye instruksjoner er sendt fra kommandoniv√•.</p>
                    <p>Dere skal trekke tilbake til et sikkert sivilt kontaktpunkt for debrief og midlertidig avventing.</p>
                    
                    <h5>Lokasjon (Dekknavn):</h5>
                    <p><a href="https://www.google.com/maps/search/?api=1&query=Slotsgade+33,+9000+Aalborg,+Denmark" target="_blank" class="location-link"><strong>ISIDOR HENIUS</strong></a><br>
                    <span style="color: #888;">Slotsgade 33, 9000 Aalborg, Denmark</span></p>
                    
                    <p><strong>Oppdrag:</strong> M√∏t p√• stedet. N√•r dere er fremme, verifiser posisjon for √• motta neste ordre.</p>
                    
                    <!-- NY KNAPP FOR GPS-SJEKK -->
                    <button id="verify-isidor-btn" class="download-button" onclick="verifyIsidorHeniusLocation()">
                        VERIFISER POSISJON (ISIDOR HENIUS)
                    </button>
                    
                    <!-- Omr√•de for GPS-tilbakemelding -->
                    <div id="location-feedback" style="margin-top: 15px; color: #ff9900; font-weight: bold;"></div>
                `,

                // --- FASE 4: ETTER ISIDOR HENIUS ---
                'table 19': `
                    <h4>CLASSIFIED MESSAGE ‚Äî EVENING DIRECTIVE</h4>
                    <h5>Clearance Level: Echelon 5</h5>
                    <p>Dataoverf√∏ring fra Contact Point Bravo er mottatt. Operasjonen g√•r inn i fase 6.</p>
                    <p>Dere har gjort en solid innsats i felt, og kommando gir gr√∏nt lys for midlertid rekreasjon og sosial samling f√∏r videre operasjon.</p>
                    
                    <h5>Neste oppm√∏tested:</h5>
                    <p>Et sivilisert deknavn brukt til lavprofil-m√∏ter mellom feltagenter:</p>
                    <p><strong>Dekknavn:</strong> THE BLACK TABLE<br>
                    <strong>Lokasjon:</strong> <a href="https://www.google.com/maps/search/?api=1&query=Restaurant+Flammen+Aalborg" target="_blank" class="location-link">Restaurant Flammen</a><br>
                    <strong>Tid:</strong> 19:00</p>
                    <p>‚Äî Command Out.</p>
                `,
                
                // --- FASE 5: P√Ö RESTAURANT FLAMMEN ---
                'specter one': `
                    <h4>CLASSIFIED MESSAGE ‚Äî FIELD DIRECTIVE</h4>
                    <h5>Clearance Level: Echelon 5</h5>
                    <p>Bekreftelse mottatt fra Command.</p>
                    <p>Satellittdata fra Jutland Sector viser aktivitet ved et tidligere treningsanlegg nordvest for Aalborg. Omr√•det g√•r under dekknavnet:</p>
                    <p><strong>AMMO GROUND</strong></p>
                    <p>Dere skal forflytte dere fra n√•v√¶rende base og v√¶re fullt operative ved morgengry.</p>
                    
                    <p><strong>Oppm√∏tested:</strong> <a href="https://www.google.com/maps/search/?api=1&query=Magasinvej+7,+9870+Sindal,+Denmark" target="_blank" class="location-link">Magasinvej 7, 9870 Sindal, Denmark</a><br>
                    <strong>Tid:</strong> 09:00 i morgen</p>
                    
                    <h5>Instruks:</h5>
                    <ul>
                        <li>Pakk alle personlige eiendeler og klargj√∏r utstyr for ny forflytning.</li>
                        <li>Etter fullf√∏rt oppdrag vil dere <strong>ikke returnere</strong> til n√•v√¶rende base.</li>
                        <li>V√¶r forberedt p√• overnatting annet sted etter feltoperasjonen.</li>
                    </ul>
                    
                    <h5>Bekledning:</h5>
                    <ul>
                        <li>Varmt og lagvis t√∏y (ull, fleece, vindtett jakke)</li>
                        <li>Gode sko eller vanntette st√∏vler</li>
                        <li>Hansker og hodeplagg (lue/buff)</li>
                        <li>Ingen sterke farger ‚Äî hold lav profil</li>
                    </ul>
                    <p>‚Äî Command Out.</p>
                `,

                // --- FASE 6: ETTER AMMO GROUND --- (N√• med GPS-sjekk)
                'nordstar': `
                    <h4>CLASSIFIED MESSAGE ‚Äî EXTRACTION ORDER</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Bekreftelse mottatt fra feltstyrken.</p>
                    <p>Rapportene fra AMMO GROUND bekrefter at GNM-modulen er deaktivert. Interferensloggene viser at systemet fors√∏kte en reaktivering, men at signalet ble avbrutt.</p>
                    <p>Operasjonen vurderes som suksessfull.</p>
                    <p class="warning">Men deres posisjon er n√• kompromittert ‚Äî det antas at motparten vil fors√∏ke √• spore opp teamet.</p>
                    
                    <h5>Direktiv:</h5>
                    <p>G√• i dekning umiddelbart. Dere skal forflytte dere til trygg sone for midlertidig evakuering.</p>
                    <p><strong>Lokasjon:</strong> <a href="https://www.google.com/maps/search/?api=1&query=Skydebanevej+17,+9800+Hj√∏rring" target="_blank" class="location-link">Skydebanevej 17, 9800 Hj√∏rring</a><br>
                    <strong>Dekknavn:</strong> Base Echo</p>
                    <p>Hold lav profil under forflytning. Ved ankomst: sikre lokasjonen, l√•s alle d√∏rer, og verifiser posisjon for neste direktiv.</p>

                    <!-- NY KNAPP FOR GPS-SJEKK -->
                    <button id="verify-echo-btn" class="download-button" onclick="verifyBaseEchoLocation()">
                        VERIFISER POSISJON (BASE ECHO)
                    </button>
                    
                    <!-- Omr√•de for GPS-tilbakemelding -->
                    <div id="location-feedback" style="margin-top: 15px; color: #ff9900; font-weight: bold;"></div>
                `,

                // --- FASE 7: P√Ö BASE ECHO (HJ√òRRING) ---
                'echofall': `
                    <h4>CLASSIFIED MESSAGE ‚Äî DEBRIEF DIRECTIVE</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Bekreftelse mottatt fra Base Echo.</p>
                    <p>Operasjonen n√¶rmer seg konklusjon. Nye data fra kommandoniv√• viser at siste del av GNM-protokollen er fanget opp og isolert.</p>
                    <p>Alle enheter skal n√• innkalles til endelig debrief og evaluering.</p>
                    
                    <p><strong>Dekknavn:</strong> Operation Bones<br>
                    <strong>Tid:</strong> 20:00<br>
                    <strong>Lokasjon:</strong> <a href="https://www.google.com/maps/search/?api=1&query=Bones+Restaurant,+Hj√∏rring" target="_blank" class="location-link">Bones Restaurant, Hj√∏rring</a></p>
                    
                    <p><strong>Oppdrag:</strong> M√∏t presist. Hold lav profil. Dette er siste steg f√∏r operasjonen avsluttes.</p>
                    <p>‚Äî Command Out.</p>
                `,

                // --- FASE 8: AVSLUTNING (P√Ö BONES) ---
                'shadowfall': `
                    <h4>CLASSIFIED MESSAGE ‚Äî OPERATION TERMINATION ORDER</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Bekreftelse mottatt fra feltleder SHADOW. Alle enheter rapportert som sikre.</p>
                    <p><strong>Operasjon NORTHERN STRIKE er herved erkl√¶rt fullf√∏rt.</strong></p>
                    <p>GNM-protokollen er isolert, kryptert og fjernet fra aktivt nettverk. Dataene sikret ved AMMO GROUND og overf√∏rt via Base Echo har stanset reaktivering.</p>
                    <p>Kommandosenteret beordrer umiddelbar tilbaketrekning og oppl√∏sning av operative enheter.</p>
                    
                    <h5>Direktiv:</h5>
                    <ul>
                        <li>Alle enheter trekker ut av operasjonsomr√•det i morgen.</li>
                        <li>Avreise skjer via maritim transport.</li>
                        <li><strong>B√•tavgang:</strong> 12:15 (M√∏t ved terminal senest 11:45)</li>
                        <li><a href="https://storage.googleapis.com/files_webpage/Privat/Colourline%20bilett.pdf" target="_blank" class="location-link"><strong>Referanse: Ferjebilletter</strong></a></li>
                    </ul>
                    
                    <h5>Transportplan:</h5>
                    <ul>
                        <li><strong>Team Oslo:</strong> Forflytter seg videre med buss fra Kristiansand kl. 16:30.</li>
                        <li><strong>Team Stavanger:</strong> Returnerer kj√∏ret√∏yet til hjemmebase via landrute.</li>
                    </ul>
                    <p>Hold lav profil under transport. Unng√• identifiserbare symboler.</p>
                    <p>Denne operasjonen vil ikke bli offentlig anerkjent. Deres innsats har v√¶rt avgj√∏rende.</p>
                    <p><strong>Mission Complete.</strong></p>
                    <p>‚Äî SHADOW / Command Out.</p>
                `
            };

            // --- NY MASTER-PORTAL DATABASE ---
            // Egen liste for admin-visningen for √• styre rekkef√∏lge og innhold
            const masterViewData = [
                {
                    code: 'team oslo',
                    title: 'Fase 1 (Oslo)',
                    adminNote: 'Innledende briefing for Team Oslo. Inneholder reiseordre, f√∏rste observasjonspunkt og pakkliste.'
                },
                {
                    code: 'team stavanger',
                    title: 'Fase 1 (Stavanger)',
                    adminNote: 'Innledende briefing for Team Stavanger. Inneholder reiseordre, f√∏rste observasjonspunkt og pakkliste.'
                },
                {
                    code: 'aurora borealis',
                    title: 'Fase 2 (Sammensl√•ing)',
                    adminNote: 'Agentene m√• sl√• sammen kodeordene sine ("aurora" + "borealis") for √• f√• denne. Sender dem til fergen.'
                },
                {
                    code: 'jylland',
                    title: 'Fase 2 (Ferge, G√•te 1)',
                    adminNote: 'F√∏rste g√•te ombord p√• fergen. Agent SHADOW gir denne koden. Svaret er "lcvccn".'
                },
                {
                    code: 'lcvccn',
                    title: 'Fase 2 (Ferge, G√•te 2)',
                    adminNote: 'Svaret p√• "jylland". Sender dem til Safehouse og aktiverer GPS-sjekk for N√∏rresundby.'
                },
                {
                    code: 'safehouse check-in',
                    title: 'Fase 3 (Safehouse)',
                    adminNote: 'Denne l√•ses opp av GPS-sjekken ved safehouse ("lcvccn"). Sender agentene til Flight Ops.'
                },
                {
                    code: 'fuelcheck',
                    title: 'Fase 4 (Flight Ops)',
                    adminNote: 'Denne koden f√•r de etter Flight Ops. Sender dem til "ISIDOR HENIUS" og aktiverer GPS-sjekk der.'
                },
                {
                    code: 'table 19',
                    title: 'Fase 4 (Isidor Henius)',
                    adminNote: 'Denne l√•ses opp av GPS-sjekken ved Isidor Henius ("fuelcheck"). Sender dem til Restaurant Flammen.'
                },
                {
                    code: 'specter one',
                    title: 'Fase 5 (Restaurant)',
                    adminNote: 'Agent SHADOW gir denne koden p√• restauranten. Sender dem til AMMO GROUND.'
                },
                {
                    code: 'nordstar',
                    title: 'Fase 6 (Ammo Ground)',
                    adminNote: 'Denne koden f√•r de etter skytingen. Sender dem til "Base Echo" (Hj√∏rring) og aktiverer GPS-sjekk der.'
                },
                {
                    code: 'echofall',
                    title: 'Fase 7 (Base Echo)',
                    adminNote: 'Denne l√•ses opp av GPS-sjekken ved Base Echo ("nordstar"). Sender dem til Bones for debrief.'
                },
                {
                    code: 'shadowfall',
                    title: 'Fase 8 (Avslutning)',
                    adminNote: 'Agent SHADOW gir denne koden p√• Bones. Dette er det siste oppdraget og inneholder avslutning og reiseinfo hjem.'
                }
            ];
            // --- SLUTT P√Ö MASTER-PORTAL DATABASE ---

            // --- 5. DEFINER ALLE FUNKSJONER ---

            // --- Firebase-funksjoner ---

            /**
             * Lagrer fremdriften til Firebase
             */
            async function saveProgress(lastCode) {
                if (!isAuthReady || !userId) {
                    console.log("Kan ikke lagre fremdrift: Autentisering ikke klar.");
                    return;
                }
                const codename = localStorage.getItem('agentCodename');
                if (!codename) {
                    console.warn("Kan ikke lagre fremdrift: Kodenavn mangler.");
                    return;
                }

                // NY, ENKLERE DATABASEBANE
                const userDocRef = doc(db, "echelon-data", userId, "progress", "main");
                try {
                    if (lastCode !== '95764045') {
                        await setDoc(userDocRef, { lastCode: lastCode, codename: codename }, { merge: true });
                        localStorage.setItem('currentUserLastCode', lastCode);
                        console.log(`Fremdrift lagret for ${codename}:`, lastCode);
                    }
                } catch (e) {
                    console.error("Feil ved lagring av fremdrift:", e);
                }
            }

            /**
             * Laster fremdriften fra Firebase
             */
            async function loadProgress() {
                if (!isAuthReady || !userId) {
                    console.log("Kan ikke laste fremdrift: Autentisering ikke klar.");
                    setTimeout(loadProgress, 500); 
                    return;
                }

                // NY, ENKLERE DATABASEBANE
                const userDocRef = doc(db, "echelon-data", userId, "progress", "main");
                try {
                    const docSnap = await getDoc(userDocRef);
                    const initialMessageHTML = `<h4>CLASSIFIED ACCESS POINT</h4><p>Systemet krever celle-autentisering for tilgang.</p>`;

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const lastCode = data.lastCode;
                        localStorage.setItem('currentUserLastCode', lastCode); 
                        console.log("Fremdrift funnet:", lastCode);
                        
                        const messageHtml = briefings[lastCode];
                        if (messageHtml) {
                            messageDisplay.innerHTML = messageHtml;
                        } else {
                            messageDisplay.innerHTML = initialMessageHTML;
                        }
                    } else {
                        localStorage.removeItem('currentUserLastCode'); 
                        console.log("Ingen lagret fremdrift funnet.");
                        messageDisplay.innerHTML = initialMessageHTML;
                    }
                } catch (e) {
                    console.error("Feil ved lasting av fremdrift:", e);
                    messageDisplay.innerHTML = `<p class="warning">FEIL: Kunne ikke laste fremdrift. Sjekk konsoll.</p>`;
                }
            }
            // Gj√∏re loadProgress global slik at arkiv-knappen kan kalle den
            window.loadProgress = loadProgress;

            /**
             * Viser hovedportalen (input-feltet)
             */
            function showMainPortal() {
                inputForm.style.display = 'flex';
                loadProgress();
            }

            /**
             * Viser Kodenavn-innloggingen
             */
            function showLoginPortal() {
                inputForm.style.display = 'none';
                messageDisplay.innerHTML = `
                    <h4>AGENT-AUTENTISERING</h4>
                    <p>Bekreft din identitet for √• koble til ECHELON 5-nettverket. Kun gyldige kodenavn er autorisert.</p>
                    
                    <div id="login-form-container">
                        <input type="text" id="codename-input" placeholder="Skriv ditt kodenavn..." autocomplete="off">
                        <button id="codename-submit-btn" onclick="handleCodenameLogin()">AUTENTISER</button>
                        <div id="login-feedback"></div>
                    </div>
                `;
            }

            /**
             * H√•ndterer Kodenavn-innlogging (gj√∏res global)
             */
            window.handleCodenameLogin = function() {
                const input = document.getElementById('codename-input');
                const feedback = document.getElementById('login-feedback');
                const codename = input.value.toLowerCase().trim();

                if (validCodenames.includes(codename)) {
                    localStorage.setItem('agentCodename', codename);
                    console.log("Kodenavn lagret:", codename);
                    
                    messageDisplay.innerHTML = `
                        <div class="loader">
                            KODENAVN <strong>${codename.toUpperCase()}</strong> VERIFISERT...<br>
                            ETABLERER SIKKER KOBLING...<br>
                            LASTER PORTAL...
                        </div>`;
                    setTimeout(showMainPortal, 1500);
                } else {
                    feedback.innerHTML = `<p class="warning">ADGANG NEKTET. KODENAVN IKKE GJENKJENT.</p>`;
                    input.style.animation = 'shake 0.3s';
                    setTimeout(() => { input.style.animation = ''; }, 300);
                }
            }

            /**
             * Sjekker om brukeren allerede er logget inn lokalt
             */
            function checkLocalLogin() {
                const codename = localStorage.getItem('agentCodename');
                if (codename && validCodenames.includes(codename)) {
                    console.log("Kodenavn funnet i lokal lagring:", codename);
                    messageDisplay.innerHTML = `
                        <div class="loader">
                            GJENKJENNER AGENT <strong>${codename.toUpperCase()}</strong>...<br>
                            LASTER FREMDRIFT...
                        </div>`;
                    setTimeout(showMainPortal, 1000);
                } else {
                    console.log("Ingen gyldig kodenavn funnet lokalt. Viser innlogging.");
                    showLoginPortal();
                }
            }

            /**
             * Initialiserer Firebase
             */
            async function initFirebase() {
                // Sjekker om API-n√∏kkelen faktisk er til stede
                if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR...KEY")) {
                    console.error("Firebase config mangler eller er ikke fylt ut!");
                    messageDisplay.innerHTML = '<p class="warning">SYSTEMFEIL: Kunne ikke koble til Command Server. API-n√∏kkel mangler.</p>';
                    return;
                }

                try {
                    setLogLevel('Debug');
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    console.log("Firebase initialisert.");

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            // Bruker er allerede logget inn (anonymt)
                            userId = user.uid;
                            console.log("Bruker er logget inn:", userId);
                            isAuthReady = true;
                            checkLocalLogin(); // Sjekk for kodenavn
                        } else {
                            // Ingen bruker, logg inn anonymt
                            try {
                                console.log("Logger inn Anonymt...");
                                const userCredential = await signInAnonymously(auth);
                                // 'onAuthStateChanged' vil n√• kj√∏re p√• nytt med den nye brukeren
                                console.log("Anonym innlogging vellykket.");
                            } catch (e) {
                                console.error("Anonym innloggingsfeil:", e);
                                // --- START: FORBEDRET FEILH√ÖNDTERING ---
                                if (e.code === 'auth/configuration-not-found') {
                                    messageDisplay.innerHTML = `
                                        <h4 class="warning">SYSTEMFEIL (auth/configuration-not-found)</h4>
                                        <p>Portalen er koblet til Firebase-prosjektet ditt, men <strong>Anonym P√•logging</strong> er ikke aktivert.</p>
                                        <p><strong>L√∏sning:</strong></p>
                                        <ol>
                                            <li>G√• til ditt "ECHELON 6" Firebase-prosjekt.</li>
                                            <li>Klikk p√• <strong>Authentication</strong> i menyen.</li>
                                            <li>Klikk "Kom i gang" (Get started).</li>
                                            <li>Velg <strong>"Anonym" (Anonymous)</strong>.</li>
                                            <li>Trykk "Aktiver" (Enable) og "Lagre".</li>
                                        </ol>
                                        <p>Last inn denne siden p√• nytt etter at du har gjort det.</p>
                                    `;
                                } else {
                                    // Annen, uventet feil
                                    messageDisplay.innerHTML = `<p class="warning">AUTENTISERING FEIBLET: ${e.message}</p>`;
                                }
                                // --- SLUTT: FORBEDRET FEILH√ÖNDTERING ---
                            }
                        }
                    });

                } catch (e) {
                    console.error("Feil ved initialisering av Firebase:", e);
                    messageDisplay.innerHTML = '<p class="warning">SYSTEMFEIL: Kunne ikke koble til Command Server. Sjekk konsoll.</p>';
                }
            }

            // --- App-funksjoner (logikk) ---

            /**
             * Kj√∏res n√•r brukeren trykker "DEKRYPTER"
             */
            function submitCode() {
                let code = codeInput.value.toLowerCase().trim();
                
                if (code === "safehouse check-in" || code === "safehouse checkin") {
                    code = 'safehouse check-in';
                }
                
                feedbackDisplay.innerHTML = '';

                if (code === '95764045') {
                    console.log("Master Portal tilgang forespurt.");
                    showMasterPortal();
                    codeInput.value = '';
                    return; 
                }

                const messageHtml = briefings[code];

                if (messageHtml) {
                    messageDisplay.innerHTML = `
                        <div class="loader">
                            DEKRYPTERER SIGNAL...<br>
                            VERIFISERER AUTORISASJON...<br>
                            ETABLERER SIKKER KOBLING...
                        </div>`;
                    
                    setTimeout(() => {
                        messageDisplay.innerHTML = messageHtml;
                        window.scrollTo(0, 0); 
                        codeInput.value = ''; 
                        saveProgress(code);
                    }, 1500);

                } else {
                    feedbackDisplay.innerHTML = '<p class="warning">ADGANG NEKTET. KODE IKKE GJENKJENT.</p>';
                    inputForm.style.animation = 'shake 0.3s';
                    setTimeout(() => { inputForm.style.animation = ''; }, 300);
                }
            }
            
            /**
             * Genererer og laster ned pakklisten som en .txt-fil
             */
            window.downloadPakkliste = function() {
                const pakklisteText = `PERSONLIG UTSTYR ‚Äî STANDARD LOADOUT
    CLASSIFIED DOCUMENT ‚Äî EQUIPMENT MANIFEST

    Clearance Level: ECHELON 3
    Distribution: Authorized Field Units Only

    ---------------------------------
    ‚öôÔ∏è FELTUTSTYR
    For oppdrag under skiftende v√¶r og lang forflytning:
    ---------------------------------
    ‚Ä¢ Ekstra ullsokker (ett par i vanett pose)
    ‚Ä¢ Tynt sitteunderlag eller sammenrullbar pute (pause i felt)
    ‚Ä¢ √òrepropper (for s√∏vn eller st√∏y)
    ‚Ä¢ Powerbank
    ‚Ä¢ Ullundert√∏y
    ‚Ä¢ Fjellsko
    ‚Ä¢ Turbukse (helst uten flashy farger)
    ‚Ä¢ Jakke (helst uten flashy farger)
    ‚Ä¢ Tynne hansker
    ‚Ä¢ Lue

    ---------------------------------
    üß≥ SIVILT / LOGISTIKK
    For komfort og beredskap mellom operasjonene:
    ---------------------------------
    ‚Ä¢ Ekstra undert√∏y og sokker
    ‚Ä¢ Komfortabel bukse for innend√∏rs bruk
    ‚Ä¢ T-skjorte
    ‚Ä¢ Genser
    ‚Ä¢ Reisedokumenter, ID og kopi p√• mobilen
    ‚Ä¢ Liten notatbok og penn (for oppdragsnotater)

    ---------------------------------
    üëî FORMELLT OPPDAGSANTREKK ‚Äî ‚ÄúCAUSAL BUSINESS‚Äù
    ---------------------------------
    ‚Ä¢ Finbukser
    ‚Ä¢ Skjorte
    ‚Ä¢ Jakke

    ---------------------------------
    üß¥ DIVERSE / PERSONLIG
    ---------------------------------
    ‚Ä¢ Mobillader
    ‚Ä¢ Solbriller (lav sol i Danmark p√• vinteren)
    ‚Ä¢ Lommebok
    ‚Ä¢ Toalettsaker

    ---------------------------------
    Instruks:
    Pakk lett i ryggsekk. Du m√• regne med √• b√¶re tingene dine under forflytning.
    Unng√• sterke farger og synlige logoer.
    Hold lav profil.
    ‚Äî Command Logistics Division / Operation Northern Strike
    `;
                
                const blob = new Blob([pakklisteText], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'pakkliste.txt';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            }

            // --- GPS VERIFISERINGSFUNKSJONER ---

            const SAFEHOUSE_LAT = 57.0635;
            const SAFEHOUSE_LON = 9.913222;
            const ISIDOR_LAT = 57.05061;
            const ISIDOR_LON = 9.91976;
            const ECHO_LAT = 57.45788;
            const ECHO_LON = 9.95764;
            const MAX_DISTANCE_METERS = 150; 

            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; 
                const œÜ1 = lat1 * Math.PI / 180; 
                const œÜ2 = lat2 * Math.PI / 180;
                const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
                const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                            Math.cos(œÜ1) * Math.cos(œÜ2) *
                            Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c; 
            }

            function handleLocationVerification(targetLat, targetLon, btnId, feedbackId, successCallback) {
                const feedback = document.getElementById(feedbackId);
                const btn = document.getElementById(btnId);
                
                if (!feedback || !btn) {
                    console.error("GPS-sjekk feilet: Finner ikke knapp eller feedback-element.");
                    return;
                }
                
                if (!navigator.geolocation) {
                    feedback.innerHTML = '<p class="warning">FEIL: GEOLOKASJON ST√òTTES IKKE AV DENNE ENHETEN.</p>';
                    return;
                }

                feedback.innerHTML = 'S√∏ker etter GPS-signal... Godkjenn foresp√∏rsel i nettleser...';
                btn.disabled = true;
                btn.innerHTML = 'LOKALISERER...';

                const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };

                navigator.geolocation.getCurrentPosition(
                    (pos) => locationSuccess(pos, targetLat, targetLon, btn, feedback, successCallback),
                    (err) => locationError(err, btn, feedback),
                    options
                );
            }

            function locationSuccess(pos, targetLat, targetLon, btn, feedback, successCallback) {
                const userLat = pos.coords.latitude;
                const userLon = pos.coords.longitude;
                const distance = calculateDistance(targetLat, targetLon, userLat, userLon);

                if (distance <= MAX_DISTANCE_METERS) {
                    feedback.innerHTML = `POSISJON VERIFISERT (Avstand: ${Math.round(distance)}m). Laster neste direktiv...`;
                    successCallback();
                } else {
                    feedback.innerHTML = `<p class="warning">VERIFISERING NEKTET. POSISJON LOKALISERT, MEN DU ER IKKE VED M√ÖLET. (Avstand: ${Math.round(distance)}m). PR√òV IGJEN N√ÖR DU ER N√ÜRMERE.</p>`;
                    btn.disabled = false;
                    btn.innerHTML = 'VERIFISER POSISJON P√Ö NYTT';
                }
            }

            function locationError(err, btn, feedback) {
                let errorMsg = '';
                switch(err.code) {
                    case err.PERMISSION_DENIED: errorMsg = "ADGANG NEKTET. Systemet krever GPS-tilgang for √• verifisere posisjon."; break;
                    case err.POSITION_UNAVAILABLE: errorMsg = "SIGNAL TAPT. Posisjonsdata er ikke tilgjengelig. Pr√∏v √• g√• utend√∏rs."; break;
                    case err.TIMEOUT: errorMsg = "TIDSAVBRUDD. Kunne ikke hente posisjon. Sjekk GPS-signal og pr√∏v igjen."; break;
                    default: errorMsg = "UKJENT GPS-FEIL. Kunne ikke verifisere posisjon."; break;
                }
                feedback.innerHTML = `<p class="warning">${errorMsg}</p>`;
                btn.disabled = false;
                btn.innerHTML = 'VERIFISER POSISJON';
            }

            function showUnlockedMessage(nextCode) {
                const messageHtml = briefings[nextCode];
                
                messageDisplay.innerHTML = `
                    <div class="loader">
                        POSISJON GODKJENT...<br>
                        DEKRYPTERER NESTE FASE...
                    </div>`;
                
                setTimeout(() => {
                    messageDisplay.innerHTML = messageHtml;
                    window.scrollTo(0, 0);
                }, 1500);
            }

            window.verifySafehouseLocation = function() {
                handleLocationVerification(SAFEHOUSE_LAT, SAFEHOUSE_LON, 'verify-location-btn', 'location-feedback', () => {
                    const nextCode = 'safehouse check-in';
                    saveProgress(nextCode); 
                    showUnlockedMessage(nextCode);
                });
            }

            window.verifyIsidorHeniusLocation = function() {
                handleLocationVerification(ISIDOR_LAT, ISIDOR_LON, 'verify-isidor-btn', 'location-feedback', () => {
                    const nextCode = 'table 19';
                    saveProgress(nextCode); 
                    showUnlockedMessage(nextCode);
                });
            }

            window.verifyBaseEchoLocation = function() {
                handleLocationVerification(ECHO_LAT, ECHO_LON, 'verify-echo-btn', 'location-feedback', () => {
                    const nextCode = 'echofall';
                    saveProgress(nextCode);
                    showUnlockedMessage(nextCode);
                });
            }

            // --- SLUTT P√Ö GPS-FUNKSJONER ---

            // --- MASTER PORTAL-FUNKSJONER ---

            function showMasterPortal() {
                let html = `
                    <h4>MASTER PORTAL</h4>
                    <p>Oversikt over alle oppdrag i kronologisk rekkef√∏lge.</p>
                    <div class="master-list">
                `;

                masterViewData.forEach((item, index) => {
                    html += `
                        <a href="#" class="master-link" onclick="showMasterDetailView('${item.code}'); return false;">
                            <strong>${index + 1}. ${item.title}</strong>
                            <span>(Kode: ${item.code})</span>
                        </a>
                    `;
                });

                html += `</div>
                    <h5 style="margin-top: 30px;">System-tilbakestilling</h5>
                    <p>For √• nullstille spillet for alle agenter (f.eks. for en ny runde), m√• du:</p>
                    <ol>
                        <li><strong>Steg 1 (Database):</strong> Logg inn p√• Firebase-konsollen for denne appen og slett 'echelon-data'-samlingen (collection) manuelt.</li>
                        <li><strong>Steg 2 (Lokalt):</strong> Slett dataen i din egen nettleser ved √• trykke p√• knappen under.</li>
                    </ol>
                    <button class="download-button" style="background-color: #990000;" onclick="resetLocalData()">
                        Nullstill Min √òkt (Steg 2)
                    </button>
                `;
                
                messageDisplay.innerHTML = html;
                window.scrollTo(0, 0);
            }
            window.showMasterPortal = showMasterPortal; // Global for tilbake-knapp

            window.showMasterDetailView = function(code) {
                const adminData = masterViewData.find(item => item.code === code);
                const participantMessage = briefings[code];

                if (!adminData || !participantMessage) {
                    messageDisplay.innerHTML = `<p class="warning">FEIL: Kunne ikke finne data for koden: ${code}</p>`;
                    return;
                }

                let html = `
                    <button class="download-button" style="margin-bottom: 25px; background-color: #444;" onclick="showMasterPortal()">
                        &larr; Tilbake til Master-oversikt
                    </button>
                    
                    <h4>MASTER VIEW: ${adminData.title}</h4>
                    
                    <h5>Admin-instruksjoner:</h5>
                    <p><strong>Kode:</strong> ${adminData.code}</p>
                    <p><em>${adminData.adminNote}</em></p>
                    
                    <h5 style="margin-top: 30px;">Melding til deltaker:</h5>
                    <div style="border: 1px dashed #666; padding: 15px; background: #0c0c0c;">
                        ${participantMessage}
                    </div>
                `;

                messageDisplay.innerHTML = html;
                window.scrollTo(0, 0); 
            }

            /**
             * Nullstiller lokal data
             */
            window.resetLocalData = function() {
                localStorage.removeItem('agentCodename');
                localStorage.removeItem('currentUserLastCode');
                
                messageDisplay.innerHTML = `
                    <div class="loader">
                        LOKAL DATA SLETTET.<br>
                        LASTER INNLOGGINGSSKJERM...
                    </div>`;
                
                setTimeout(() => {
                    // Vi kan ikke kalle showLoginPortal() direkte, da den er avhengig av
                    // Firebase-flyten. En full omlasting er den sikreste m√•ten.
                    window.location.reload();
                }, 2000);
            }

            // --- SLUTT P√Ö MASTER PORTAL-FUNKSJONER ---

            // --- FUNKSJONER FOR OPPDRAGSARKIV ---

            function showCompletedMissionsMenu() {
                const lastCode = localStorage.getItem('currentUserLastCode');
                
                if (!lastCode) {
                    messageDisplay.innerHTML = `
                        <h4>OPPDRAGSARKIV</h4>
                        <p>Du har ikke fullf√∏rt noen oppdrag enn√•.</p>
                        <button class="download-button" style="margin-bottom: 25px; background-color: #444;" onclick="window.loadProgress()">
                            &larr; Tilbake til Siste Oppdrag
                        </button>
                    `;
                    window.scrollTo(0, 0);
                    return;
                }

                const lastCodeIndex = masterViewData.findIndex(item => item.code === lastCode);

                if (lastCodeIndex === -1) {
                    console.error("Feil: Kunne ikke finne lastCode i masterViewData", lastCode);
                    messageDisplay.innerHTML = `<p class="warning">ARKIVFEIL: Kunne ikke laste data.</p>`;
                    return;
                }

                const completedMissions = masterViewData.slice(0, lastCodeIndex + 1);

                let html = `
                    <h4>OPPDRAGSARKIV</h4>
                    <p>Velg et fullf√∏rt oppdrag for √• lese loggen.</p>
                    
                    <button class="download-button" style="margin-bottom: 25px; background-color: #444;" onclick="window.loadProgress()">
                        &larr; Tilbake til Siste Oppdrag
                    </button>
                    
                    <div class="master-list">
                `;

                completedMissions.reverse().forEach((item, index) => { 
                    html += `
                        <a href="#" class="master-link" onclick="showArchiveDetailView('${item.code}'); return false;">
                            <strong>${item.title}</strong>
                            <span>(Kode: ${item.code})</span>
                        </a>
                    `;
                });

                html += `</div>`;
                
                messageDisplay.innerHTML = html;
                window.scrollTo(0, 0); 
            }
            window.showCompletedMissionsMenu = showCompletedMissionsMenu; // Gj√∏re global

            window.showArchiveDetailView = function(code) {
                const participantMessage = briefings[code];

                if (!participantMessage) {
                    messageDisplay.innerHTML = `<p class="warning">FEIL: Kunne ikke finne data for koden: ${code}</p>`;
                    return;
                }

                let html = `
                    <button class="download-button" style="margin-bottom: 25px; background-color: #444;" onclick="showCompletedMissionsMenu()">
                        &larr; Tilbake til Arkiv
                    </button>
                    
                    <h4>OPPDRAGSLOGG (ARKIV)</h4>
                    
                    <div style="border: 1px dashed #666; padding: 15px; background: #0c0c0c; opacity: 0.8;">
                        ${participantMessage}
                    </div>
                `;

                messageDisplay.innerHTML = html;
                window.scrollTo(0, 0); 
            }
            // --- SLUTT P√Ö OPPDRAGSARKIV-FUNKSJONER ---

            // --- 6. KOBLE TIL EVENT LISTENERS OG START APPEN ---

            // Koble til knapper som ikke er inni 'messageDisplay'
            inputForm.onsubmit = (e) => { 
                e.preventDefault(); // Stopp skjemaet fra √• lastes p√• nytt
                submitCode(); 
                return false; 
            };
            menuBtn.onclick = showCompletedMissionsMenu;

            // Start Firebase-initialiseringen
            // Dette vil sette i gang hele flyten
            initFirebase();

        }); // --- SLUTTEN P√Ö DOMCONTENTLOADED ---
    </script>
    
    <!-- CSS for Riste-animasjon (valgfritt) -->
    <style>
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { translateX(5px); }
            75% { translateX(-5px); }
            100% { translateX(0); }
        }
    </style>

</body>
</html>
