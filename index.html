<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>KOMMANDOPORTAL // ECHELON 5</title>
    <!-- Sørger for at den ser bra ut på mobil -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Importerer Tone.js for lydeffekter -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <style>
        /* --- GRUNNLEGGENDE STIL --- */
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Consolas', 'Courier New', monospace; /* Agent/Terminal-font */
            background-color: #0a0a0a; /* Svart bakunn */
            color: #d4d4d4; /* Lys grå tekst */
            font-size: 15px; /* Tilbake til 15px */
            line-height: 1.6;
            /* Forhindrer iOS i å endre skriftstørrelse */
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        /* --- HOVEDLAYOUT --- */
        #portal {
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Fyller hele skjermen */
            max-width: 700px; /* God lesebredde */
            margin: 0 auto;
            border-left: 1px solid #333;
            border-right: 1px solid #333;
        }

        /* --- HEADER --- */
        #header {
            background-color: #1a1a1a;
            border-bottom: 2px solid #ff9900; /* Aksentfarge (oransje/amber) */
            padding: 12px 20px;
            text-align: center;
        }

        #header h1 {
            margin: 0;
            color: #ff9900;
            font-size: 1.1rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* --- MELDINGSVISNING --- */
        #message-display {
            padding: 20px;
            flex-grow: 1; /* Tar opp all ledig plass */
            background-color: #111;
            cursor: pointer; /* Viser at man kan klikke for å hoppe over skriving */
        }

        /* Meldingstitler (f.eks. CLASSIFIED MESSAGE) */
        #message-display h4 {
            color: #ff9900;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
            margin-top: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.1rem;
        }

        /* Undertitler (f.eks. Reiseordre) */
        #message-display h5 {
            color: #b5b5b5;
            text-transform: uppercase;
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        #message-display p {
            margin-bottom: 15px;
        }

        /* Punktlister */
        #message-display ol {
             margin-left: 20px;
            padding-left: 10px;
        }
        #message-display ul {
            list-style-type: '• ';
            margin-left: 20px;
            padding-left: 10px;
        }

        #message-display li {
            margin-bottom: 8px;
        }

        /* Uthevet tekst (f.eks. koordinater) */
        #message-display strong {
            color: #ffc266; /* Lysere oransje */
            font-weight: normal; /* Fonten er allerede "bold" */
        }
        
        /* Spesiell klasse for advarsler */
        .warning {
            color: #ff5555 !important; /* Rød for feilmeldinger */
        }
        
        /* Lenker til kart */
        .location-link {
            color: #ffc266;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 3px;
        }
        .location-link:hover {
            color: #ffd9a6;
        }
        
        /* Nedlastingsknapp / GPS-knapp */
        .download-button {
            display: block;
            background-color: #ff9900;
            color: #111;
            text-decoration: none;
            text-align: center;
            padding: 15px 20px;
            margin-top: 25px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 4px;
            cursor: pointer;
            border: none; /* Sørger for at button-elementer ser like ut */
            font-family: 'Consolas', 'Courier New', monospace; /* Arver font */
            font-size: 0.9rem; /* Justert størrelse */
            width: 100%; /* Sørger for at den fyller bredden */
        }
        .download-button:hover {
            background-color: #ffc266;
        }
        .download-button:disabled {
            background-color: #555;
            color: #999;
            cursor: not-allowed;
        }


        /* Laste-animasjon */
        .loader {
            text-align: center;
            padding: 40px 20px;
            color: #ff9900;
            font-size: 1.1rem;
            animation: flicker 1.5s infinite alternate;
        }

        @keyframes flicker {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* --- INNTASTINGSOMRÅDE --- */
        #input-form {
            background-color: #1a1a1a;
            border-top: 2px solid #ff9900;
            padding: 15px;
            display: none; /* Skjult som standard */
            position: sticky;
            bottom: 0;
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap; 
        }

        #code-input {
            flex-grow: 1; 
            background: #222;
            border: 1px solid #444;
            color: #d4d4d4;
            padding: 14px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 1rem;
            border-radius: 4px 0 0 4px;
            min-width: 150px; 
            flex-basis: 300px; 
        }
        #code-input:focus {
            outline: none;
            border-color: #ff9900;
            background-color: #333;
        }

        #submit-btn {
            background-color: #ff9900;
            border: none;
            color: #111;
            padding: 14px 18px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
            font-size: 1rem;
            flex-grow: 1; 
            flex-basis: 50px; 
        }

        /* STYLING FOR ARKIV-KNAPP */
        #menu-btn {
            background-color: #444;
            border: none;
            color: #d4d4d4;
            padding: 14px 18px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            font-size: 1rem;
            border-radius: 0; 
            border-left: 1px solid #0a0a0a;
            border-right: 1px solid #0a0a0a;
            transition: background-color 0.2s;
            flex-grow: 1; 
            flex-basis: 50px; 
        }
        #menu-btn:hover {
            background-color: #666;
        }

        /* --- STYLING FOR KODENAVN-INNLOGGING --- */
        #login-form-container {
            margin-top: 20px;
        }
        #codename-input {
            display: block;
            width: 100%;
            background: #222;
            border: 1px solid #444;
            color: #d4d4d4;
            padding: 14px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 1rem;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        #codename-input:focus {
            outline: none;
            border-color: #ff9900;
            background-color: #333;
        }
        #codename-submit-btn {
            display: block;
            width: 100%;
            background-color: #ff9900;
            border: none;
            color: #111;
            padding: 14px 18px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 4px;
            font-size: 1rem;
        }
        #login-feedback {
            padding: 10px 0;
            text-align: center;
        }


        /* --- STYLING FOR MASTER PORTAL --- */
        .master-list {
            border-top: 1px solid #444;
            margin-top: 20px;
        }
        .master-link {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 1px solid #333;
            text-decoration: none;
            color: #d4d4d4;
            transition: background-color 0.2s;
        }
        .master-link:hover {
            background-color: #1f1f1f;
            color: #ffc266;
        }
        .master-link strong {
            font-size: 1.1rem;
            color: #ffc266;
        }
        .master-link span {
            font-size: 0.9rem;
            color: #888;
        }


        /* Område for feilmeldinger */
        #feedback {
            padding: 0 15px;
            text-align: center;
        }

        /* --- ADAPTIV MEDIA QUERY --- */
        /* For skjermer smalere enn 420px */
        @media (max-width: 420px) {
            #input-form {
                padding: 10px;
            }

            #code-input {
                flex-basis: 100%; /* Input tar full bredde */
                border-radius: 4px; /* Fulle avrundede hjørner */
                margin-bottom: 10px; /* Mellomrom */
            }
            
            #menu-btn {
                flex-basis: 48%; /* Arkiv-knapp tar halve bredden */
                flex-grow: 1;
                border-radius: 4px 0 0 4px; /* Avrundede hjørner til venstre */
                border-right: 1px solid #0a0a0a; /* Skille */
            }

            #submit-btn {
                flex-basis: 48%; /* Dekrypter-knapp tar halve bredden */
                flex-grow: 1;
                border-radius: 0 4px 4px 0; /* Avrundede hjørner til høyre */
            }
        }
        /* --- SLUTT PÅ ADAPTIV CSS --- */


        /* --- NY CSS FOR INNBOKS-MODAL --- */
        #inbox-overlay {
            display: none; /* Skjult som standard */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        #inbox-modal {
            display: none; /* Skjult som standard */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            background: #1a1a1a;
            border: 2px solid #ff5555; /* Rød alarm-kant */
            border-radius: 4px;
            z-index: 1001;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.4);
        }
        
        #inbox-modal h4 {
            background: #ff5555;
            color: #111;
            padding: 15px;
            margin: 0;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #inbox-modal p {
            padding: 25px;
            font-size: 1.1rem;
            line-height: 1.7;
            color: #fff;
            white-space: pre-wrap; /* Beholder linjeskift fra admin */
        }

        #inbox-modal button {
            display: block;
            width: calc(100% - 50px);
            margin: 0 25px 25px 25px;
        }
        /* --- SLUTT PÅ INNBOKS-MODAL CSS --- */
    </style>
</head>
<body>

    <div id="portal">
        
        <!-- 1. HEADER -->
        <header id="header">
            <h1>ECHELON 5 // KOMMANDOPORTAL</h1>
        </header>

        <!-- 2. MELDINGSBOKS (Her vises alt innhold) -->
        <main id="message-display" onclick="skipTyping()">
            <!-- Innholdet settes nå dynamisk av JavaScript -->
            <!-- Viser en "laster"-melding mens Firebase initialiserer -->
            <div class="loader">
                ETABLERER TILKOBLING TIL ECHELON 5...<br>
                VENTER PÅ SIKKERT SIGNAL...
            </div>
        </main>

        <!-- 3. TILBAKEMELDING (For "Adgang Nektet") -->
        <div id="feedback"></div>

        <!-- 4. INNTASTINGSFELT (Klistret til bunnen) -->
        <form id="input-form">
            <input type="text" id="code-input" placeholder="Skriv autorisasjonskode..." autocomplete="off">
            <!-- ARKIV-KNAPP -->
            <button type="button" id="menu-btn">Arkiv</button>
            <button type="submit" id="submit-btn">DEKRYPTER</button>
        </form>

    </div>

    <!-- 5. NY MODAL FOR LIVE ADMIN-MELDINGER -->
    <div id="inbox-overlay"></div>
    <div id="inbox-modal">
        <h4><span id="inbox-icon"></span> INNKOMMENDE MELDING</h4>
        <p id="inbox-message-content">...</p>
        <button id="inbox-close-btn" class="download-button">MOTTATT</button>
    </div>


    <!-- 
      ======================================================
      --- ALL APPLIKASJONSLOGIKK SAMLET HER ---
      ======================================================
    -->
    <script type="module">
        // --- 1. IMPORTER FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // NY IMPORT: onSnapshot for live-meldinger
        import { getFirestore, setDoc, getDoc, doc, setLogLevel, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 2. VENT TIL HELE SIDEN ER LASTET ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 3. DEFINER GLOBALE VARIABLER OG DATABASER ---

            // --- MANUELL FIREBASE KONFIGURASJON ---
            // Nøklene du limte inn.
            const firebaseConfig = {
                apiKey: "AIzaSyCDcowm--WHC7saXt-YWtg2a2pXC93KSLI",
                authDomain: "echelon-6.firebaseapp.com",
                projectId: "echelon-6",
                storageBucket: "echelon-6.firebasestorage.app",
                messagingSenderId: "1037789395235",
                appId: "1:1037789395235:web:b1b25339342d7e4514f496",
                measurementId: "G-0RQLGZEV5V"
            };

            // Globale Firebase-variabler
            let db, auth, userId, isAuthReady = false;
            let inboxListenerUnsubscribe = null; // For å stoppe lytteren

            // Liste over gyldige kodenavn
            const validCodenames = ['raven', 'falcon', 'viper', 'cobra', 'shadow'];

            // Hent kjerne-HTML-elementer
            const messageDisplay = document.getElementById('message-display');
            const codeInput = document.getElementById('code-input');
            const feedbackDisplay = document.getElementById('feedback');
            const inputForm = document.getElementById('input-form');
            const menuBtn = document.getElementById('menu-btn');
            const submitBtn = document.getElementById('submit-btn');

            // Hent modal-elementer
            const inboxOverlay = document.getElementById('inbox-overlay');
            const inboxModal = document.getElementById('inbox-modal');
            const inboxMessageContent = document.getElementById('inbox-message-content');
            const inboxCloseBtn = document.getElementById('inbox-close-btn');

            // Globale variabler for app-tilstand
            let currentCodename = null;
            let currentUserLastCode = null;
            let currentView = 'loading'; // 'loading', 'login', 'mission', 'archive', 'master', 'master-detail'
            const appId = 'echelon-data'; // Erstatter __app_id med en hardkodet verdi

            // Globale variabler for skrivemaskin-effekt
            let isTyping = false;
            let currentTypingTimer = null;
            let currentTextNodes = [];
            let currentTextStrings = [];
            let charIndex = 0;
            let nodeIndex = 0;
            const TYPE_SPEED = 15; // ms per bokstav

            // --- 4. LYD-MODUL ---
            let synth, errorSynth, typeSynth, notificationSynth;
            let soundsReady = false;

            function initSound() {
                // Starter lyden kun etter brukerinteraksjon (første klikk)
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
                
                // Definerer de ulike lydene
                synth = new Tone.Synth({
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 }
                }).toDestination();
                synth.volume.value = -18; // Redusert volum

                errorSynth = new Tone.Synth({
                    oscillator: { type: 'sawtooth' },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 }
                }).toDestination();
                errorSynth.volume.value = -15; // Redusert volum

                typeSynth = new Tone.NoiseSynth({
                    noise: { type: 'pink' }, // Bytter til 'pink' for en dypere, mykere lyd
                    envelope: { attack: 0.001, decay: 0.01, sustain: 0 }
                }).toDestination();
                typeSynth.volume.value = -40; // VELDIG redusert volum (fra -30)
                
                notificationSynth = new Tone.Synth({
                    oscillator: { type: 'triangle' },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 }
                }).toDestination();
                notificationSynth.volume.value = -16; // Redusert volum

                soundsReady = true;
            }

            // Globalt "første klikk"-flagg for å starte lyden
            let isFirstClick = true;
            document.body.addEventListener('click', () => {
                if (isFirstClick) {
                    initSound();
                    isFirstClick = false;
                }
            }, { once: true });


            function playClick() {
                if (!soundsReady) return;
                try {
                    synth.triggerAttackRelease("C4", "8n"); // Dypere tone
                } catch (e) { console.warn("Tone.js feil (klikk):", e.message); }
            }

            function playSuccess() {
                if (!soundsReady) return;
                try {
                    const now = Tone.now();
                    synth.triggerAttackRelease("G4", "8n", now); // Dypere tone
                    synth.triggerAttackRelease("C5", "8n", now + 0.1); // Dypere tone
                } catch (e) { console.warn("Tone.js feil (suksess):", e.message); }
            }

            function playError() {
                if (!soundsReady) return;
                try {
                    errorSynth.triggerAttackRelease("C3", "4n");
                } catch (e) { console.warn("Tone.js feil (feil):", e.message); }
            }
            
            function playType() {
                if (!soundsReady) return;
                try {
                    typeSynth.triggerAttackRelease("64n"); 
                } catch (e) { /* Ignorer skrive-feil, de er for raske */ }
            }

            function playNotification() {
                 if (!soundsReady) return;
                try {
                    const now = Tone.now();
                    notificationSynth.triggerAttackRelease("A4", "8n", now); // Dypere tone
                    notificationSynth.triggerAttackRelease("F4", "8n", now + 0.1); // Dypere tone
                } catch (e) { console.warn("Tone.js feil (varsel):", e.message); }
            }
            // --- SLUTT PÅ LYD-MODUL ---


            // --- 5. SKRIVEMASKIN & INNBOKS-MODUL ---

            /**
             * Stopper en pågående skriveanimasjon
             */
            function stopTyping() {
                if (currentTypingTimer) {
                    clearTimeout(currentTypingTimer);
                }
                isTyping = false;
                currentTypingTimer = null;
            }

            /**
             * Hopper over skriveanimasjonen og viser all tekst
             */
            window.skipTyping = function() {
                if (!isTyping) return;
                
                stopTyping();
                
                // Gjenopprett all originaltekst umiddelbart
                for (let i = 0; i < currentTextNodes.length; i++) {
                    currentTextNodes[i].nodeValue = currentTextStrings[i];
                }
                
                currentTextNodes = [];
                currentTextStrings = [];
            }

            /**
             * Starter skrivemaskin-effekten for ny HTML-innhold
             */
            function typeText(htmlContent) {
                skipTyping(); // Stopp og fullfør enhver pågående skriving
                
                messageDisplay.innerHTML = htmlContent;
                currentTextNodes = [];
                currentTextStrings = [];
                
                // Finn alle tekst-noder
                findTextNodes(messageDisplay);
                
                // Lagre originalteksten og tøm nodene
                for (let i = 0; i < currentTextNodes.length; i++) {
                    currentTextStrings[i] = currentTextNodes[i].nodeValue;
                    currentTextNodes[i].nodeValue = '';
                }

                isTyping = true;
                nodeIndex = 0;
                charIndex = 0;
                
                // Start animasjonen
                typeChar();
            }

            /**
             * Rekursiv funksjon for å finne alle tekst-noder
             */
            function findTextNodes(element) {
                if (element.childNodes.length > 0) {
                    for (let i = 0; i < element.childNodes.length; i++) {
                        findTextNodes(element.childNodes[i]);
                    }
                } else if (element.nodeType === Node.TEXT_NODE && element.nodeValue.trim().length > 0) {
                    currentTextNodes.push(element);
                }
            }

            /**
             * Skriver ut én og én bokstav (hoved-loopen for skrivemaskinen)
             */
            function typeChar() {
                if (!isTyping) return;

                if (nodeIndex < currentTextNodes.length) {
                    const currentNode = currentTextNodes[nodeIndex];
                    const currentString = currentTextStrings[nodeIndex];

                    if (charIndex < currentString.length) {
                        currentNode.nodeValue += currentString[charIndex];
                        charIndex++;
                        playType(); // Spill av lyd for hver bokstav
                    } else {
                        // Gå til neste node
                        nodeIndex++;
                        charIndex = 0;
                    }
                    
                    // KjøR neste bokstav
                    currentTypingTimer = setTimeout(typeChar, TYPE_SPEED);
                    
                } else {
                    // Ferdig med å skrive
                    stopTyping();
                }
            }

            /**
             * Viser en live admin-melding
             */
            function showInboxMessage(message) {
                playNotification();
                inboxMessageContent.textContent = message;
                inboxOverlay.style.display = 'block';
                inboxModal.style.display = 'block';
            }

            /**
             * Lukker live admin-meldingen
             */
            function closeInboxMessage() {
                playClick();
                inboxOverlay.style.display = 'none';
                inboxModal.style.display = 'none';
                
                // Tømmer meldingen fra databasen så den ikke vises igjen
                if (isAuthReady && userId) {
                    const docRef = doc(db, appId, userId, "progress", "main");
                    updateDoc(docRef, { inbox: "" })
                        .catch(e => console.warn("Kunne ikke tømme innboks:", e));
                }
            }
            // --- SLUTT PÅ SKRIVEMASKIN & INNBOKS-MODUL ---


            // --- DATABASE MED KODEORD OG MELDINGER ---
            const briefings = {
                
                // NY: Initiell velkomstmelding
                '_initial_': (codename) => {
                    const team = (codename === 'raven' || codename === 'falcon') ? 'CELL O (AIRBORNE)' : 'CELL S (GROUND INTEL)';
                    return `
                        <h4>AUTENTISERING GODKJENT</h4>
                        <h5>Agent: ${codename.toUpperCase()}</h5>
                        <p>Velkommen til ECHELON 5-portalen, Agent.</p>
                        <p>Ditt kodenavn er synkronisert med Command Server.<br>Tilkobling til ${team} er etablert.</p>
                        <p>Systemet er nå klart til å motta din første autorisasjonskode.</p>
                        <p>Vennligst vent på direktiv og skriv inn koden nedenfor.</p>
                        <p>— Command Out.</p>
                    `;
                },

                // --- FASE 1: OSLO (Nå en funksjon) ---
                'team oslo': (codename) => {
                    if (codename === 'raven') {
                        return `
                            <h4>CLASSIFIED MESSAGE — CELL O</h4>
                            <h5>Agent: RAVEN (Airborne Division)</h5>
                            <p>Agent <strong>RAVEN</strong>, du er herved aktivert.</p>
                            <p>Din oppgave er å lede Airborne Division som strategisk observatør. Du har ansvar for overvåkning og identifikasjon fra avstand.</p>
                            
                            <h5>Reiseordre:</h5>
                            <ul>
                                <li>Transportmiddel: <strong>Tog</strong></li>
                                <li>Avreisedato: <strong>27. november</strong></li>
                                <li>Avgang: <strong>Oslo S kl. 09:25</strong></li>
                                <li>Destinasjon: <strong>Fortrolig</strong></li>
                            </ul>
                            <p>Ved ankomst skal du og Agent <strong>FALCON</strong> ta dere til følgende observasjonspunkt:<br>
                            <a href="https://www.google.com/maps/place/58%C2%B008'40.6%22N+7%C2%B°59'20.2%22E" target="_blank" class="location-link"><strong>58°08'40.6"N 7°59'20.2"E</strong></a></p>
                            
                            <h5>Oppdrag:</h5>
                            <p>Et kjøretøy (<strong>SD73382</strong>) vil ankomme, bemannet av Ground Intel (Agenter <strong>SHADOW</strong>, <strong>VIPER</strong>, <strong>COBRA</strong>).</p>
                            <p><strong>Din rolle:</strong> Etabler visuell kontakt. Du eller <strong>FALCON</strong> må ta kontakt på bakkenivå når kjøretøyet er i posisjon. Del deres kodeord-del (<strong>AURORA</strong>) for å verifisere sammenslåing.</p>
                            <p>— Command Out.</p>
                            <a href="#" class="download-button" onclick="downloadPakkliste()">Last ned Pakkliste (Echelon 3)</a>
                        `;
                    } else if (codename === 'falcon') {
                         return `
                            <h4>CLASSIFIED MESSAGE — CELL O</h4>
                            <h5>Agent: FALCON (Airborne Division)</h5>
                            <p>Agent <strong>FALCON</strong>, du er herved aktivert.</p>
                            <p>Din oppgave er å fungere som taktisk operatør for Airborne Division, med ansvar for hurtig respons og nærstøtte for Agent <strong>RAVEN</strong>.</p>
                            
                            <h5>Reiseordre:</h5>
                            <ul>
                                <li>Transportmiddel: <strong>Tog</strong></li>
                                <li>Avreisedato: <strong>27. november</strong></li>
                                <li>Avgang: <strong>Oslo S kl. 09:25</strong></li>
                                <li>Destinasjon: <strong>Fortrolig</strong></li>
                            </ul>
                            <p>Ved ankomst skal du og Agent <strong>RAVEN</strong> ta dere til følgende observasjonspunkt:<br>
                            <a href="https://www.google.com/maps/place/58%C2%B008'40.6%22N+7%C2%B°59'20.2%22E" target="_blank" class="location-link"><strong>58°08'40.6"N 7°59'20.2"E</strong></a></p>
                            
                            <h5>Oppdrag:</h5>
                            <p>Et kjøretøy (<strong>SD73382</strong>) vil ankomme, bemannet av Ground Intel (Agenter <strong>SHADOW</strong>, <strong>VIPER</strong>, <strong>COBRA</strong>).</p>
                            <p><strong>Din rolle:</strong> Sikre Agent RAVENs posisjon. Du eller <strong>RAVEN</strong> må ta kontakt på bakkenivå når kjøretøyet er i posisjon. Del deres kodeord-del (<strong>AURORA</strong>) for å verifisere sammenslåing. Vær klar for umiddelbar forflytning og dekkild om nødvendig.</p>
                            <p>— Command Out.</p>
                            <a href="#" class="download-button" onclick="downloadPakkliste()">Last ned Pakkliste (Echelon 3)</a>
                        `;
                    }
                    // Fallback for agenter som ikke skal ha denne
                    return `<p class="warning">SYSTEMFEIL: KODENAVN IKKE SYNKRONISERT MED DIREKTIV.</p>`;
                },

                // --- FASE 1: STAVANGER (Nå en funksjon) ---
                'team stavanger': (codename) => {
                    if (codename === 'shadow') {
                        return `
                            <h4>CLASSIFIED MESSAGE — CELL S</h4>
                            <h5>Agent: SHADOW (Feltleder, Ground Intel Unit)</h5>
                            <p>Agent <strong>SHADOW</strong>, du er herved aktivert og har kommandoen over Ground Intelligence Unit.</p>
                            <p>Din rolle: Feltleder og Command liaison. Du koordinerer operasjonen i sanntid og har ansvaret for Agent <strong>VIPER</strong> (Infiltrasjon) og <strong>COBRA</strong> (Teknisk).</p>

                            <h5>Reiseordre:</h5>
                            <ul>
                                <li>Transportmiddel: <strong>Bil (SD73382)</strong></li>
                                <li>Avreisedato: <strong>27. november</strong></li>
                                <li>Avgang: <strong>Stavanger kl. 11:30</strong></li>
                                <li>Destinasjon: <strong>Fortrolig</strong></li>
                            </ul>
                            <p>Ved ankomst skal dere posisjonere dere ved følgende koordinater:<br>
                            <a href="https://www.google.com/maps/place/58%C2%B008'40.6%22N+7%C2%B°59'20.2%22E" target="_blank" class="location-link"><strong>58°08'40.6"N 7°59'20.2"E</strong></a></p>

                            <h5>Oppdrag:</h5>
                            <p>Posisjoner kjøretøyet. Airborne Division (Agent <strong>RAVEN</strong> og <strong>FALCON</strong>) vil overvåke ankomsten deres fra avstand.</p>
                            <p>En av dem (enten RAVEN eller FALCON) vil ta kontakt på bakkenivå når dere er i posisjon. Del kodeord-delen deres (<strong>BOREALIS</strong>) med dem for å verifisere sammenslåing.</p>
                            <p>— Command Out.</p>
                            <a href="#" class="download-button" onclick="downloadPakkliste()">Last ned Pakkliste (Echelon 3)</a>
                        `;
                    } else if (codename === 'viper') {
                        return `
                            <h4>CLASSIFIED MESSAGE — CELL S</h4>
                            <h5>Agent: VIPER (Ground Intel Unit)</h5>
                            <p>Agent <strong>VIPER</strong>, du er herved aktivert.</p>
                            <p>Din rolle: Infiltrasjon og nærkontroll. Du er "først inn, sist ut" og har ansvaret for teamets umiddelbare sikkerhet i felt, under kommando av Agent <strong>SHADOW</strong>.</p>

                            <h5>Reiseordre:</h5>
                            <ul>
                                <li>Transportmiddel: <strong>Bil (SD73382)</strong></li>
                                <li>Avreisedato: <strong>27. november</strong></li>
                                <li>Avgang: <strong>Stavanger kl. 11:30</strong></li>
                                <li>Destinasjon: <strong>Fortrolig</strong></li>
                            </ul>
                            <p>Ved ankomst skal dere posisjonere dere ved følgende koordinater:<br>
                            <a href="https://www.google.com/maps/place/58%C2%B008'40.6%22N+7%C2%B°59'20.2%22E" target="_blank" class="location-link"><strong>58°08'40.6"N 7°59'20.2"E</strong></a></p>

                            <h5>Oppdrag:</h5>
                            <p>Airborne Division (<strong>RAVEN</strong> og <strong>FALCON</strong>) vil ha overvåkning. En av dem vil ta kontakt på bakkenivå når dere er i posisjon.</p>
                            <p><strong>Din rolle:</strong> Sikre landingssonen *før* kontakten skjer. Hold øye med alle sivile og potensielle trusler. Etter at koden er delt, vær teamets øyne og ører på bakkenivå.</p>
                            <p>— Command Out.</p>
                            <a href="#" class="download-button" onclick="downloadPakkliste()">Last ned Pakkliste (Echelon 3)</a>
                        `;
                    } else if (codename === 'cobra') {
                         return `
                            <h4>CLASSIFIED MESSAGE — CELL S</h4>
                            <h5>Agent: COBRA (Ground Intel Unit)</h5>
                            <p>Agent <strong>COBRA</strong>, du er herved aktivert.</p>
                            <p>Din rolle: Teknisk spesialist og kommunikasjonsansvarlig, under kommando av Agent <strong>SHADOW</strong>. Du håndterer alt av digitalt utstyr og kryptert kommunikasjon.</p>

                            <h5>Reiseordre:</h5>
                            <ul>
                                <li>Transportmiddel: <strong>Bil (SD73382)</strong></li>
                                <li>Avreisedato: <strong>27. november</strong></li>
                                <li>Avgang: <strong>Stavanger kl. 11:30</strong></li>
                                <li>Destinasjon: <strong>Fortrolig</strong></li>
                            </ul>
                            <p>Ved ankomst skal dere posisjonere dere ved følgende koordinater:<br>
                            <a href="https://www.google.com/maps/place/58%C2%B008'40.6%22N+7%C2%B°59'20.2%22E" target="_blank" class="location-link"><strong>58°08'40.6"N 7°59'20.2"E</strong></a></p>

                            <h5>Oppdrag:</h5>
                            <p>Airborne Division (<strong>RAVEN</strong> og <strong>FALCON</strong>) vil ha overvåkning. En av dem vil ta kontakt på bakkenivå når dere er i posisjon.</p>
                            <p><strong>Din rolle:</strong> Hold kommunikasjonen åpen. Vær klar til å motta og analysere eventuelle data som overføres fra Airborne-teamet.</p>
                            <p>— Command Out.</p>
                            <a href="#" class="download-button" onclick="downloadPakkliste()">Last ned Pakkliste (Echelon 3)</a>
                        `;
                    }
                    // Fallback for agenter som ikke skal ha denne
                    return `<p class="warning">SYSTEMFEIL: KODENAVN IKKE SYNKRONISERT MED DIREKTIV.</p>`;
                },

                // --- FASE 2: SAMMENSLÅING ---
                'aurora borealis': `
                    <h4>DIREKTIV K — VERIFISERT</h4>
                    <p>Sammenslåing av celler godkjent. Nytt direktiv:</p>
                    <p>Dere skal ta ferjen som går til Hirtshals <strong>16:30</strong>.</p>
                    <p><a href="https://storage.googleapis.com/files_webpage/Privat/Colourline%20bilett.pdf" target="_blank" class="location-link"><strong>Referanse: Ferjebilletter</strong></a></p>
                    <p>Når dere er ombord på båten får dere videre instruksjoner av Agent <strong>SHADOW</strong>.</p>
                    <p>— Command Out.</p>
                `,

                // --- FASE 2: FERGE (KODE 1) ---
                'jylland': `
                    <h4>CLASSIFIED TRANSMISSION — SHIPBOARD DIRECTIVE</h4>
                    <p>Godkjent tilgang.</p>
                    <p>Under overfarten har systemet fanget opp et fragmentert signal med seks elementer. Hvert element representerer både en bokstav og et tall, men bare en av delene er korrekt.</p>
                    <p>Krypteringsmetoden følger <strong>NORSE–6-protokollen</strong> – en kombinasjon av fonetisk og numerisk substitusjon.</p>

                    <h5>Intercepted sequence:</h5>
                    <p><strong>11-K, 15-O, 14-N, 22-V, 15-O, 25-Y</strong></p>

                    <h5>For å finne riktig bokstavkode må dere:</h5>
                    <ol>
                        <li><strong>Avdekke mønsteret:</strong><br>
                        Tallene refererer til alfabetets posisjoner (A = 1 … Z = 26). Men <strong>noen</strong> av tallene er falske; de skjuler seg bak primtall. Finn hvilke tall i sekvensen som er primtall, og bytt ut tilhørende bokstaver med bokstaven som kommer <strong>før</strong> i alfabetet.</li>
                        
                        <li><strong>Bruk NATO-fonetisk filtrering:</strong><br>
                        Skriv hele den nye sekvensen i NATO-fonetisk form. Ta den <strong>tredje bokstaven</strong> i hvert fonetiske ord og skriv dem sammen.</li>
                        
                        <li><strong>Resultatet danner Transit Code Alpha (bokstavkode).</strong></li>
                    </ol>
                    <p>Skriv inn koden i portalen når dere er enige.</p>
                    <p>— Command Out.</p>
                `,

                // --- FASE 2: FERGE (KODE 2) - GPS 1 ---
                'lcvccn': `
                    <h4>TRANSIT CODE ALPHA — VERIFIED</h4>
                    <p>Kryptert kommunikasjon gjenopprettet. Neste waypoint er aktivert.</p>
                    
                    <h5>Safehouse koordinater:</h5>
                    <p><a href="https://www.google.com/maps/place/57%C2%B003'48.6%22N+9%C2%B°54'47.6%22E" target="_blank" class="location-link"><strong>57°03'48.6"N 9°54'47.6"E</strong></a></p>
                    <p><strong>Lokasjon:</strong> Nørresundby</p>
                    <p>Gå direkte til disse koordinatene. Hold lav profil. Når lokasjonen er sikret, må du verifisere din posisjon for å motta neste direktiv.</p>
                    
                    <!-- KNAPP FOR GPS-SJEKK -->
                    <button id="verify-location-btn" class="download-button" onclick="verifySafehouseLocation()">
                        VERIFISER POSISJON
                    </button>
                    
                    <!-- Område for GPS-tilbakemelding -->
                    <div id="location-feedback" style="margin-top: 15px; color: #ff9900; font-weight: bold;"></div>
                `,
                
                // --- FASE 3: SAFEHOUSE ---
                'safehouse check-in': `
                    <h4>CLASSIFIED DIRECTIVE — FLIGHT OPS</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Godt jobbet, agenter. Lokasjon sikret.</p>
                    <p>Etter den vellykkede overføringen fra fergen er situasjonen endret. Våre analyser viser at GNM-modulen har vært aktiv i nettverkssporene vi overvåker.</p>
                    <p>For å sikre at minst ett lag kan rykke inn dersom situasjonen eskalerer, skal dere gjennomføre akutt pilotopplæring i et kontrollert miljø.</p>
                    
                    <p><strong>Lokasjon:</strong> <a href="https://www.google.com/maps/place/57%C2%B005'13.0%22N+9%C2%B°52'18.1%22E" target="_blank" class="location-link"><strong>57°05'13.0"N 9°52'18.1"E</strong></a><br>
                        <strong>Tid:</strong> 10:00 i morgen</p>
                    
                    <p>Dere vil gjennomføre et fullt <strong>pilottreningsprogram</strong> basert på F-16-plattformen. Forbered dere på høyde, hastighet og presisjon.</p>
                    <p>Etter fullført økt vil vertskapet gi dere neste autorisasjonskode.</p>
                    <p>— Command Out.</p>
                `,

                // --- FASE 4: ETTER FLIGHT OPS - GPS 2 ---
                'fuelcheck': `
                    <h4>CLASSIFIED MESSAGE — POST FLIGHT OPS DIRECTIVE</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Flight-sekvens fullført. Data bekrefter operativ beredskap hos alle enheter.</p>
                    <p>Nye instruksjoner er sendt fra kommandonivå.</p>
                    <p>Dere skal trekke tilbake til et sikkert sivilt kontaktpunkt for debrief og midlertidig avventing.</p>
                    
                    <h5>Lokasjon (Dekknavn):</h5>
                    <p><a href="https://www.google.com/maps/place/Slotsgade+33,+9000+Aalborg,+Denmark" target="_blank" class="location-link"><strong>ISIDOR HENIUS</strong></a><br>
                    <span style="color: #888;">Slotsgade 33, 9000 Aalborg, Denmark</span></p>
                    
                    <p><strong>Oppdrag:</strong> Møt på stedet. Når dere er innenfor rekkevidde, verifiser posisjonen for å motta neste ordre.</p>

                    <!-- KNAPP FOR GPS-SJEKK -->
                    <button id="verify-location-btn" class="download-button" onclick="verifyIsidorLocation()">
                        VERIFISER POSISJON (ISIDOR HENIUS)
                    </button>
                    
                    <!-- Område for GPS-tilbakemelding -->
                    <div id="location-feedback" style="margin-top: 15px; color: #ff9900; font-weight: bold;"></div>
                `,

                // --- FASE 4: ETTER ISIDOR HENIUS ---
                'table 19': `
                    <h4>CLASSIFIED MESSAGE — EVENING DIRECTIVE</h4>
                    <h5>Clearance Level: Echelon 5</h5>
                    <p>Dataoverføring fra Contact Point Bravo er mottatt. Operasjonen går inn i fase 6.</p>
                    <p>Dere har gjort en solid innsats i felt, og kommando gir grønt lys for midlertid rekreasjon og sosial samling før videre operasjon.</p>
                    
                    <h5>Neste oppmøtested:</h5>
                    <p>Et sivilisert deknavn brukt til lavprofil-møter mellom feltagenter:</p>
                    <p><strong>Dekknavn:</strong> THE BLACK TABLE<br>
                    <strong>Lokasjon:</strong> <a href="https://www.google.com/maps/search/?api=1&query=Restaurant+Flammen+Aalborg" target="_blank" class="location-link">Restaurant Flammen</a><br>
                    <strong>Tid:</strong> 19:00</p>
                    <p>— Command Out.</p>
                `,
                
                // --- FASE 5: PÅ RESTAURANT FLAMMEN ---
                'specter one': `
                    <h4>CLASSIFIED MESSAGE — FIELD DIRECTIVE</h4>
                    <h5>Clearance Level: Echelon 5</h5>
                    <p>Mottatt fra Agent <strong>SHADOW</strong>. Bekreftelse mottatt fra Command.</p>
                    <p>Satellittdata fra Jutland Sector viser aktivitet ved et tidligere treningsanlegg nordvest for Aalborg. Området går under dekknavnet:</p>
                    <p><strong>AMMO GROUND</strong></p>
                    <p>Dere skal forflytte dere fra nåværende base og være fullt operative ved morgengry.</p>
                    
                    <p><strong>Oppmøtested:</strong> <a href="https://www.google.com/maps/place/Magasinvej+7,+9870+Sindal,+Denmark" target="_blank" class="location-link">Magasinvej 7, 9870 Sindal, Denmark</a><br>
                        <strong>Tid:</strong> 09:00 i morgen</p>
                    
                    <h5>Instruks:</h5>
                    <ul>
                        <li>Pakk alle personlige eiendeler og klargjør utstyr for ny forflytning.</li>
                        <li>Etter fullført oppdrag vil dere <strong>ikke returnere</strong> til nåværende base.</li>
                        <li>Vær forberedt på overnatting annet sted etter feltoperasjonen.</li>
                    </ul>
                    
                    <h5>Bekledning:</h5>
                    <ul>
                        <li>Varmt og lagvis tøy (ull, fleece, vindtett jakke)</li>
                        <li>Gode sko eller vanntette støvler</li>
                        <li>Hansker og hodeplagg (lue/buff)</li>
                        <li>Ingen sterke farger — hold lav profil</li>
                    </ul>
                    <p>— Command Out.</p>
                `,

                // --- FASE 6: ETTER AMMO GROUND - GPS 3 ---
                'nordstar': `
                    <h4>CLASSIFIED MESSAGE — EXTRACTION ORDER</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Bekreftelse mottatt fra feltstyrken.</p>
                    <p>Rapportene fra AMMO GROUND bekrefter at GNM-modulen er deaktivert. Interferensloggene viser at systemet forsøkte en reaktivering, men at signalet ble avbrutt.</p>
                    <p>Operasjonen vurderes som suksessfull.</p>
                    <p class="warning">Men deres posisjon er nå kompromittert — det antas at motparten vil forsøke å spore opp teamet.</p>
                    
                    <h5>Direktiv:</h5>
                    <p>Gå i dekning umiddelbart. Dere skal forflytte dere til trygg sone for midlertidig evakuering.</p>
                    <p><strong>Lokasjon:</strong> <a href="https://www.google.com/maps/place/Skydebanevej+17,+9800+Hj%C3%B8rring" target="_blank" class="location-link">Skydebanevej 17, 9800 Hjørring</a><br>
                    <strong>Dekknavn:</strong> Base Echo</p>
                    <p>Hold lav profil under forflytning. Ved ankomst: sikre lokasjonen og verifiser posisjon for endelig debrief.</p>

                    <!-- KNAPP FOR GPS-SJEKK -->
                    <button id="verify-location-btn" class="download-button" onclick="verifyBaseEchoLocation()">
                        VERIFISER POSISJON (BASE ECHO)
                    </button>
                    
                    <!-- Område for GPS-tilbakemelding -->
                    <div id="location-feedback" style="margin-top: 15px; color: #ff9900; font-weight: bold;"></div>
                `,

                // --- FASE 7: PÅ BASE ECHO (HJØRRING) ---
                'echofall': `
                    <h4>CLASSIFIED MESSAGE — DEBRIEF DIRECTIVE</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Bekreftelse mottatt fra Base Echo.</p>
                    <p>Operasjonen nærmer seg konklusjon. Nye data fra kommandonivå viser at siste del av GNM-protokollen er fanget opp og isolert.</p>
                    <p>Alle enheter skal nå innkalles til endelig debrief og evaluering.</p>
                    
                    <p><strong>Dekknavn:</strong> Operation Bones<br>
                    <strong>Tid:</strong> 20:00<br>
                    <strong>Lokasjon:</strong> <a href="https://www.google.com/maps/search/?api=1&query=Bones+Restaurant,+Hjørring" target="_blank" class="location-link">Bones Restaurant, Hjørring</a></p>
                    
                    <p><strong>Oppdrag:</strong> Møt presist. Hold lav profil. Dette er siste steg før operasjonen avsluttes.</p>
                    <p>— Command Out.</p>
                `,

                // --- FASE 8: AVSLUTNING (PÅ BONES) ---
                'shadowfall': `
                    <h4>CLASSIFIED MESSAGE — OPERATION TERMINATION ORDER</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Bekreftelse mottatt fra feltleder SHADOW. Alle enheter rapportert som sikre.</p>
                    <p><strong>Operasjon NORTHERN STRIKE er herved erklært fullført.</strong></p>
                    <p>GNM-protokollen er isolert, kryptert og fjernet fra aktivt nettverk. Dataene sikret ved AMMO GROUND og overført via Base Echo har stanset reaktivering.</p>
                    <p>Kommandosenteret beordrer umiddelbar tilbaketrekning og oppløsning av operative enheter.</p>
                    
                    <h5>Direktiv:</h5>
                    <ul>
                        <li>Alle enheter trekker ut av operasjonsområdet i morgen.</li>
                        <li>Avreise skjer via maritim transport.</li>
                        <li><strong>Båtavgang:</strong> 12:15 (Møt ved terminal senest 11:45)</li>
                        <li><a href="https://storage.googleapis.com/files_webpage/Privat/Colourline%20bilett.pdf" target="_blank" class="location-link"><strong>Referanse: Ferjebilletter</strong></a></li>
                    </ul>
                    
                    <h5>Transportplan:</h5>
                    <ul>
                        <li><strong>Team Oslo:</strong> Forflytter seg videre med buss fra Kristiansand kl. 16:30.</li>
                        <li><strong>Team Stavanger:</strong> Returnerer kjøretøyet til hjemmebase via landrute.</li>
                    </ul>
                    <p>Hold lav profil under transport. Unngå identifiserbare symboler.</p>
                    <p>Denne operasjonen vil ikke bli offentlig anerkjent. Deres innsats har vært avgjørende.</p>
                    <p><strong>Mission Complete.</strong></p>
                    <p>— SHADOW / Command Out.</p>
                `
            };

            // --- ADMINPORTAL-DATABASE ---
            // Separat liste for admin-visning og arkiv-logikk
            const masterViewData = [
                { id: '_initial_', title: 'FASE 0: AUTENTISERT', team: 'felles', adminNote: 'Første melding agenten ser etter å ha logget inn med kodenavn. Venter på første kode.' },
                { id: 'team oslo', title: 'FASE 1: OSLO', team: 'oslo', adminNote: 'Agent RAVEN og FALCON starter her. De mottar reiserute og første observasjonsoppdrag.' },
                { id: 'team stavanger', title: 'FASE 1: STAVANGER', team: 'stavanger', adminNote: 'Agent SHADOW, VIPER og COBRA starter her. De mottar reiserute og første kontakt-oppdrag.' },
                { id: 'aurora borealis', title: 'FASE 2: SAMMENSLÅING', team: 'felles', adminNote: 'Felles kodeord for begge lag. Låser opp ferje-info. SHADOW utpekes som leder ombord.' },
                { id: 'jylland', title: 'FASE 2: FERGE (KODE 1)', team: 'felles', adminNote: 'Kodeord gitt av SHADOW på fergen. Låser opp NORSE-6-protokoll-puslespillet.' },
                { id: 'lcvccn', title: 'FASE 2: FERGE (KODE 2) - GPS 1', team: 'felles', adminNote: 'Løsningen på puslespillet. Låser opp Safehouse-koordinatene og første GPS-sjekk.' },
                { id: 'safehouse check-in', title: 'FASE 3: SAFEHOUSE', team: 'felles', adminNote: 'Låses opp av GPS ved Safehouse. Gir info om Flight Ops.' },
                { id: 'fuelcheck', title: 'FASE 4: ETTER FLIGHT OPS - GPS 2', team: 'felles', adminNote: 'Kodeord mottatt etter Flight Ops. Låser opp "Isidor Henius"-møtepunkt og andre GPS-sjekk.' },
                { id: 'table 19', title: 'FASE 4: ISIDOR HENIUS', team: 'felles', adminNote: 'Låses opp av GPS ved Isidor Henius. Gir info om kveldssamling (Restaurant Flammen).' },
                { id: 'specter one', title: 'FASE 5: PÅ FLAMMEN', team: 'felles', adminNote: 'Kodeord gitt av SHADOW på Flammen. Låser opp "AMMO GROUND"-oppdraget og pakkeliste for neste dag.' },
                { id: 'nordstar', title: 'FASE 6: ETTER AMMO GROUND - GPS 3', team: 'felles', adminNote: 'Kodeord gitt etter AMMO GROUND. Låser opp Base Echo (Hjørring) og siste GPS-sjekk.' },
                { id: 'echofall', title: 'FASE 7: BASE ECHO', team: 'felles', adminNote: 'Låses opp av GPS ved Base Echo. Gir info om endelig debrief (Bones).' },
                { id: 'shadowfall', title: 'FASE 8: AVSLUTNING', team: 'felles', adminNote: 'Kodeord gitt av SHADOW på Bones. Avslutter hele operasjonen og gir info om hjemreise.' }
            ];


            // --- 6. KJERNEFUNKSJONALITET (Firebase & App-logikk) ---

            /**
             * Initialiserer Firebase og setter opp autentisering
             */
            async function initFirebase() {
                try {
                    if (!firebaseConfig || !firebaseConfig.apiKey) {
                        throw new Error("Firebase config mangler!");
                    }
                    
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    console.log("Firebase initialisert.");

                    // Håndterer autentisering
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            // Bruker er logget inn
                            userId = user.uid;
                            isAuthReady = true;
                            console.log("Bruker er logget inn:", userId);
                            // Nå som vi er logget inn, last fremdriften
                            await loadProgress();
                            // Start innboks-lytteren
                            startInboxListener(userId);
                        } else {
                            // Bruker er ikke logget inn, prøv å logge inn anonymt
                            console.log("Ingen bruker funnet, logger inn anonymt...");
                            try {
                                const userCredential = await signInAnonymously(auth);
                                // Dette kalles på nytt, som trigger onAuthStateChanged
                            } catch (error) {
                                console.error("Anonym innloggingsfeil:", error);
                                let msg = error.message;
                                if (error.code === 'auth/configuration-not-found') {
                                    msg = "Authentication-tjenesten er ikke aktivert i Firebase-konsollen. Gå til 'Authentication' -> 'Sign-in method' og aktiver 'Anonym'.";
                                }
                                showErrorState("KRITISK FEIL VED INNLOGGING", msg);
                            }
                        }
                    });

                } catch (error) {
                    console.error("Firebase init-feil:", error);
                    showErrorState("SYSTEMFEIL: Kunne ikke koble til Command Server.", error.message);
                }
            }

            /**
             * Starter innboks-lytteren
             */
            function startInboxListener(uid) {
                if (inboxListenerUnsubscribe) {
                    inboxListenerUnsubscribe(); // Stopp forrige lytter
                }
                
                const docRef = doc(db, appId, uid, "progress", "main");
                inboxListenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.inbox && data.inbox.trim() !== "") {
                            showInboxMessage(data.inbox);
                        }
                    }
                }, (error) => {
                    console.error("Innboks-lytter feilet:", error);
                });
            }

            /**
             * Viser en permanent feilmelding i meldingsboksen
             */
            function showErrorState(title, message) {
                const errorHtml = `
                    <h4>${title}</h4>
                    <p class="warning">${message}</p>
                    <p>Last siden på nytt og prøv igjen. Hvis feilen vedvarer, kontakt administrator.</p>
                `;
                typeText(errorHtml); // Bruk skrivemaskin
                inputForm.style.display = 'none'; // Skjul input-feltet
            }

            /**
             * Laster agentens nåværende kodenavn fra lokal lagring
             */
            function getLocalCodename() {
                return localStorage.getItem('echelonAgentCodename');
            }

            /**
             * Lagrer agentens kodenavn i lokal lagring
             */
            function setLocalCodename(codename) {
                localStorage.setItem('echelonAgentCodename', codename);
                currentCodename = codename;
            }

            /**
             * Laster fremdriften (siste kode) fra Firestore
             */
            async function loadProgress() {
                if (!isAuthReady || !userId) {
                    console.warn("Lese-avbrudd: Auth er ikke klar.");
                    return;
                }
                
                // 1. Sjekk om vi har et lokalt kodenavn
                currentCodename = getLocalCodename();
                
                if (!currentCodename || !validCodenames.includes(currentCodename)) {
                    // 2. Ikke noe gyldig kodenavn? Vis innloggingsskjerm.
                    console.log("Ingen gyldig kodenavn funnet lokalt. Viser innlogging.");
                    showCodenameLogin();
                    return;
                }

                // 3. Vi har et kodenavn. Prøv å hente siste fremdrift fra DB.
                try {
                    const docRef = doc(db, appId, userId, "progress", "main");
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        currentUserLastCode = data.lastCode;
                        
                        // Sjekk om kodenavnet i DB matcher det lokale
                        if (data.codename !== currentCodename) {
                            console.warn("Kodenavn-mismatch! DB:", data.codename, "Lokal:", currentCodename, ". Oppdaterer DB.");
                            // Det lokale kodenavnet har forrang. Oppdater DB.
                            await saveProgress(currentUserLastCode, false); // Lagrer uten å vise melding
                        }
                        
                        console.log("Fremdrift lastet:", currentUserLastCode);
                        showUnlockedMessage(currentUserLastCode, true); // Viser melding uten "laster"
                    } else {
                        // 4. Ingen fremdrift i DB? Vis FØRSTE MELDING.
                        console.log("Ingen fremdrift i DB. Viser standard første melding.");
                        
                        // FIKS: Sett startkoden til _initial_
                        const initialCode = '_initial_';
                        await saveProgress(initialCode, false); // Lagre den første koden, ikke vis den
                        
                        // Vis den initielle velkomstmeldingen
                        showUnlockedMessage(initialCode, true);
                    }
                } catch (error) {
                    console.error("Feil ved lasting av fremdrift:", error);
                    showErrorState("DATABASEFEIL", "Kunne ikke hente agent-data. Sjekk tilkobling.");
                }
            }
            
            /**
             * Lagrer fremdriften (siste kode) til Firestore
             */
            async function saveProgress(code, showMessage = true) {
                if (!isAuthReady || !userId || !currentCodename) {
                    console.warn("Lagre-avbrudd: Auth/kodenavn er ikke klar.");
                    return;
                }
                
                try {
                    const docRef = doc(db, appId, userId, "progress", "main");
                    await setDoc(docRef, { 
                        lastCode: code,
                        codename: currentCodename,
                        lastUpdated: new Date()
                    }, { merge: true });
                    
                    currentUserLastCode = code; // Oppdater global tilstand
                    console.log("Fremdrift lagret:", code, "for", currentCodename);
                    
                    if (showMessage) {
                        showUnlockedMessage(code);
                    }
                } catch (error) {
                    console.error("Feil ved lagring av fremdrift:", error);
                    // Ikke vis feil til bruker, bare logg
                }
            }

            /**
             * Viser kodenavn-innloggingsskjermen
             */
            function showCodenameLogin() {
                currentView = 'login';
                const loginHtml = `
                    <h4>AGENT-AUTENTISERING</h4>
                    <p>Systemet krever identifisering.</p>
                    <p>Vennligst skriv inn ditt tildelte ECHELON 5 kodenavn for å synkronisere med Command Server.</p>
                    <div id="login-form-container">
                        <input type="text" id="codename-input" placeholder="Skriv kodenavn..." autocomplete="off">
                        <button id="codename-submit-btn" onclick="handleCodenameLogin()">AUTENTISER</button>
                        <div id="login-feedback"></div>
                    </div>
                `;
                typeText(loginHtml); // Bruk skrivemaskin
                inputForm.style.display = 'none';

                // Input-feltet må hentes *etter* at HTML er satt
                const codenameInput = document.getElementById('codename-input');
                codenameInput.onkeyup = (e) => {
                    if (e.key === 'Enter') {
                        window.handleCodenameLogin();
                    }
                };
            }

            /**
             * Kjøres når brukeren trykker "DEKRYPTER"
             */
            function submitCode() {
                playClick();
                
                // Hent og normaliser koden (små bokstaver, ingen mellomrom)
                let code = codeInput.value.toLowerCase().trim();
                
                // Spesialtilfelle for "safehouse check-in"
                if (code === "safehouse check-in" || code === "safehouse checkin") {
                    code = 'safehouse check-in';
                }
                
                // Tøm feilmeldinger
                feedbackDisplay.innerHTML = '';

                // --- MASTER PORTAL KODE ---
                if (code === '95764045') {
                    showMasterPortal();
                    codeInput.value = '';
                    return;
                }
                
                // Prøv å finne koden i vår "database"
                const messageHtml = briefings[code];

                if (messageHtml) {
                    // KODE FUNNET!
                    playSuccess();
                    
                    // 1. Lagre fremdriften (og vis meldingen)
                    saveProgress(code, true);

                } else {
                    // KODE IKKE FUNNET
                    playError();
                    
                    // Gi en feilmelding
                    feedbackDisplay.innerHTML = '<p class="warning">ADGANG NEKTET. KODE IKKE GJENKJENT.</p>';
                    
                    // Rist på input-feltet for effekt (valgfritt)
                    const form = inputForm;
                    form.style.animation = 'shake 0.3s';
                    setTimeout(() => { form.style.animation = ''; }, 300);
                }
                
                codeInput.value = ''; // Tøm inputfeltet
            }

            /**
             * Viser en låst opp melding (med lasting-effekt)
             */
            window.showUnlockedMessage = function(code, skipLoader = false) {
                
                const showContent = () => {
                    // Hent riktig HTML. Håndter funksjoner (som team oslo)
                    const messageContent = (typeof briefings[code] === 'function')
                        ? briefings[code](currentCodename)
                        : briefings[code];
                    
                    if (!messageContent) {
                        console.error(`Fant ikke melding for kode: ${code}`);
                        typeText(`<p class="warning">SYSTEMFEIL: Kunne ikke laste direktiv ${code}.</p>`);
                        return;
                    }

                    typeText(messageContent); // Bruk skrivemaskin
                    inputForm.style.display = 'flex'; // Sørg for at input er synlig
                    currentView = 'mission';
                    window.scrollTo(0, 0); // Scroll til toppen
                };

                if (skipLoader) {
                    showContent();
                } else {
                    // 1. Vis en "laste"-melding for effekt
                    const loaderHtml = `
                        <div class="loader">
                            DEKRYPTERER SIGNAL...<br>
                            VERIFISERER AUTORISASJON...<br>
                            ETABLERER SIKKER KOBLING...
                        </div>`;
                    typeText(loaderHtml); // Bruk skrivemaskin for lasteren også
                    
                    // 2. Vent 1.5 sekunder, og vis så den ekte meldingen
                    setTimeout(showContent, 1500);
                }
            }

            /**
             * Genererer og laster ned pakklisten som en .txt-fil
             */
            window.downloadPakkliste = function() {
                playClick();
                const pakklisteText = `PERSONLIG UTSTYR — STANDARD LOADOUT
CLASSIFIED DOCUMENT — EQUIPMENT MANIFEST

Clearance Level: ECHELON 3
Distribution: Authorized Field Units Only

---------------------------------
⚙️ FELTUTSTYR
For oppdrag under skiftende vær og lang forflytning:
---------------------------------
• Ekstra ullsokker (ett par i vanntett pose)
• Tynt sitteunderlag eller sammenrullbar pute (pause i felt)
• Ørepropper (for søvn eller støy)
• Powerbank
• Ullundertøy
• Fjellsko
• Turbukse (helst uten flashy farger)
• Jakke (helst uten flashy farger)
• Tynne hansker
• Lue

---------------------------------
🧳 SIVILT / LOGISTIKK
For komfort og beredskap mellom operasjonene:
---------------------------------
• Ekstra undertøy og sokker
• Komfortabel bukse for innendørs bruk
• T-skjorte
• Genser
• Reisedokumenter, ID og kopi på mobilen
• Liten notatbok og penn (for oppdragsnotater)

---------------------------------
👔 FORMELLT OPPDAGSANTREKK — “CAUSAL BUSINESS”
---------------------------------
• Finbukser
• Skjorte
• Jakke

---------------------------------
🧴 DIVERSE / PERSONLIG
---------------------------------
• Mobillader
• Solbriller (lav sol i Danmark på vinteren)
• Lommebok
• Toalettsaker

---------------------------------
Instruks:
Pakk lett i ryggsekk. Du må regne med å bære tingene dine under forflytning.
Unngå sterke farger og synlige logoer.
Hold lav profil.
— Command Logistics Division / Operation Northern Strike
`;
                
                // Lag en 'blob' (en fil i minnet)
                const blob = new Blob([pakklisteText], { type: 'text/plain;charset=utf-8' });
                
                // Lag en falsk nedlastingslenke
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'pakkliste.txt';
                
                // Klikk på lenken
                document.body.appendChild(link);
                link.click();
                
                // Rydd opp
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            }


            // --- 7. GPS VERIFISERINGSFUNKSJONER ---

            // Definerer koordinatene for "Safehouse"
            // 57°03'48.6"N 9°54'47.6"E
            const SAFEHOUSE_LAT = 57.0635;
            const SAFEHOUSE_LON = 9.913222;
            
            // Definerer koordinatene for "Isidor Henius"
            // Slotsgade 33, 9000 Aalborg
            const ISIDOR_LAT = 57.05061;
            const ISIDOR_LON = 9.91976;

            // Definerer koordinatene for "Base Echo"
            // Skydebanevej 17, 9800 Hjørring
            const ECHO_LAT = 57.45788;
            const ECHO_LON = 9.95764;

            const MAX_DISTANCE_METERS = 150; // Agenten må være innenfor 150 meter

            // -- GPS 1: Safehouse ---
            window.verifySafehouseLocation = function() {
                playClick();
                verifyLocation(SAFEHOUSE_LAT, SAFEHOUSE_LON, 'safehouse check-in');
            }

            // -- GPS 2: Isidor Henius ---
            window.verifyIsidorLocation = function() {
                playClick();
                verifyLocation(ISIDOR_LAT, ISIDOR_LON, 'table 19');
            }
            
            // -- GPS 3: Base Echo ---
            window.verifyBaseEchoLocation = function() {
                playClick();
                verifyLocation(ECHO_LAT, ECHO_LON, 'echofall');
            }

            /**
             * Generisk funksjon for å verifisere posisjon
             */
            function verifyLocation(targetLat, targetLon, successCode) {
                const feedback = document.getElementById('location-feedback');
                const btn = document.getElementById('verify-location-btn');
                
                if (!navigator.geolocation) {
                    feedback.innerHTML = '<p class="warning">FEIL: GEOLOKASJON STØTTES IKKE AV DENNE ENHETEN.</p>';
                    playError();
                    return;
                }

                feedback.innerHTML = 'Søker etter GPS-signal... Godkjenn forespørsel i nettleser...';
                btn.disabled = true;
                btn.innerHTML = 'LOKALISERER...';

                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000, 
                    maximumAge: 0
                };

                // Start GPS-forespørselen
                navigator.geolocation.getCurrentPosition(
                    (pos) => locationSuccess(pos, targetLat, targetLon, successCode),
                    locationError,
                    options
                );
            }

            /**
             * Kjøres HVIS vi får en gyldig posisjon
             */
            function locationSuccess(pos, targetLat, targetLon, successCode) {
                const feedback = document.getElementById('location-feedback');
                
                const userLat = pos.coords.latitude;
                const userLon = pos.coords.longitude;

                // Beregn avstanden fra agenten til målet
                const distance = calculateDistance(targetLat, targetLon, userLat, userLon);

                if (distance <= MAX_DISTANCE_METERS) {
                    // SUKSESS! Agenten er på rett sted.
                    playSuccess();
                    feedback.innerHTML = `POSISJON VERIFISERT (Avstand: ${Math.round(distance)}m). Laster neste direktiv...`;
                    
                    // Lagre det nye, ulåste oppdraget (og vis det)
                    saveProgress(successCode, true);

                } else {
                    // FEIL: Agenten er for langt unna
                    playError();
                    feedback.innerHTML = `<p class="warning">VERIFISERING NEKTET. POSISJON LOKALISERT, MEN DU ER IKKE VED MÅLET. (Avstand: ${Math.round(distance)}m). PRØV IGJEN NÅR DU ER NÆRMERE.</p>`;
                    const btn = document.getElementById('verify-location-btn');
                    btn.disabled = false;
                    btn.innerHTML = 'VERIFISER POSISJON PÅ NYTT';
                }
            }

            /**
             * Kjøres HVIS det oppstår en feil (f.eks. agenten nekter GPS-tilgang)
             */
            function locationError(err) {
                playError();
                const feedback = document.getElementById('location-feedback');
                const btn = document.getElementById('verify-location-btn');
                
                let errorMsg = '';
                switch(err.code) {
                    case err.PERMISSION_DENIED:
                        errorMsg = "ADGANG NEKTET. Systemet krever GPS-tilgang for å verifisere posisjon.";
                        break;
                    case err.POSITION_UNAVAILABLE:
                        errorMsg = "SIGNAL TAPT. Posisjonsdata er ikke tilgjengelig. Prøv å gå utendørs.";
                        break;
                    case err.TIMEOUT:
                        errorMsg = "TIDSAVBRUDD. Kunne ikke hente posisjon. Sjekk GPS-signal og prøv igjen.";
                        break;
                    default:
                        errorMsg = "UKJENT GPS-FEIL. Kunne ikke verifisere posisjon.";
                        break;
                }
                feedback.innerHTML = `<p class="warning">${errorMsg}</p>`;
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'VERIFISER POSISJON';
                }
            }

            /**
             * Hjelpefunksjon for å beregne avstand mellom to GPS-punkter (Haversine-formelen)
             * Returnerer avstanden i meter.
             */
            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // Jordens radius i meter
                const φ1 = lat1 * Math.PI / 180; // φ, λ i radianer
                const φ2 = lat2 * Math.PI / 180;
                const Δφ = (lat2 - lat1) * Math.PI / 180;
                const Δλ = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                          Math.cos(φ1) * Math.cos(φ2) *
                          Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                const d = R * c; // avstand i meter
                return d;
            }


            // --- 8. MASTER PORTAL & ARKIV FUNKSJONER ---
            
            /**
             * Viser Master Admin-portalen
             */
            window.showMasterPortal = function() {
                playClick();
                currentView = 'master';
                let listHtml = '<h4>ADMINISTRATORPORTAL</h4><div class="master-list">';
                
                masterViewData.forEach((item, index) => {
                    listHtml += `
                        <a href="#" class="master-link" onclick="showMasterDetailView('${item.id}'); return false;">
                            <span>#${index}</span>
                            <strong>${item.title}</strong>
                        </a>
                    `;
                });
                
                listHtml += '</div>';
                
                // Tilbakestillings-seksjon
                listHtml += `
                    <h5 style="margin-top: 30px;">System-tilbakestilling</h5>
                    <p>En full tilbakestilling er en 2-stegs prosess for å slette data fra serveren og din lokale nettleser.</p>
                    <ol>
                        <li><strong>Server:</strong> Gå til Firebase-konsollen -> Firestore Database -> '${appId}' samlingen. Slett denne samlingen manuelt for å fjerne alle agenters fremdrift.</li>
                        <li><strong>Lokal:</strong> Trykk på knappen under for å slette kodenavnet som er lagret i *din* nettleser.</li>
                    </ol>
                    <button class="download-button" style="background-color: #ff5555;" onclick="resetLocalAgent();">Tilbakestill Lokal Agent</button>
                `;
                
                typeText(listHtml);
            }

            /**
             * Viser detaljsiden for ett oppdrag i Master-portalen
             */
            window.showMasterDetailView = function(code) {
                playClick();
                currentView = 'master-detail';
                const mission = masterViewData.find(m => m.id === code);
                const messageHtml = (typeof briefings[code] === 'function')
                    ? briefings[code]('SHADOW') // Viser bare "SHADOW" som eksempel for admin
                    : briefings[code];

                const detailHtml = `
                    <a href="#" onclick="showMasterPortal(); return false;">&laquo; Tilbake til Master-listen</a>
                    <h4 style="margin-top: 15px;">ADMIN: ${mission.title}</h4>
                    <p><strong>KODEORD:</strong> ${mission.id}</p>
                    <p><strong>ADMIN-NOTAT:</strong> <em>${mission.adminNote}</em></p>
                    
                    <hr style="border-color: #444; margin: 20px 0;">
                    
                    <h4>EKSEMPEL PÅ MELDING (for 'SHADOW'):</h4>
                    <div>${messageHtml}</div>
                `;
                typeText(detailHtml);
            }
            
            /**
             * Viser agentens personlige arkiv over fullførte oppdrag
             */
            window.showCompletedMissionsMenu = function() {
                playClick();
                currentView = 'archive';
                
                // Bestem agentens team
                const agentTeam = (currentCodename === 'raven' || currentCodename === 'falcon') ? 'oslo' : 'stavanger';
                
                let listHtml = '<h4>OPPDRAGSARKIV</h4><div class="master-list">';
                
                const lastCodeIndex = masterViewData.findIndex(m => m.id === currentUserLastCode);
                
                if (lastCodeIndex === -1) {
                    listHtml += '<p>Ingen oppdrag fullført ennå.</p>';
                } else {
                    for (let i = 0; i <= lastCodeIndex; i++) {
                        const mission = masterViewData[i];
                        
                        // FIKS: Ikke vis '_initial_' i arkivet
                        if (mission.id === '_initial_') {
                            continue;
                        }

                        // Team-filtrering
                        // Vis kun hvis oppdraget er 'felles' ELLER teamet matcher agentens team
                        if (mission.team === 'felles' || mission.team === agentTeam) {
                            listHtml += `
                                <a href="#" class="master-link" onclick="showArchiveDetailView('${mission.id}'); return false;">
                                    <span>#${i}</span>
                                    <strong>${mission.title}</strong>
                                </a>
                            `;
                        }
                    }
                }
                
                listHtml += '</div>';
                listHtml += '<button class="download-button" onclick="showUnlockedMessage(currentUserLastCode, true);">Tilbake til Siste Oppdrag</button>';
                typeText(listHtml);
            }

            /**
             * Viser detaljsiden for ett oppdrag i Arkivet
             */
            window.showArchiveDetailView = function(code) {
                playClick();
                currentView = 'archive-detail';
                const messageHtml = (typeof briefings[code] === 'function')
                    ? briefings[code](currentCodename) // Viser den persontilpassede meldingen
                    : briefings[code];

                const detailHtml = `
                    <a href="#" onclick="showCompletedMissionsMenu(); return false;">&laquo; Tilbake til Arkiv</a>
                    <div style="margin-top: 15px;">${messageHtml}</div>
                `;
                typeText(detailHtml);
            }

            /**
             * Tilbakestiller den lokale agent-økten (for admin)
             */
            window.resetLocalAgent = function() {
                playError(); // Bruker feil-lyd for en "farlig" handling
                localStorage.removeItem('echelonAgentCodename');
                // Ikke bruk alert/reload, bare vis kodenavn-innlogging
                showCodenameLogin();
            }

            /**
             * Håndterer kodenavn-innlogging
             */
            window.handleCodenameLogin = function() {
                playClick();
                const codenameInput = document.getElementById('codename-input');
                const loginFeedback = document.getElementById('login-feedback');
                const input = codenameInput.value.toLowerCase().trim();
                
                if (validCodenames.includes(input)) {
                    playSuccess();
                    setLocalCodename(input);
                    loadProgress(); // Last fremdriften på nytt
                } else {
                    playError();
                    loginFeedback.innerHTML = '<p class="warning">KODENAVN IKKE GJENKJENT.</p>';
                    codenameInput.value = '';
                }
            };

            
            // --- 9. START APPLIKASJONEN ---
            
            // Sett opp event listeners for knapper
            inputForm.onsubmit = (e) => {
                e.preventDefault();
                submitCode();
            };
            
            menuBtn.onclick = () => {
                playClick();
                // Bytt mellom arkiv og siste oppdrag
                if (currentView === 'archive' || currentView === 'archive-detail') {
                    showUnlockedMessage(currentUserLastCode, true); // Hopp over laster
                } else {
                    showCompletedMissionsMenu();
                }
            };

            inboxCloseBtn.onclick = closeInboxMessage;

            // Start Firebase-tilkoblingen
            initFirebase();
            
        }); // Slutt på DOMContentLoaded

    </script>
    
    <!-- CSS for Riste-animasjon (valgfritt) -->
    <style>
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { translateX(-5px); }
            50% { translateX(5px); }
            75% { translateX(-5px); }
            100% { transform: translateX(0); }
        }
    </style>

</body>
</html>
