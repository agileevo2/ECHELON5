<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>KOMMANDOPORTAL // ECHELON 5</title>
    <!-- Sørger for at den ser bra ut på mobil -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Importerer Tone.js for lydeffekter -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <style>
        /* --- GRUNNLEGGENDE STIL --- */
        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Consolas', 'Courier New', monospace; /* Agent/Terminal-font */
            background-color: #0a0a0a; /* Svart bakgrunn */
            color: #d4d4d4; /* Lys grå tekst */
            font-size: 15px; /* Tilbake til 15px */
            line-height: 1.6;
            /* Forhindrer iOS i å endre skriftstørrelse */
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        /* --- HOVEDLAYOUT --- */
        #portal {
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Fyller hele skjermen */
            max-width: 700px; /* God lesebredde */
            margin: 0 auto;
            border-left: 1px solid #333;
            border-right: 1px solid #333;
        }

        /* --- HEADER --- */
        #header {
            background-color: #1a1a1a;
            border-bottom: 2px solid #ff9900; /* Aksentfarge (oransje/amber) */
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #header h1 {
            margin: 0;
            color: #ff9900;
            font-size: 1.0rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Ikon-container i header */
        .header-icons {
            display: none; /* SKJULT SOM STANDARD - Vises kun etter login */
            gap: 15px;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #d4d4d4;
            padding: 5px;
            transition: color 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.7rem;
            font-family: 'Consolas', monospace;
        }
        
        .icon-btn svg {
            width: 24px;
            height: 24px;
            margin-bottom: 2px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .icon-btn:hover {
            color: #ff9900;
        }

        /* --- MELDINGSVISNING --- */
        #message-display {
            padding: 20px;
            flex-grow: 1; /* Tar opp all ledig plass */
            background-color: #111;
            cursor: pointer; /* Viser at man kan klikke for å hoppe over skriving */
        }

        /* Meldingstitler (f.eks. CLASSIFIED MESSAGE) */
        #message-display h4 {
            color: #ff9900;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
            margin-top: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.1rem;
        }

        /* Undertitler (f.eks. Reiseordre) */
        #message-display h5 {
            color: #b5b5b5;
            text-transform: uppercase;
            margin-top: 25px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        #message-display p {
            margin-bottom: 15px;
        }

        /* Punktlister */
        #message-display ol {
             margin-left: 20px;
            padding-left: 10px;
        }
        #message-display ul {
            list-style-type: '• ';
            margin-left: 20px;
            padding-left: 10px;
        }

        #message-display li {
            margin-bottom: 8px;
        }

        /* Uthevet tekst (f.eks. koordinater) */
        #message-display strong {
            color: #ffc266; /* Lysere oransje */
            font-weight: normal; /* Fonten er allerede "bold" */
        }
        
        /* Spesiell klasse for advarsler */
        .warning {
            color: #ff5555 !important; /* Rød for feilmeldinger */
        }
        
        /* Lenker til kart */
        .location-link {
            color: #ffc266;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 3px;
        }
        .location-link:hover {
            color: #ffd9a6;
        }
        
        /* Nedlastingsknapp / GPS-knapp */
        .download-button {
            display: block;
            background-color: #ff9900;
            color: #111;
            text-decoration: none;
            text-align: center;
            padding: 15px 20px;
            margin-top: 25px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 4px;
            cursor: pointer;
            border: none; /* Sørger for at button-elementer ser like ut */
            font-family: 'Consolas', 'Courier New', monospace; /* Arver font */
            font-size: 0.9rem; /* Justert størrelse */
            width: 100%; /* Sørger for at den fyller bredden */
        }
        .download-button:hover {
            background-color: #ffc266;
        }
        .download-button:disabled {
            background-color: #555;
            color: #999;
            cursor: not-allowed;
        }


        /* Laste-animasjon */
        .loader {
            text-align: center;
            padding: 40px 20px;
            color: #ff9900;
            font-size: 1.1rem;
            animation: flicker 1.5s infinite alternate;
        }

        @keyframes flicker {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        /* --- INNTASTINGSOMRÅDE --- */
        #input-form {
            background-color: #1a1a1a;
            border-top: 2px solid #ff9900;
            padding: 15px;
            display: none; /* Skjult som standard */
            position: sticky;
            bottom: 0;
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            display: flex; /* Flexbox for å legge input og knapp på linje */
        }

        #code-input {
            flex-grow: 1; /* Tar all ledig plass */
            background: #222;
            border: 1px solid #444;
            color: #d4d4d4;
            padding: 14px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 1rem;
            border-radius: 4px 0 0 4px; /* Avrundet venstre side */
            min-width: 0; /* Hindrer overflow */
        }
        #code-input:focus {
            outline: none;
            border-color: #ff9900;
            background-color: #333;
        }

        #submit-btn {
            background-color: #ff9900;
            border: none;
            color: #111;
            padding: 14px 20px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 0 4px 4px 0; /* Avrundet høyre side */
            font-size: 1rem;
            white-space: nowrap; /* Hindrer tekst i å bryte */
        }
        #submit-btn:hover {
            background-color: #ffc266;
        }


        /* --- STYLING FOR KODENAVN-INNLOGGING --- */
        #login-form-container {
            margin-top: 20px;
        }
        #codename-input {
            display: block;
            width: 100%;
            background: #222;
            border: 1px solid #444;
            color: #d4d4d4;
            padding: 14px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 1rem;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        #codename-input:focus {
            outline: none;
            border-color: #ff9900;
            background-color: #333;
        }
        #codename-submit-btn {
            display: block;
            width: 100%;
            background-color: #ff9900;
            border: none;
            color: #111;
            padding: 14px 18px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 4px;
            font-size: 1rem;
        }
        #login-feedback {
            padding: 10px 0;
            text-align: center;
        }


        /* --- STYLING FOR MASTER PORTAL / ADMIN DASHBOARD --- */
        .master-list {
            border-top: 1px solid #444;
            margin-top: 20px;
        }
        .master-link {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 1px solid #333;
            text-decoration: none;
            color: #d4d4d4;
            transition: background-color 0.2s;
        }
        .master-link:hover {
            background-color: #1f1f1f;
            color: #ffc266;
        }
        .master-link strong {
            font-size: 1.1rem;
            color: #ffc266;
        }
        .master-link span {
            font-size: 0.9rem;
            color: #888;
        }
        
        /* Admin Menu Buttons */
        .admin-menu-btn {
            display: block;
            width: 100%;
            padding: 20px;
            margin-bottom: 15px;
            background-color: #1a1a1a;
            border: 1px solid #ff9900;
            color: #ff9900;
            text-align: left;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 1.1rem;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-menu-btn:hover {
            background-color: #ff9900;
            color: #111;
        }
        
        /* Ny CSS for Agent Dashboard */
        #agent-dashboard .agent-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dotted #333;
        }
        #agent-dashboard .agent-info {
            flex-grow: 1;
            cursor: pointer;
        }
        #agent-dashboard .agent-info:hover {
            color: #ffc266;
        }
        #agent-dashboard .agent-status {
            font-size: 0.8em;
            color: #aaa;
            max-width: 180px;
            text-align: right;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .status-icon {
            font-weight: bold;
            margin-right: 5px;
        }
        .status-ready { color: #55ff55; } /* Grønn */
        .status-stuck { color: #ff9900; } /* Gul/Oransje */
        .status-login { color: #ff5555; } /* Rød */
        .agent-id {
            font-size: 0.75rem;
            color: #555;
            display: block;
        }

        /* Ny CSS for PUSH-knappen i Admin Detail */
        .push-button {
            background-color: #ff5555; /* Rød for advarsel/override */
            margin-top: 5px;
            padding: 8px 12px;
            font-size: 0.8rem;
            width: auto;
            display: inline-block;
            border-radius: 4px;
            color: #111;
            cursor: pointer;
            border: none;
            font-weight: bold;
            text-transform: uppercase;
        }
        .push-button:hover {
            background-color: #ff8888;
        }
        
        /* CSS for Meldinger */
        #msg-recipient {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: #222;
            border: 1px solid #444;
            color: #d4d4d4;
            font-family: 'Consolas', 'Courier New', monospace;
        }
        #msg-text {
            width: 100%;
            height: 100px;
            padding: 10px;
            background: #222;
            border: 1px solid #444;
            color: #d4d4d4;
            font-family: 'Consolas', 'Courier New', monospace;
            resize: none;
            margin-bottom: 10px;
        }
        
        /* Quick message buttons */
        .quick-msg-btn {
            background-color: #333;
            color: #aaa;
            border: 1px solid #444;
            padding: 5px 10px;
            margin: 0 5px 5px 0;
            cursor: pointer;
            font-size: 0.8rem;
            font-family: 'Consolas', monospace;
        }
        .quick-msg-btn:hover {
            background-color: #ff9900;
            color: #111;
        }
        
        /* Innboks liste-stil */
        .inbox-item {
            border-bottom: 1px solid #333;
            padding: 15px 0;
        }
        .inbox-time {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 5px;
        }
        .inbox-msg {
            color: #ffc266;
        }


        /* Område for feilmeldinger */
        #feedback {
            padding: 0 15px;
            text-align: center;
        }

        /* --- ADAPTIV MEDIA QUERY --- */
        /* For skjermer smalere enn 420px */
        @media (max-width: 420px) {
            #input-form {
                padding: 10px;
            }
        }
        /* --- SLUTT PÅ ADAPTIV CSS --- */


        /* --- NY CSS FOR INNBOKS-MODAL --- */
        #inbox-overlay {
            display: none; /* Skjult som standard */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        #inbox-modal {
            display: none; /* Skjult som standard */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 500px;
            background: #1a1a1a;
            border: 2px solid #ff5555; /* Rød alarm-kant */
            border-radius: 4px;
            z-index: 1001;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.4);
        }
        
        #inbox-modal h4 {
            background: #ff5555;
            color: #111;
            padding: 15px;
            margin: 0;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #inbox-modal p {
            padding: 25px;
            font-size: 1.1rem;
            line-height: 1.7;
            color: #fff;
            white-space: pre-wrap; /* Beholder linjeskift fra admin */
        }

        #inbox-modal button {
            display: block;
            width: calc(100% - 50px);
            margin: 0 25px 25px 25px;
        }
        /* --- SLUTT PÅ INNBOKS-MODAL CSS --- */
    </style>
</head>
<body>

    <div id="portal">
        
        <!-- 1. HEADER (Oppdatert med ikoner - SKJULT SOM STANDARD) -->
        <header id="header">
            <h1>ECHELON 5</h1>
            <div class="header-icons" id="header-nav">
                <button id="header-archive-btn" class="icon-btn" title="Arkiv">
                    <!-- Mappe-ikon (SVG) -->
                    <svg viewBox="0 0 24 24">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                    ARKIV
                </button>
                <button id="header-inbox-btn" class="icon-btn" title="Innboks">
                    <!-- Konvolutt-ikon (SVG) -->
                    <svg viewBox="0 0 24 24">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    INNBOKS
                </button>
            </div>
        </header>

        <!-- 2. MELDINGSBOKS (Her vises alt innhold) -->
        <main id="message-display" onclick="skipTyping()">
            <!-- Innholdet settes nå dynamisk av JavaScript -->
            <!-- Viser en "laster"-melding mens Firebase initialiserer -->
            <div class="loader">
                ETABLERER TILKOBLING TIL ECHELON 5...<br>
                VENTER PÅ SIKKERT SIGNAL...
            </div>
        </main>

        <!-- 3. TILBAKEMELDING (For "Adgang Nektet") -->
        <div id="feedback"></div>

        <!-- 4. INNTASTINGSFELT (Klistret til bunnen, kun input og dekrypter) -->
        <form id="input-form">
            <input type="text" id="code-input" placeholder="Skriv kode..." autocomplete="off">
            <button type="submit" id="submit-btn">DEKRYPTER</button>
        </form>

    </div>

    <!-- 5. NY MODAL FOR LIVE ADMIN-MELDINGER -->
    <div id="inbox-overlay"></div>
    <div id="inbox-modal">
        <h4><span id="inbox-icon"></span> INNKOMMENDE MELDING</h4>
        <p id="inbox-message-content">...</p>
        <button id="inbox-close-btn" class="download-button">MOTTATT</button>
    </div>


    <!-- 
      ======================================================
      --- ALL APPLIKASJONSLOGIKK SAMLET HER ---
      ======================================================
    -->
    <script type="module">
        // --- 1. IMPORTER FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // NY IMPORT: deleteDoc for admin sletting
        import { getFirestore, setDoc, getDoc, doc, setLogLevel, onSnapshot, updateDoc, getDocs, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 2. VENT TIL HELE SIDEN ER LASTET ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 3. DEFINER GLOBALE VARIABLER OG DATABASER ---

            // --- MANUELL FIREBASE KONFIGURASJON ---
            // Nøklene du limte inn.
            const firebaseConfig = {
                apiKey: "AIzaSyCDcowm--WHC7saXt-YWtg2a2pXC93KSLI",
                authDomain: "echelon-6.firebaseapp.com",
                projectId: "echelon-6",
                storageBucket: "echelon-6.firebasestorage.app",
                messagingSenderId: "1037789395235",
                appId: "1:1037789395235:web:b1b25339342d7e4514f496",
                measurementId: "G-0RQLGZEV5V"
            };

            // Globale Firebase-variabler
            let db, auth, userId, isAuthReady = false;
            let inboxListenerUnsubscribe = null; // For å stoppe lytteren
            let allAgentData = {}; // NY: Global cache for alle agenter i adminvisning

            // Liste over gyldige kodenavn
            const validCodenames = ['raven', 'falcon', 'viper', 'cobra', 'shadow'];

            // Hent kjerne-HTML-elementer
            const messageDisplay = document.getElementById('message-display');
            const codeInput = document.getElementById('code-input');
            const feedbackDisplay = document.getElementById('feedback');
            const inputForm = document.getElementById('input-form');
            
            // NYE KNAPPER I HEADER
            const headerNav = document.getElementById('header-nav');
            const headerArchiveBtn = document.getElementById('header-archive-btn');
            const headerInboxBtn = document.getElementById('header-inbox-btn');
            
            const submitBtn = document.getElementById('submit-btn');

            // Hent modal-elementer
            const inboxOverlay = document.getElementById('inbox-overlay');
            const inboxModal = document.getElementById('inbox-modal');
            const inboxMessageContent = document.getElementById('inbox-message-content');
            const inboxCloseBtn = document.getElementById('inbox-close-btn');

            // Globale variabler for app-tilstand
            let currentCodename = null;
            let currentUserLastCode = null;
            let currentView = 'loading'; // 'loading', 'login', 'mission', 'archive', 'master', 'master-detail', 'inbox'
            const appId = 'echelon-data'; // Erstatter __app_id med en hardkodet verdi

            // Globale variabler for skrivemaskin-effekt
            let isTyping = false;
            let currentTypingTimer = null;
            let currentTextNodes = [];
            let currentTextStrings = [];
            let charIndex = 0;
            let nodeIndex = 0;
            const TYPE_SPEED = 15; // ms per bokstav

            // --- 4. LYD-MODUL (uendret) ---
            let synth, errorSynth, typeSynth, notificationSynth;
            let soundsReady = false;

            function initSound() {
                if (Tone.context.state !== 'running') {
                    Tone.start();
                }
                
                synth = new Tone.Synth({
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 }
                }).toDestination();
                synth.volume.value = -18;

                errorSynth = new Tone.Synth({
                    oscillator: { type: 'sawtooth' },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 }
                }).toDestination();
                errorSynth.volume.value = -15;

                typeSynth = new Tone.NoiseSynth({
                    noise: { type: 'pink' },
                    envelope: { attack: 0.001, decay: 0.01, sustain: 0 }
                }).toDestination();
                typeSynth.volume.value = -40;
                
                notificationSynth = new Tone.Synth({
                    oscillator: { type: 'triangle' },
                    envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 }
                }).toDestination();
                notificationSynth.volume.value = -16;

                soundsReady = true;
            }

            let isFirstClick = true;
            document.body.addEventListener('click', () => {
                if (isFirstClick) {
                    initSound();
                    isFirstClick = false;
                }
            }, { once: true });


            function playClick() {
                if (!soundsReady) return;
                try {
                    synth.triggerAttackRelease("C4", "8n");
                } catch (e) { console.warn("Tone.js feil (klikk):", e.message); }
            }

            function playSuccess() {
                if (!soundsReady) return;
                try {
                    const now = Tone.now();
                    synth.triggerAttackRelease("G4", "8n", now);
                    synth.triggerAttackRelease("C5", "8n", now + 0.1);
                } catch (e) { console.warn("Tone.js feil (suksess):", e.message); }
            }

            function playError() {
                if (!soundsReady) return;
                try {
                    errorSynth.triggerAttackRelease("C3", "4n");
                } catch (e) { console.warn("Tone.js feil (feil):", e.message); }
            }
            
            function playType() {
                if (!soundsReady) return;
                try {
                    typeSynth.triggerAttackRelease("64n"); 
                } catch (e) { /* Ignorer skrive-feil, de er for raske */ }
            }

            function playNotification() {
                 if (!soundsReady) return;
                try {
                    const now = Tone.now();
                    notificationSynth.triggerAttackRelease("A4", "8n", now);
                    notificationSynth.triggerAttackRelease("F4", "8n", now + 0.1);
                } catch (e) { console.warn("Tone.js feil (varsel):", e.message); }
            }
            // --- SLUTT PÅ LYD-MODUL ---


            // --- 5. SKRIVEMASKIN & INNBOKS-MODUL ---

            function stopTyping() {
                if (currentTypingTimer) {
                    clearTimeout(currentTypingTimer);
                }
                isTyping = false;
                currentTypingTimer = null;
            }

            window.skipTyping = function() {
                if (!isTyping) return;
                stopTyping();
                for (let i = 0; i < currentTextNodes.length; i++) {
                    currentTextNodes[i].nodeValue = currentTextStrings[i];
                }
                currentTextNodes = [];
                currentTextStrings = [];
            }

            // Ny funksjon for umiddelbar visning (uten animasjon) for Admin
            function renderInstant(htmlContent) {
                stopTyping();
                messageDisplay.innerHTML = htmlContent;
                currentTextNodes = [];
                currentTextStrings = [];
                isTyping = false;
                window.scrollTo(0, 0);
            }

            function typeText(htmlContent) {
                skipTyping();
                messageDisplay.innerHTML = htmlContent;
                currentTextNodes = [];
                currentTextStrings = [];
                findTextNodes(messageDisplay);
                for (let i = 0; i < currentTextNodes.length; i++) {
                    currentTextStrings[i] = currentTextNodes[i].nodeValue;
                    currentTextNodes[i].nodeValue = '';
                }
                isTyping = true;
                nodeIndex = 0;
                charIndex = 0;
                typeChar();
            }

            function findTextNodes(element) {
                if (element.childNodes.length > 0) {
                    for (let i = 0; i < element.childNodes.length; i++) {
                        findTextNodes(element.childNodes[i]);
                    }
                } else if (element.nodeType === Node.TEXT_NODE && element.nodeValue.trim().length > 0) {
                    currentTextNodes.push(element);
                }
            }

            function typeChar() {
                if (!isTyping) return;
                if (nodeIndex < currentTextNodes.length) {
                    const currentNode = currentTextNodes[nodeIndex];
                    const currentString = currentTextStrings[nodeIndex];
                    if (charIndex < currentString.length) {
                        currentNode.nodeValue += currentString[charIndex];
                        charIndex++;
                        playType();
                    } else {
                        nodeIndex++;
                        charIndex = 0;
                    }
                    currentTypingTimer = setTimeout(typeChar, TYPE_SPEED);
                } else {
                    stopTyping();
                }
            }

            function showInboxMessage(message) {
                playNotification();
                inboxMessageContent.textContent = message;
                inboxOverlay.style.display = 'block';
                inboxModal.style.display = 'block';
            }

            function closeInboxMessage() {
                playClick();
                inboxOverlay.style.display = 'none';
                inboxModal.style.display = 'none';
                if (isAuthReady && userId) {
                    const docRef = doc(db, appId, userId, "progress", "main");
                    updateDoc(docRef, { inbox: "" })
                        .catch(e => console.warn("Kunne ikke tømme innboks:", e));
                }
            }
            
            /**
             * Lagrer en melding lokalt for historikk
             */
            function saveMessageToHistory(message) {
                // Hent eksisterende meldinger
                let messages = JSON.parse(localStorage.getItem('echelonMessages') || '[]');
                
                // Sjekk om meldingen allerede er siste melding (for å unngå duplikater ved refresh)
                if (messages.length > 0 && messages[0].text === message) {
                    return; 
                }
                
                // Legg til ny melding først
                messages.unshift({
                    text: message,
                    timestamp: new Date().toISOString()
                });
                
                // Begrens til 50 meldinger
                if (messages.length > 50) messages = messages.slice(0, 50);
                
                localStorage.setItem('echelonMessages', JSON.stringify(messages));
            }
            
            /**
             * Hjelpefunksjon for å vise/skjule ikoner i header
             */
            function setNavVisibility(visible) {
                if (headerNav) {
                    headerNav.style.display = visible ? 'flex' : 'none';
                }
            }
            
            /**
             * NYTT: Robust funksjon for å be om varslingstillatelse med smartere logikk
             */
            window.requestNotificationPermission = function() {
                if (!("Notification" in window)) {
                    alert("Denne nettleseren støtter ikke systemvarsler. Vennligst bytt nettleser hvis mulig.");
                    return;
                }

                // SJEKK FOR IOS (iPhone/iPad)
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                // Enkel sjekk om appen kjører i "standalone" modus (lagt til på hjemskjerm)
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches;

                if (isIOS && !isStandalone) {
                    alert("⚠️ VIKTIG MELDING TIL IPHONE-BRUKERE ⚠️\n\nFor å kunne motta hemmelige varsler MÅ du legge denne appen til på din Hjem-skjerm først.\n\n1. Trykk på Del-knappen (firkant med pil opp).\n2. Velg 'Legg til på Hjem-skjerm'.\n3. Åpne den nye appen fra hjemskjermen og logg inn der.\n\nDette er påkrevd av Apple for at varsler skal virke.");
                    return;
                }

                // Hvis ikke iPhone, eller hvis den er installert som PWA, be om tillatelse:
                Notification.requestPermission().then((permission) => {
                    if (permission === "granted") {
                        // Send et testvarsel umiddelbart for å bekrefte
                        new Notification("Systemtest", { 
                            body: "Varsler er aktivert for Echelon 5.", 
                            icon: "https://cdn-icons-png.flaticon.com/512/3062/3062634.png"
                        });
                        
                        alert("Varsler er nå AKTIVERT. Du vil motta meldinger selv når skjermen er av (hvis du tillater det i telefonens innstillinger).");
                        
                        // Oppdater UI i innboksen hvis vi er der
                        if(currentView === 'inbox') showInboxView(); 
                        
                    } else if (permission === "denied") {
                        alert("Du har blokkert varsler for denne nettsiden. Du må gå inn i nettleserens innstillinger (eller Android-innstillinger) og fjerne blokkeringen for å kunne motta ordre.");
                    }
                });
            }
            
            // --- SLUTT PÅ SKRIVEMASKIN & INNBOKS-MODUL ---


            // --- DATABASE MED KODEORD OG MELDINGER (uendret) ---
            const briefings = {
                
                '_initial_': (codename) => {
                    const team = (codename === 'raven' || codename === 'falcon') ? 'CELL O (AIRBORNE)' : 'CELL S (GROUND INTEL)';
                    return `
                        <h4>AUTENTISERING GODKJENT</h4>
                        <h5>Agent: ${codename.toUpperCase()}</h5>
                        <p>Velkommen til ECHELON 5-portalen, Agent.</p>
                        <p>Ditt kodenavn er synkronisert med Command Server.<br>Tilkobling til ${team} er etablert.</p>
                        <p>Systemet er nå klart til å motta din første autorisasjonskode.</p>
                        <p>Vennligst vent på direktiv og skriv inn koden nedenfor.</p>
                        <p>— Command Out.</p>
                    `;
                },
                
                // NY: 258 - The Kill Switch Reveal
                '258': `
                    <h4>PROJECT SILENT NORTH — DECLASSIFIED</h4>
                    <p>Korrekt. Summen er verifisert. Tilgang til historisk arkiv gitt.</p>
                    
                    <h5>BAKGRUNN FOR OPERASJONEN:</h5>
                    <p>GNM-modulen dere jakter på er ikke en vanlig jammer. Den er kjernen i "Project Silent North", et topphemmelig NATO-initiativ fra 1982, utviklet for å møte en sovjetisk invasjon i Skagerrak.</p>
                    
                    <p>Teknologien blokkerer ikke GPS-signaler – den <strong>flytter</strong> dem. Målet var å lure fiendtlige flåter til å tro at de var på trygg kurs, mens de i virkeligheten ble ledet rett mot norske skjær og danske sandbanker.</p>
                    
                    <p>Prosjektet ble skrinlagt i 1989 fordi risikoen for sivil sjøfart var for stor. Modulen skulle destrueres i en bunker i Trøndelag, men forsvant under transport.</p>
                    
                    <p>Nå er den aktiv igjen. Dette er ikke sabotasje – det er et våpen som kan omskrive kartet i sanntid.</p>
                    
                    <p>Fortsett mot målet. Denne teknologien må sikres for enhver pris.</p>
                    <p>— Command Out.</p>
                `,

                'team oslo': (codename) => {
                    if (codename === 'raven') {
                        return `
                            <h4>CLASSIFIED MESSAGE — CELL O</h4>
                            <h5>Agent: RAVEN (Airborne Division)</h5>
                            <p>Agent <strong>RAVEN</strong>, du er herved aktivert.</p>
                            <p>Din oppgave er å lede Airborne Division som strategisk observatør. Du har ansvar for overvåkning og identifikasjon fra avstand.</p>
                            
                            <h5>Reiseordre:</h5>
                            <ul>
                                <li>Transportmiddel: <strong>Tog</strong></li>
                                <li>Avreisedato: <strong>27. november</strong></li>
                                <li>Avgang: <strong>Oslo S kl. 09:25</strong></li>
                            </ul>
                            <p>Ved ankomst skal du og Agent <strong>FALCON</strong> ta dere til følgende observasjonspunkt:<br>
                            <a href="https://www.google.com/maps/search/?api=1&query=58.144611,7.988944" target="_blank" class="location-link"><strong>58°08'40.6"N 7°59'20.2"E</strong></a></p>
                            
                            <h5>Oppdrag:</h5>
                            <p>Et kjøretøy (<strong>SD73382</strong>) vil ankomme, bemannet av Ground Intel (Agenter <strong>SHADOW</strong>, <strong>VIPER</strong>, <strong>COBRA</strong>).</p>
                            <p><strong>Din rolle:</strong> Etabler visuell kontakt. Du eller <strong>FALCON</strong> må ta kontakt på bakkenivå når kjøretøyet er i posisjon. Del deres kodeord-del (<strong>AURORA</strong>) for å verifisere sammenslåing.</p>
                            <p>— Command Out.</p>
                            <a href="#" class="download-button" onclick="downloadPakkliste()">Last ned Pakkliste (Echelon 3)</a>
                        `;
                    } else if (codename === 'falcon') {
                         return `
                            <h4>CLASSIFIED MESSAGE — CELL O</h4>
                            <h5>Agent: FALCON (Airborne Division)</h5>
                            <p>Agent <strong>FALCON</strong>, du er herved aktivert.</p>
                            <p>Din oppgave er å fungere som taktisk operatør for Airborne Division, med ansvar for hurtig respons og nærstøtte for Agent <strong>RAVEN</strong>.</p>
                            
                            <h5>Reiseordre:</h5>
                            <ul>
                                <li>Transportmiddel: <strong>Tog</strong></li>
                                <li>Avreisedato: <strong>27. november</strong></li>
                                <li>Avgang: <strong>Oslo S kl. 09:25</strong></li>
                            </ul>
                            <p>Ved ankomst skal du og Agent <strong>RAVEN</strong> ta dere til følgende observasjonspunkt:<br>
                            <a href="https://www.google.com/maps/search/?api=1&query=58.144611,7.988944" target="_blank" class="location-link"><strong>58°08'40.6"N 7°59'20.2"E</strong></a></p>
                            
                            <h5>Oppdrag:</h5>
                            <p>Et kjøretøy (<strong>SD73382</strong>) vil ankomme, bemannet av Ground Intel (Agenter <strong>SHADOW</strong>, <strong>VIPER</strong>, <strong>COBRA</strong>).</p>
                            <p><strong>Din rolle:</strong> Sikre Agent RAVENs posisjon. Du eller <strong>RAVEN</strong> må ta kontakt på bakkenivå når kjøretøyet er i posisjon. Del deres kodeord-del (<strong>AURORA</strong>) for å verifisere sammenslåing. Vær klar for umiddelbar forflytning og dekkild om nødvendig.</p>
                            <p>— Command Out.</p>
                            <a href="#" class="download-button" onclick="downloadPakkliste()">Last ned Pakkliste (Echelon 3)</a>
                        `;
                    }
                    return `<p class="warning">SYSTEMFEIL: KODENAVN IKKE SYNKRONISERT MED DIREKTIV.</p>`;
                },

                'team stavanger': (codename) => {
                    if (codename === 'shadow') {
                        return `
                            <h4>CLASSIFIED MESSAGE — CELL S</h4>
                            <h5>Agent: SHADOW (Feltleder, Ground Intel Unit)</h5>
                            <p>Agent <strong>SHADOW</strong>, du er herved aktivert og har kommandoen over Ground Intelligence Unit.</p>
                            <p>Din rolle: Feltleder og Command liaison. Du koordinerer operasjonen i sanntid og har ansvaret for Agent <strong>VIPER</strong> (Infiltrasjon) og <strong>COBRA</strong> (Teknisk).</p>

                            <h5>Reiseordre:</h5>
                            <ul>
                                <li>Transportmiddel: <strong>Bil (SD73382)</strong></li>
                                <li>Avreisedato: <strong>27. november</strong></li>
                                <li>Avgang: <strong>Stavanger kl. 11:30</strong></li>
                            </ul>
                            <p>Ved ankomst skal dere posisjonere dere ved følgende koordinater:<br>
                            <a href="https://www.google.com/maps/search/?api=1&query=58.144611,7.988944" target="_blank" class="location-link"><strong>58°08'40.6"N 7°59'20.2"E</strong></a></p>

                            <h5>Oppdrag:</h5>
                            <p>Posisjoner kjøretøyet. Airborne Division (Agent <strong>RAVEN</strong> og <strong>FALCON</strong>) vil overvåke ankomsten deres fra avstand.</p>
                            <p>En av dem (enten RAVEN eller FALCON) vil ta kontakt på bakkenivå når dere er i posisjon. Del kodeord-delen deres (<strong>BOREALIS</strong>) med dem for å verifisere sammenslåing.</p>
                            <p>— Command Out.</p>
                            <a href="#" class="download-button" onclick="downloadPakkliste()">Last ned Pakkliste (Echelon 3)</a>
                        `;
                    } else if (codename === 'viper') {
                        return `
                            <h4>CLASSIFIED MESSAGE — CELL S</h4>
                            <h5>Agent: VIPER (Ground Intel Unit)</h5>
                            <p>Agent <strong>VIPER</strong>, du er herved aktivert.</p>
                            <p>Din rolle: Infiltrasjon og nærkontroll. Du er "først inn, sist ut" og har ansvaret for teamets umiddelbare sikkerhet i felt, under kommando av Agent <strong>SHADOW</strong>.</p>

                            <h5>Reiseordre:</h5>
                            <ul>
                                <li>Transportmiddel: <strong>Bil (SD73382)</strong></li>
                                <li>Avreisedato: <strong>27. november</strong></li>
                                <li>Avgang: <strong>Stavanger kl. 11:30</strong></li>
                            </ul>
                            <p>Ved ankomst skal dere posisjonere dere ved følgende koordinater:<br>
                            <a href="https://www.google.com/maps/search/?api=1&query=58.144611,7.988944" target="_blank" class="location-link"><strong>58°08'40.6"N 7°59'20.2"E</strong></a></p>

                            <h5>Oppdrag:</h5>
                            <p>Airborne Division (<strong>RAVEN</strong> og <strong>FALCON</strong>) vil ha overvåkning. En av dem vil ta kontakt på bakkenivå når dere er i posisjon.</p>
                            <p><strong>Din rolle:</strong> Sikre landingssonen *før* kontakten skjer. Hold øye med alle sivile og potensielle trusler. Etter at koden er delt, vær teamets øyne og ører på bakkenivå.</p>
                            <p>— Command Out.</p>
                            <a href="#" class="download-button" onclick="downloadPakkliste()">Last ned Pakkliste (Echelon 3)</a>
                        `;
                    } else if (codename === 'cobra') {
                         return `
                            <h4>CLASSIFIED MESSAGE — CELL S</h4>
                            <h5>Agent: COBRA (Ground Intel Unit)</h5>
                            <p>Agent <strong>COBRA</strong>, du er herved aktivert.</p>
                            <p>Din rolle: Teknisk spesialist og kommunikasjonsansvarlig, under kommando av Agent <strong>SHADOW</strong>. Du håndterer alt av digitalt utstyr og kryptert kommunikasjon.</p>

                            <h5>Reiseordre:</h5>
                            <ul>
                                <li>Transportmiddel: <strong>Bil (SD73382)</strong></li>
                                <li>Avreisedato: <strong>27. november</strong></li>
                                <li>Avgang: <strong>Stavanger kl. 11:30</strong></li>
                            </ul>
                            <p>Ved ankomst skal dere posisjonere dere ved følgende koordinater:<br>
                            <a href="https://www.google.com/maps/search/?api=1&query=58.144611,7.988944" target="_blank" class="location-link"><strong>58°08'40.6"N 7°59'20.2"E</strong></a></p>

                            <h5>Oppdrag:</h5>
                            <p>Airborne Division (<strong>RAVEN</strong> og <strong>FALCON</strong>) vil ha overvåkning. En av dem vil ta kontakt på bakkenivå når dere er i posisjon.</p>
                            <p><strong>Din rolle:</strong> Hold kommunikasjonen åpen. Vær klar til å motta og analysere eventuelle data som overføres fra Airborne-teamet.</p>
                            <p>— Command Out.</p>
                            <a href="#" class="download-button" onclick="downloadPakkliste()">Last ned Pakkliste (Echelon 3)</a>
                        `;
                    }
                    return `<p class="warning">SYSTEMFEIL: KODENAVN IKKE SYNKRONISERT MED DIREKTIV.</p>`;
                },

                // --- FASE 2: SAMMENSLÅING ---
                'aurora borealis': `
                    <h4>DIREKTIV K — VERIFISERT</h4>
                    <p>Sammenslåing av celler godkjent. Nytt direktiv:</p>
                    <p>Dere skal ta ferjen som går til Hirtshals <strong>16:30</strong>.</p>
                    <p><a href="https://storage.googleapis.com/files_webpage/Privat/Colourline%20bilett.pdf" target="_blank" class="location-link"><strong>Referanse: Ferjebilletter</strong></a></p>
                    <p>Når dere er ombord på båten får dere videre instruksjoner av Agent <strong>SHADOW</strong>.</p>
                    <p>— Command Out.</p>
                `,

                // --- FASE 2: FERGE (KODE 1) ---
                'jylland': `
                    <h4>CLASSIFIED TRANSMISSION — SHIPBOARD DIRECTIVE</h4>
                    <p>Godkjent tilgang.</p>
                    <p>Under overfarten har systemet fanget opp et fragmentert signal med seks elementer. Hvert element representerer både en bokstav og et tall, men bare en av delene er korrekt.</p>
                    <p>Krypteringsmetoden følger <strong>NORSE–6-protokollen</strong> – en kombinasjon av fonetisk og numerisk substitusjon.</p>

                    <h5>Intercepted sequence:</h5>
                    <p><strong>11-K, 15-O, 14-N, 22-V, 15-O, 25-Y</strong></p>

                    <h5>For å finne riktig bokstavkode må dere:</h5>
                    <ol>
                        <li><strong>Avdekke mønsteret:</strong><br>
                        Tallene refererer til alfabetets posisjoner (A = 1 … Z = 26). Men <strong>noen</strong> av tallene er falske; de skjuler seg bak primtall. Finn hvilke tall i sekvensen som er primtall, og bytt ut tilhørende bokstaver med bokstaven som kommer <strong>før</strong> i alfabetet.</li>
                        
                        <li><strong>Bruk NATO-fonetisk filtrering:</strong><br>
                        Skriv hele den nye sekvensen i NATO-fonetisk form. Ta den <strong>tredje bokstaven</strong> i hvert fonetiske ord og skriv dem sammen.</li>
                        
                        <li><strong>Resultatet danner Transit Code Alpha (bokstavkode).</strong></li>
                    </ol>
                    <p>Skriv inn koden i portalen når dere er enige.</p>
                    <p>— Command Out.</p>
                `,

                // --- FASE 2: FERGE (KODE 2) - GPS 1 ---
                'lcvccn': `
                    <h4>TRANSIT CODE ALPHA — VERIFIED</h4>
                    <p>Kryptert kommunikasjon gjenopprettet. Neste waypoint er aktivert.</p>
                    
                    <h5>Safehouse koordinater:</h5>
                    <p><a href="https://www.google.com/maps/search/?api=1&query=57.063500,9.913222" target="_blank" class="location-link"><strong>57°03'48.6"N 9°54'47.6"E</strong></a></p>
                    <p><strong>Lokasjon:</strong> Nørresundby</p>
                    <p>Gå direkte til disse koordinatene. Hold lav profil. Når lokasjonen er sikret, må du verifisere din posisjon for å motta neste direktiv.</p>
                    
                    <!-- KNAPP FOR GPS-SJEKK -->
                    <button id="verify-location-btn" class="download-button" onclick="verifySafehouseLocation()">
                        VERIFISER POSISJON
                    </button>
                    
                    <!-- Område for GPS-tilbakemelding -->
                    <div id="location-feedback" style="margin-top: 15px; color: #ff9900; font-weight: bold;"></div>
                `,
                
                // --- FASE 3: SAFEHOUSE ---
                'safehouse check-in': `
                    <h4>CLASSIFIED DIRECTIVE — FLIGHT OPS</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Godt jobbet, agenter. Lokasjon sikret.</p>
                    <p>Etter den vellykkede overføringen fra fergen er situasjonen endret. Våre analyser viser at GNM-modulen har vært aktiv i nettverkssporene vi overvåker.</p>
                    <p>For å sikre at minst ett lag kan rykke inn dersom situasjonen eskalerer, skal dere gjennomføre akutt pilotopplæring i et kontrollert miljø.</p>
                    
                    <p><strong>Lokasjon:</strong> <a href="https://www.google.com/maps/search/?api=1&query=57.086944,9.871694" target="_blank" class="location-link"><strong>57°05'13.0"N 9°52'18.1"E</strong></a><br>
                        <strong>Tid:</strong> 10:00 i morgen</p>
                    
                    <p>Dere vil gjennomføre et fullt <strong>pilottreningsprogram</strong> basert på F-16-plattformen. Forbered dere på høyde, hastighet og presisjon.</p>
                    <p>Etter fullført økt vil vertskapet gi dere neste autorisasjonskode.</p>
                    <p>— Command Out.</p>
                `,

                // --- FASE 4: ETTER FLIGHT OPS - GPS 2 ---
                'fuelcheck': `
                    <h4>CLASSIFIED MESSAGE — POST FLIGHT OPS DIRECTIVE</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Flight-sekvens fullført. Data bekrefter operativ beredskap hos alle enheter.</p>
                    <p>Nye instruksjoner er sent fra kommandonivå.</p>
                    <p>Dere skal trekke tilbake til et sikkert sivilt kontaktpunkt for debrief og midlertidig avventing.</p>
                    
                    <h5>Lokasjon (Dekknavn):</h5>
                    <p><a href="https://www.google.com/maps/search/?api=1&query=Slotsgade+33,+9000+Aalborg" target="_blank" class="location-link"><strong>ISIDOR HENIUS</strong></a><br>
                    <span style="color: #888;">Slotsgade 33, 9000 Aalborg, Denmark</span></p>
                    
                    <p><strong>Oppdrag:</strong> Møt på stedet. Når dere er innenfor rekkevidde, verifiser posisjonen for å motta neste ordre.</p>

                    <!-- KNAPP FOR GPS-SJEKK -->
                    <button id="verify-location-btn" class="download-button" onclick="verifyIsidorLocation()">
                        VERIFISER POSISJON (ISIDOR HENIUS)
                    </button>
                    
                    <!-- Område for GPS-tilbakemelding -->
                    <div id="location-feedback" style="margin-top: 15px; color: #ff9900; font-weight: bold;"></div>
                `,

                // --- FASE 4: ETTER ISIDOR HENIUS ---
                'table 19': `
                    <h4>CLASSIFIED MESSAGE — EVENING DIRECTIVE</h4>
                    <h5>Clearance Level: Echelon 5</h5>
                    <p>Dataoverføring fra Contact Point Bravo er mottatt. Operasjonen går inn i fase 6.</p>
                    <p>Dere har gjort en solid innsats i felt, og kommando gir grønt lys for midlertid rekreasjon og sosial samling før videre operasjon.</p>
                    
                    <h5>Neste oppmøtested:</h5>
                    <p>Et sivilisert deknavn brukt til lavprofil-møter mellom feltagenter:</p>
                    <p><strong>Dekknavn:</strong> THE BLACK TABLE<br>
                    <strong>Lokasjon:</strong> <a href="https://www.google.com/maps/search/?api=1&query=Restaurant+Flammen+Aalborg" target="_blank" class="location-link">Restaurant Flammen</a><br>
                    <strong>Tid:</strong> 19:00</p>
                    <p>— Command Out.</p>
                `,
                
                // --- FASE 5: PÅ RESTAURANT FLAMMEN ---
                'specter one': `
                    <h4>CLASSIFIED MESSAGE — FIELD DIRECTIVE</h4>
                    <h5>Clearance Level: Echelon 5</h5>
                    <p>Mottatt fra Agent <strong>SHADOW</strong>. Bekreftelse mottatt fra Command.</p>
                    <p>Satellittdata fra Jutland Sector viser aktivitet ved et tidligere treningsanlegg nordvest for Aalborg. Området går under dekknavnet:</p>
                    <p><strong>AMMO GROUND</strong></p>
                    <p>Dere skal forflytte dere fra nåværende base og være fullt operative ved morgengry.</p>
                    
                    <p><strong>Oppmøtested:</strong> <a href="https://www.google.com/maps/search/?api=1&query=Magasinvej+7,+9870+Sindal" target="_blank" class="location-link">Magasinvej 7, 9870 Sindal, Denmark</a><br>
                        <strong>Tid:</strong> 09:00 i morgen</p>
                    
                    <h5>Instruks:</h5>
                    <ul>
                        <li>Pakk alle personlige eiendeler og klargjør utstyr for ny forflytning.</li>
                        <li>Etter fullført oppdrag vil dere <strong>ikke returnere</strong> til nåværende base.</li>
                        <li>Vær forberedt på overnatting annet sted etter feltoperasjonen.</li>
                    </ul>
                    
                    <h5>Bekledning:</h5>
                    <ul>
                        <li>Varmt og lagvis tøy (ull, fleece, vindtett jakke)</li>
                        <li>Gode sko eller vanntette støvler</li>
                        <li>Hansker og hodeplagg (lue/buff)</li>
                        <li>Ingen sterke farger — hold lav profil</li>
                    </ul>
                    <p>— Command Out.</p>
                `,

                // --- FASE 6: ETTER AMMO GROUND - GPS 3 ---
                'nordstar': `
                    <h4>CLASSIFIED MESSAGE — EXTRACTION ORDER</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Bekreftelse mottatt fra feltstyrken.</p>
                    <p>Rapportene fra AMMO GROUND bekrefter at GNM-modulen er deaktivert. Interferensloggene viser at systemet forsøkte en reaktivering, men at signalet ble avbrutt.</p>
                    <p>Operasjonen vurderes som suksessfull.</p>
                    <p class="warning">Men deres posisjon er nå kompromittert — det antas at motparten vil forsøke å spore opp teamet.</p>
                    
                    <h5>Direktiv:</h5>
                    <p>Gå i dekning umiddelbart. Dere skal forflytte dere til trygg sone for midlertidig evakuering.</p>
                    <p><strong>Lokasjon:</strong> <a href="https://www.google.com/maps/search/?api=1&query=Skydebanevej+17,+9800+Hjørring" target="_blank" class="location-link">Skydebanevej 17, 9800 Hjørring</a><br>
                    <strong>Dekknavn:</strong> Base Echo</p>
                    <p>Hold lav profil under forflytning. Ved ankomst: sikre lokasjonen og verifiser posisjon for endelig debrief.</p>

                    <!-- KNAPP FOR GPS-SJEKK -->
                    <button id="verify-location-btn" class="download-button" onclick="verifyBaseEchoLocation()">
                        VERIFISER POSISJON (BASE ECHO)
                    </button>
                    
                    <!-- Område for GPS-tilbakemelding -->
                    <div id="location-feedback" style="margin-top: 15px; color: #ff9900; font-weight: bold;"></div>
                `,

                // --- FASE 7: PÅ BASE ECHO (HJØRRING) ---
                'echofall': `
                    <h4>CLASSIFIED MESSAGE — DEBRIEF DIRECTIVE</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Bekreftelse mottatt fra Base Echo.</p>
                    <p>Operasjonen nærmer seg konklusjon. Nye data fra kommandonivå viser at siste del av GNM-protokollen er fanget opp og isolert.</p>
                    <p>Alle enheter skal nå innkalles til endelig debrief og evaluering.</p>
                    
                    <p><strong>Dekknavn:</strong> Operation Bones<br>
                    <strong>Tid:</strong> 20:00<br>
                    <strong>Lokasjon:</strong> <a href="https://www.google.com/maps/search/?api=1&query=Bones+Restaurant,+Hjørring" target="_blank" class="location-link">Bones Restaurant, Hjørring</a></p>
                    
                    <p><strong>Oppdrag:</strong> Møt presist. Hold lav profil. Dette er siste steg før operasjonen avsluttes.</p>
                    <p>— Command Out.</p>
                `,

                // --- FASE 8: AVSLUTNING (PÅ BONES) ---
                'shadowfall': `
                    <h4>CLASSIFIED MESSAGE — OPERATION TERMINATION ORDER</h4>
                    <h5>Clearance Level: ECHELON 5</h5>
                    <p>Bekreftelse mottatt fra feltleder SHADOW. Alle enheter rapportert som sikre.</p>
                    <p><strong>Operasjon NORTHERN STRIKE er herved erklært fullført.</strong></p>
                    <p>GNM-protokollen er isolert, kryptert og fjernet fra aktivt nettverk. Dataene sikret ved AMMO GROUND og overført via Base Echo har stanset reaktivering.</p>
                    <p>Kommandosenteret beordrer umiddelbar tilbaketrekning og oppløsning av operative enheter.</p>
                    
                    <h5>Direktiv:</h5>
                    <ul>
                        <li>Alle enheter trekker ut av operasjonsområdet i morgen.</li>
                        <li>Avreise skjer via maritim transport.</li>
                        <li><strong>Båtavgang:</strong> 12:15 (Møt ved terminal senest 11:45)</li>
                        <li><a href="https://storage.googleapis.com/files_webpage/Privat/Colourline%20bilett.pdf" target="_blank" class="location-link"><strong>Referanse: Ferjebilletter</strong></a></li>
                    </ul>
                    
                    <h5>Transportplan:</h5>
                    <ul>
                        <li><strong>Team Oslo:</strong> Forflytter seg videre med buss fra Kristiansand kl. 16:30.</li>
                        <li><strong>Team Stavanger:</strong> Returnerer kjøretøyet til hjemmebase via landrute.</li>
                    </ul>
                    <p>Hold lav profil under transport. Unngå identifiserbare symboler.</p>
                    <p>Denne operasjonen vil ikke bli offentlig anerkjent. Deres innsats har vært avgjørende.</p>
                    <p><strong>Mission Complete.</strong></p>
                    <p>— SHADOW / Command Out.</p>
                `
            };

            // --- ADMINPORTAL-DATABASE ---
            // Separat liste for admin-visning og arkiv-logikk
            const masterViewData = [
                { id: '_initial_', title: 'FASE 0: AUTENTISERT', team: 'felles', adminNote: 'Første melding agenten ser etter å ha logget inn med kodenavn. Venter på første kode.' },
                { id: 'team oslo', title: 'FASE 1: OSLO', team: 'oslo', adminNote: 'Agent RAVEN og FALCON starter her. De mottar reiserute og første observasjonsoppdrag.' },
                { id: 'team stavanger', title: 'FASE 1: STAVANGER', team: 'stavanger', adminNote: 'Agent SHADOW, VIPER og COBRA starter her. De mottar reiserute og første kontakt-oppdrag.' },
                { id: 'aurora borealis', title: 'FASE 2: SAMMENSLÅING', team: 'felles', adminNote: 'Felles kodeord for begge lag. Låser opp ferje-info. SHADOW utpekes som leder ombord.' },
                { id: 'jylland', title: 'FASE 2: FERGE (KODE 1)', team: 'felles', adminNote: 'Kodeord gitt av SHADOW på fergen. Låser opp NORSE-6-protokoll-puslespillet.' },
                { id: 'lcvccn', title: 'FASE 2: FERGE (KODE 2) - GPS 1', team: 'felles', adminNote: 'Løsningen på puslespillet. Låser opp Safehouse-koordinatene og første GPS-sjekk.', overrideCode: 'safehouse check-in' },
                { id: '258', title: 'BONUS: PROJECT SILENT NORTH', team: 'felles', adminNote: 'Ekstra historie om GNM-modulen, låses opp av "Kill Switch" gåten (summen av tallene).' },
                { id: 'safehouse check-in', title: 'FASE 3: SAFEHOUSE', team: 'felles', adminNote: 'Låses opp av GPS ved Safehouse. Gir info om Flight Ops.' },
                { id: 'fuelcheck', title: 'FASE 4: ETTER FLIGHT OPS - GPS 2', team: 'felles', adminNote: 'Kodeord mottatt etter Flight Ops. Låser opp "Isidor Henius"-møtepunkt og andre GPS-sjekk.', overrideCode: 'table 19' },
                { id: 'table 19', title: 'FASE 4: ISIDOR HENIUS', team: 'felles', adminNote: 'Låses opp av GPS ved Isidor Henius. Gir info om kveldssamling (Restaurant Flammen).' },
                { id: 'specter one', title: 'FASE 5: PÅ FLAMMEN', team: 'felles', adminNote: 'Kodeord gitt av SHADOW på Flammen. Låser opp "AMMO GROUND"-oppdraget og pakkeliste for neste dag.' },
                { id: 'nordstar', title: 'FASE 6: ETTER AMMO GROUND - GPS 3', team: 'felles', adminNote: 'Kodeord gitt etter AMMO GROUND. Låser opp Base Echo (Hjørring) og siste GPS-sjekk.', overrideCode: 'echofall' },
                { id: 'echofall', title: 'FASE 7: BASE ECHO', team: 'felles', adminNote: 'Låses opp av GPS ved Base Echo. Gir info om endelig debrief (Bones).' },
                { id: 'shadowfall', title: 'FASE 8: AVSLUTNING', team: 'felles', adminNote: 'Kodeord gitt av SHADOW på Bones. Avslutter hele operasjonen og gir info om hjemreise.' }
            ];


            // --- 6. KJERNEFUNKSJONALITET (Firebase & App-logikk) ---

            /**
             * Initialiserer Firebase og setter opp autentisering
             */
            async function initFirebase() {
                try {
                    if (!firebaseConfig || !firebaseConfig.apiKey) {
                        throw new Error("Firebase config mangler!");
                    }
                    
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    console.log("Firebase initialisert.");

                    // Håndterer autentisering
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            // Bruker er logget inn
                            userId = user.uid;
                            isAuthReady = true;
                            console.log("Bruker er logget inn:", userId);
                            // Nå som vi er logget inn, last fremdriften
                            await loadProgress();
                            // Start innboks-lytteren
                            startInboxListener(userId);
                        } else {
                            // Bruker er ikke logget inn, prøv å logge inn anonymt
                            console.log("Ingen bruker funnet, logger inn anonymt...");
                            try {
                                const userCredential = await signInAnonymously(auth);
                                // Dette kalles på nytt, som trigger onAuthStateChanged
                            } catch (error) {
                                console.error("Anonym innloggingsfeil:", error);
                                let msg = error.message;
                                if (error.code === 'auth/configuration-not-found') {
                                    msg = "Authentication-tjenesten er ikke aktivert i Firebase-konsollen. Gå til 'Authentication' -> 'Sign-in method' og aktiver 'Anonym'.";
                                }
                                showErrorState("KRITISK FEIL VED INNLOGGING", msg);
                            }
                        }
                    });

                } catch (error) {
                    console.error("Firebase init-feil:", error);
                    showErrorState("SYSTEMFEIL: Kunne ikke koble til Command Server.", error.message);
                }
            }

            /**
             * Starter innboks-lytteren
             */
            function startInboxListener(uid) {
                if (inboxListenerUnsubscribe) {
                    inboxListenerUnsubscribe(); // Stopp forrige lytter
                }
                
                // Må bruke collection-referanse for admin, men her bruker vi doc for agentens personlige innboks
                const docRef = doc(db, appId, uid, "progress", "main"); 
                inboxListenerUnsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.inbox && data.inbox.trim() !== "") {
                            // NYTT: Send System Notification hvis tillatt
                            if (Notification.permission === "granted") {
                                new Notification("ECHELON 5", { 
                                    body: "Ny kryptert melding mottatt.", 
                                    icon: "https://cdn-icons-png.flaticon.com/512/3062/3062634.png" // Enkelt hengelås-ikon
                                });
                            }
                            
                            // Lagre i lokal historikk FØR visning
                            saveMessageToHistory(data.inbox);
                            showInboxMessage(data.inbox);
                        }
                    }
                }, (error) => {
                    console.error("Innboks-lytter feilet:", error);
                });
            }

            /**
             * Viser en permanent feilmelding i meldingsboksen
             */
            function showErrorState(title, message) {
                const errorHtml = `
                    <h4>${title}</h4>
                    <p class="warning">${message}</p>
                    <p>Last siden på nytt og prøv igjen. Hvis feilen vedvarer, kontakt administrator.</p>
                `;
                typeText(errorHtml); // Bruk skrivemaskin
                inputForm.style.display = 'none'; // Skjul input-feltet
            }

            // ... (Kode for getLocalCodename, setLocalCodename, loadProgress er uendret) ...
            
            function getLocalCodename() {
                return localStorage.getItem('echelonAgentCodename');
            }

            function setLocalCodename(codename) {
                localStorage.setItem('echelonAgentCodename', codename);
                currentCodename = codename;
            }

            async function loadProgress() {
                if (!isAuthReady || !userId) {
                    console.warn("Lese-avbrudd: Auth er ikke klar.");
                    return;
                }
                
                currentCodename = getLocalCodename();
                
                if (!currentCodename || !validCodenames.includes(currentCodename)) {
                    console.log("Ingen gyldig kodenavn funnet lokalt. Viser innlogging.");
                    showCodenameLogin();
                    return;
                }

                try {
                    // NYTT: Registrer agentens tilstedeværelse umiddelbart ved innlogging
                    registerAgentPresence(userId, currentCodename);

                    const docRef = doc(db, appId, userId, "progress", "main");
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        currentUserLastCode = data.lastCode;
                        
                        if (data.codename !== currentCodename) {
                            console.warn("Kodenavn-mismatch! DB:", data.codename, "Lokal:", currentCodename, ". Oppdaterer DB.");
                            await saveProgress(currentUserLastCode, false);
                        }
                        
                        console.log("Fremdrift lastet:", currentUserLastCode);
                        showUnlockedMessage(currentUserLastCode, true);
                        // VIS IKONER ETTER SUKSESS
                        setNavVisibility(true);
                    } else {
                        console.log("Ingen fremdrift i DB. Viser standard første melding.");
                        const initialCode = '_initial_';
                        await saveProgress(initialCode, false);
                        showUnlockedMessage(initialCode, true);
                        // VIS IKONER ETTER SUKSESS
                        setNavVisibility(true);
                    }
                } catch (error) {
                    console.error("Feil ved lasting av fremdrift:", error);
                    showErrorState("DATABASEFEIL", "Kunne ikke hente agent-data. Sjekk tilkobling.");
                }
            }
            
            // Hjelpefunksjon for å registrere at agenten finnes i "roten" (slik at admin finner dem)
            async function registerAgentPresence(uid, cname) {
                try {
                    // Vi skriver til hoveddokumentet for brukeren, slik at fetchAllAgents finner det
                    // Dette er "Navneskiltet" i hovedgangen
                    const parentDocRef = doc(db, appId, uid);
                    await setDoc(parentDocRef, {
                        codename: cname,
                        lastSeen: new Date(),
                        active: true
                    }, { merge: true });
                    console.log("Agent registrert i hovedregisteret:", cname);
                } catch (e) {
                    console.warn("Kunne ikke registrere agent-tilstedeværelse:", e);
                }
            }
            
            // Lagrer fremdriften (window.saveProgress er uendret)
            window.saveProgress = async function(code, showMessage = true) {
                if (!isAuthReady || !userId || !currentCodename) {
                    console.warn("Lagre-avbrudd: Auth/kodenavn er ikke klar.");
                    return;
                }
                
                try {
                    // 1. Lagre detaljert fremdrift i undermappen
                    const docRef = doc(db, appId, userId, "progress", "main");
                    await setDoc(docRef, { 
                        lastCode: code,
                        codename: currentCodename,
                        lastUpdated: new Date()
                    }, { merge: true });
                    
                    // 2. Oppdater også "navneskiltet" i hovedmappen (for admin-listen)
                    await registerAgentPresence(userId, currentCodename);
                    
                    currentUserLastCode = code;
                    console.log("Fremdrift lagret:", code, "for", currentCodename);
                    
                    if (showMessage) {
                        showUnlockedMessage(code);
                    }
                } catch (error) {
                    console.error("Feil ved lagring av fremdrift:", error);
                }
            }
            
            /**
             * NY FUNKSJON: Slett en spesifikk agent fra serveren
             */
            window.deleteSingleAgent = async function(agentId) {
                if(!confirm("Er du sikker på at du vil slette denne agenten permanent?")) return;
                
                playClick();
                // Vis loader i detail-view (vi må manuelt oppdatere her siden vi er i detail view)
                const detailContainer = document.querySelector('#message-display'); 
                // Dette er litt hacky, men fungerer for single-page app
                detailContainer.innerHTML = '<h4>SLETTER AGENT...</h4><div class="loader">VENNLIGST VENT...</div>';

                try {
                    // Slett hoved-agent-dokumentet
                    await deleteDoc(doc(db, appId, agentId));
                    // Slett fremdrifts-dokumentet
                    await deleteDoc(doc(db, appId, agentId, "progress", "main"));
                    
                    playSuccess();
                    // Gå tilbake til dashboard etter suksess
                    alert("Agent slettet.");
                    showAgentStatusDashboard();
                    
                } catch (error) {
                    console.error("Sletting av agent feilet:", error);
                    playError();
                    alert("Feil under sletting: " + error.message);
                    showAgentStatusDashboard(); // Gå tilbake uansett
                }
            }


            // NY FUNKSJON: PUSH AGENT TIL NESTE STEG
            /**
             * Tvinger en spesifikk agent (via userId) til å motta et nytt direktiv (code)
             * @param {string} targetUserId - Bruker-ID til agenten som skal oppdateres.
             * @param {string} nextCode - Koden til det neste direktivet som skal låses opp.
             */
            window.pushAgentToCode = async function(targetUserId, nextCode) {
                if (!isAuthReady) {
                    alert("Admin-tilgang ikke autorisert.");
                    return;
                }
                
                playSuccess();
                
                // 1. Skriver den nye koden til agentens fremdrift i databasen
                try {
                    const docRef = doc(db, appId, targetUserId, "progress", "main");
                    await updateDoc(docRef, { 
                        lastCode: nextCode,
                        lastUpdated: new Date(),
                        // Sender en liten beskjed til agentens innboks
                        inbox: `// INNKOMMENDE TRANSMISJON //\nFRA: ECHELON KOMMANDØR\n\nSYSTEM OVERRIDE: Command har manuelt godkjent fortsettelse. Direktiver for kode ${nextCode.toUpperCase()} er nå tilgjengelig.` 
                    });
                    console.log(`Agent ${targetUserId} (${allAgentData[targetUserId].codename}) PUSHET til kode: ${nextCode}`);
                    
                    // 2. Oppdaterer lokalt admin-dashboard (trekker inn ny data)
                    showAgentStatusDashboard(); 
                } catch (error) {
                    playError();
                    alert(`FEIL: Kunne ikke pushe agent ${allAgentData[targetUserId].codename}. Sjekk konsoll for detaljer.`);
                    console.error("PUSH-feil:", error);
                }
            }


            // ... (Resten av funksjonene er uendret eller smått justert for å støtte dashboard) ...

            function showCodenameLogin() {
                currentView = 'login';
                // SKJUL IKONER VED LOGIN
                setNavVisibility(false);
                
                const loginHtml = `
                    <h4>AGENT-AUTENTISERING</h4>
                    <p>Systemet krever identifisering.</p>
                    <p>Vennligst skriv inn ditt tildelte ECHELON 5 kodenavn for å synkronisere med Command Server.</p>
                    <div id="login-form-container">
                        <input type="text" id="codename-input" placeholder="Skriv kodenavn..." autocomplete="off">
                        <button id="codename-submit-btn" onclick="handleCodenameLogin()">AUTENTISER</button>
                        <div id="login-feedback"></div>
                    </div>
                `;
                typeText(loginHtml);
                inputForm.style.display = 'none';

                const codenameInput = document.getElementById('codename-input');
                codenameInput.onkeyup = (e) => {
                    if (e.key === 'Enter') {
                        window.handleCodenameLogin();
                    }
                };
            }

            function submitCode() {
                playClick();
                let code = codeInput.value.toLowerCase().trim();
                
                if (code === "safehouse check-in" || code === "safehouse checkin") {
                    code = 'safehouse check-in';
                }
                
                feedbackDisplay.innerHTML = '';

                // --- MASTER PORTAL KODE ---
                if (code === '95764045') {
                    showMasterPortal();
                    codeInput.value = '';
                    return;
                }
                
                const messageHtml = briefings[code];

                if (messageHtml) {
                    playSuccess();
                    saveProgress(code, true);

                } else {
                    playError();
                    feedbackDisplay.innerHTML = '<p class="warning">ADGANG NEKTET. KODE IKKE GJENKJENT.</p>';
                    const form = inputForm;
                    form.style.animation = 'shake 0.3s';
                    setTimeout(() => { form.style.animation = ''; }, 300);
                }
                
                codeInput.value = '';
            }

            window.showUnlockedMessage = function(code, skipLoader = false) {
                const showContent = () => {
                    const messageContent = (typeof briefings[code] === 'function')
                        ? briefings[code](currentCodename)
                        : briefings[code];
                    
                    if (!messageContent) {
                        console.error(`Fant ikke melding for kode: ${code}`);
                        typeText(`<p class="warning">SYSTEMFEIL: Kunne ikke laste direktiv ${code}.</p>`);
                        return;
                    }

                    typeText(messageContent);
                    inputForm.style.display = 'flex';
                    currentView = 'mission';
                    window.scrollTo(0, 0);
                };

                if (skipLoader) {
                    showContent();
                } else {
                    const loaderHtml = `
                        <div class="loader">
                            DEKRYPTERER SIGNAL...<br>
                            VERIFISERER AUTORISASJON...<br>
                            ETABLERER SIKKER KOBLING...
                        </div>`;
                    typeText(loaderHtml);
                    setTimeout(showContent, 1500);
                }
            }

            window.downloadPakkliste = function() {
                playClick();
                const pakklisteText = `PERSONLIG UTSTYR — STANDARD LOADOUT
CLASSIFIED DOCUMENT — EQUIPMENT MANIFEST

Clearance Level: ECHELON 3
Distribution: Authorized Field Units Only

---------------------------------
⚙️ FELTUTSTYR
For oppdrag under skiftende vær og lang forflytning:
---------------------------------
• Ekstra ullsokker (ett par i vanntett pose)
• Tynt sitteunderlag eller sammenrullbar pute (pause i felt)
• Ørepropper (for søvn eller støy)
• Powerbank
• Ullundertøy
• Fjellsko
• Turbukse (helst uten flashy farger)
• Jakke (helst uten flashy farger)
• Tynne hansker
• Lue

---------------------------------
🧳 SIVILT / LOGISTIKK
For komfort og beredskap mellom operasjonene:
---------------------------------
• Ekstra undertøy og sokker
• Komfortabel bukse for innendørs bruk
• T-skjorte
• Genser
• Reisedokumenter, ID og kopi på mobilen
• Liten notatbok og penn (for oppdragsnotater)

---------------------------------
👔 FORMELLT OPPDAGSANTREKK — “CAUSAL BUSINESS”
---------------------------------
• Finbukser
• Skjorte
• Jakke

---------------------------------
🧴 DIVERSE / PERSONLIG
---------------------------------
• Mobillader
• Solbriller (lav sol i Danmark på vinteren)
• Lommebok
• Toalettsaker

---------------------------------
Instruks:
Pakk lett i ryggsekk. Du må regne med å bære tingene dine under forflytning.
Unngå sterke farger og synlige logoer.
Hold lav profil.
— Command Logistics Division / Operation Northern Strike
`;
                
                const blob = new Blob([pakklisteText], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'pakkliste.txt';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            }


            // --- 7. GPS VERIFISERINGSFUNKSJONER (uendret) ---

            const SAFEHOUSE_LAT = 57.0635;
            const SAFEHOUSE_LON = 9.913222;
            const ISIDOR_LAT = 57.05061;
            const ISIDOR_LON = 9.91976;
            const ECHO_LAT = 57.45788;
            const ECHO_LON = 9.95764;
            const MAX_DISTANCE_METERS = 150;

            window.verifySafehouseLocation = function() {
                playClick();
                verifyLocation(SAFEHOUSE_LAT, SAFEHOUSE_LON, 'safehouse check-in');
            }

            window.verifyIsidorLocation = function() {
                playClick();
                verifyLocation(ISIDOR_LAT, ISIDOR_LON, 'table 19');
            }
            
            window.verifyBaseEchoLocation = function() {
                playClick();
                verifyLocation(ECHO_LAT, ECHO_LON, 'echofall');
            }

            function verifyLocation(targetLat, targetLon, successCode) {
                const feedback = document.getElementById('location-feedback');
                const btn = document.getElementById('verify-location-btn');
                
                if (!navigator.geolocation) {
                    feedback.innerHTML = '<p class="warning">FEIL: GEOLOKASJON STØTTES IKKE AV DENNE ENHETEN.</p>';
                    playError();
                    return;
                }

                feedback.innerHTML = 'Søker etter GPS-signal... Godkjenn forespørsel i nettleser...';
                btn.disabled = true;
                btn.innerHTML = 'LOKALISERER...';

                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000, 
                    maximumAge: 0
                };

                navigator.geolocation.getCurrentPosition(
                    (pos) => locationSuccess(pos, targetLat, targetLon, successCode),
                    locationError,
                    options
                );
            }

            function locationSuccess(pos, targetLat, targetLon, successCode) {
                const feedback = document.getElementById('location-feedback');
                const userLat = pos.coords.latitude;
                const userLon = pos.coords.longitude;
                const distance = calculateDistance(targetLat, targetLon, userLat, userLon);

                if (distance <= MAX_DISTANCE_METERS) {
                    playSuccess();
                    feedback.innerHTML = `POSISJON VERIFISERT (Avstand: ${Math.round(distance)}m). Laster neste direktiv...`;
                    saveProgress(successCode, true);
                } else {
                    playError();
                    feedback.innerHTML = `<p class="warning">VERIFISERING NEKTET. POSISJON LOKALISERT, MEN DU ER IKKE VED MÅLET. (Avstand: ${Math.round(distance)}m). PRØV IGJEN NÅR DU ER NÆRMERE.</p>`;
                    const btn = document.getElementById('verify-location-btn');
                    btn.disabled = false;
                    btn.innerHTML = 'VERIFISER POSISJON PÅ NYTT';
                }
            }

            function locationError(err) {
                playError();
                const feedback = document.getElementById('location-feedback');
                const btn = document.getElementById('verify-location-btn');
                
                let errorMsg = '';
                switch(err.code) {
                    case err.PERMISSION_DENIED: errorMsg = "ADGANG NEKTET. Systemet krever GPS-tilgang for å verifisere posisjon."; break;
                    case err.POSITION_UNAVAILABLE: errorMsg = "SIGNAL TAPT. Posisjonsdata er ikke tilgjengelig. Prøv å gå utendørs."; break;
                    case err.TIMEOUT: errorMsg = "TIDSAVBRUDD. Kunne ikke hente posisjon. Sjekk GPS-signal og prøv igjen."; break;
                    default: errorMsg = "UKJENT GPS-FEIL. Kunne ikke verifisere posisjon."; break;
                }
                feedback.innerHTML = `<p class="warning">${errorMsg}</p>`;
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'VERIFISER POSISJON';
                }
            }

            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3;
                const φ1 = lat1 * Math.PI / 180;
                const φ2 = lat2 * Math.PI / 180;
                const Δφ = (lat2 - lat1) * Math.PI / 180;
                const Δλ = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                          Math.cos(φ1) * Math.cos(φ2) *
                          Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                const d = R * c;
                return d;
            }


            // --- 8. MASTER PORTAL & ARKIV FUNKSJONER ---
            
            /**
             * Henter alle aktive agenter fra Firestore.
             */
            async function fetchAllAgents() {
                if (!isAuthReady) return [];
                
                try {
                    // Vi antar at alle fremdrift-dokumenter ligger i root-samlingen under Agent's UID
                    const agentsRef = collection(db, appId);
                    const querySnapshot = await getDocs(agentsRef);
                    
                    const agents = {};
                    querySnapshot.forEach(doc => {
                        // Sjekk om det er en brukerfremdrift, og ikke metadata
                        if (doc.id.length > 20) { 
                            const data = doc.data();
                            
                            // Sjekker om vi fant et "navneskilt" i hovedmappen
                            if (data.codename) {
                                // Prøver også å hente siste kode fra undermappen hvis den finnes
                                // Dette gjøres i neste steg
                                agents[doc.id] = {
                                    id: doc.id,
                                    codename: data.codename,
                                    lastSeen: data.lastSeen
                                };
                            }
                        }
                    });

                    // Nå må vi hente "main" dokumentet fra sub-samlingen for hver agent for å få STATUS
                    const agentsWithProgress = {};
                    for (const agentId of Object.keys(agents)) {
                        const progressRef = doc(db, appId, agentId, "progress", "main");
                        const progressSnap = await getDoc(progressRef);
                        
                        let lastCode = '_initial_';
                        let lastUpdated = null;

                        if (progressSnap.exists()) {
                            const progressData = progressSnap.data();
                            lastCode = progressData.lastCode || '_initial_';
                            lastUpdated = progressData.lastUpdated ? progressData.lastUpdated.toDate() : null;
                        }
                        
                        agentsWithProgress[agentId] = {
                            id: agentId,
                            codename: agents[agentId].codename || 'UKJENT',
                            lastCode: lastCode,
                            lastUpdated: lastUpdated || (agents[agentId].lastSeen ? agents[agentId].lastSeen.toDate() : null)
                        };
                    }
                    
                    allAgentData = agentsWithProgress; // Cache resultatet
                    return agentsWithProgress;
                } catch (e) {
                    console.error("Feil ved henting av agenter for Admin Dashboard:", e);
                    return {};
                }
            }


            /**
             * Viser Master Admin-portalen (HOVEDMENY)
             */
            window.showMasterPortal = function() {
                playClick();
                currentView = 'master';
                const menuHtml = `
                    <h4>ADMINISTRATORPORTAL</h4>
                    <p>Velg modul:</p>
                    <button class="admin-menu-btn" onclick="showAgentStatusDashboard()">1. AGENT STATUS DASHBOARD</button>
                    <button class="admin-menu-btn" onclick="showMissionOverview()">2. OPPDRAGSOVERSIKT</button>
                    <button class="admin-menu-btn" onclick="showSystemReset()">3. SYSTEM TILBAKESTILLING</button>
                    <button class="admin-menu-btn" onclick="showMessagingInterface()">4. MELDINGER</button>
                    <button class="admin-menu-btn" style="border-color: #444; color: #888;" onclick="exitAdminPortal()">TILBAKE TIL EGET OPPDRAG</button>
                `;
                renderInstant(menuHtml); // Bruker renderInstant i stedet for typeText
            }
            
            /**
             * Gå ut av admin-modus og tilbake til spiller-modus
             */
            window.exitAdminPortal = function() {
                playClick();
                showUnlockedMessage(currentUserLastCode, true);
            }

            // --- MODUL 1: AGENT STATUS DASHBOARD ---
            window.showAgentStatusDashboard = async function() {
                playClick();
                currentView = 'master'; // Fortsatt admin
                renderInstant('<h4>AGENT STATUS DASHBOARD</h4><div class="loader">HENTER AGENTSTATUS...</div>');

                const agents = await fetchAllAgents();
                let dashboardHtml = '<a href="#" onclick="showMasterPortal(); return false;">&laquo; Tilbake til Hovedmeny</a><br><br>';
                dashboardHtml += '<h5>AKTIVE AGENTER</h5><div id="agent-dashboard">';

                if (Object.keys(agents).length === 0) {
                    dashboardHtml += '<p class="warning">Ingen aktive agenter funnet i databasen.</p>';
                } else {
                    Object.keys(agents).forEach(id => {
                        const agent = agents[id];
                        const code = agent.lastCode;
                        const team = (agent.codename === 'raven' || agent.codename === 'falcon') ? 'Oslo (Airborne)' : 'Stavanger (Ground)';
                        
                        const statusTitle = masterViewData.find(m => m.id === code)?.title || `UKJENT KODE: ${code}`;
                        const statusIconClass = code === 'shadowfall' ? 'status-ready' : (code === '_initial_' ? 'status-login' : 'status-stuck');
                        const statusIcon = code === 'shadowfall' ? '✅' : (code === '_initial_' ? '⚠️' : '➡️');

                        // Finn neste mulige steg for PUSH-funksjonen
                        const currentIndex = masterViewData.findIndex(m => m.id === code);
                        const nextMission = masterViewData[currentIndex + 1];
                        
                        let pushButtonHtml = '';
                        if (nextMission && nextMission.id !== 'shadowfall') {
                            pushButtonHtml = `<button class="push-button" onclick="pushAgentToCode('${id}', '${nextMission.id}'); return false;">PUSH til ${nextMission.title}</button>`;
                        } else if (code !== 'shadowfall') {
                            pushButtonHtml = `<button class="push-button" onclick="pushAgentToCode('${id}', 'shadowfall'); return false;">AVSLUTT OPPRAG</button>`;
                        }

                        dashboardHtml += `
                            <div class="agent-item">
                                <div class="agent-info" onclick="showAdminAgentDetail('${id}'); return false;">
                                    <strong>${agent.codename.toUpperCase()}</strong> (${team})
                                    <span class="agent-id">${id.substring(0, 8)}...</span>
                                </div>
                                <div class="agent-status">
                                    <span class="status-icon ${statusIconClass}">${statusIcon}</span>
                                    ${statusTitle}
                                    ${pushButtonHtml}
                                </div>
                            </div>
                        `;
                    });
                }
                dashboardHtml += '</div>';
                renderInstant(dashboardHtml);
            }

            // --- MODUL 2: OPPDRAGSOVERSIKT ---
            window.showMissionOverview = function() {
                playClick();
                currentView = 'master';
                let overviewHtml = '<a href="#" onclick="showMasterPortal(); return false;">&laquo; Tilbake til Hovedmeny</a><br><br>';
                overviewHtml += '<h5>OPPDRAGSOVERSIKT</h5><div class="master-list">';
                masterViewData.forEach((item, index) => {
                    overviewHtml += `
                        <a href="#" class="master-link" onclick="showMasterDetailView('${item.id}'); return false;">
                            <span>#${index}</span>
                            <strong>${item.title}</strong>
                        </a>
                    `;
                });
                overviewHtml += '</div>';
                renderInstant(overviewHtml);
            }

            // --- MODUL 3: SYSTEM TILBAKESTILLING ---
            window.showSystemReset = function() {
                playClick();
                currentView = 'master';
                let resetHtml = '<a href="#" onclick="showMasterPortal(); return false;">&laquo; Tilbake til Hovedmeny</a><br><br>';
                resetHtml += `
                    <h5 style="margin-top: 30px;">SYSTEM-TILBAKESTILLING</h5>
                    <p>Velg handling:</p>
                    
                    <button class="download-button" style="background-color: #ff5555; margin-bottom: 20px;" onclick="resetAllServerData();">SLETT ALLE AGENT-DATA (SERVER)</button>
                    
                    <button class="download-button" style="background-color: #444; border: 1px solid #666;" onclick="resetLocalAgent();">Tilbakestill Lokal Agent</button>
                    
                    <p style="margin-top: 20px; color: #888; font-size: 0.8rem;">
                        <strong>SERVER-SLETTING:</strong> Fjerner all fremdrift for ALLE agenter permanent fra databasen. Brukes før ny spillstart.<br>
                        <strong>LOKAL TILBAKESTILLING:</strong> Fjerner kun din egen innlogging på denne enheten.
                    </p>
                `;
                renderInstant(resetHtml);
            }
            
            /**
             * NY FUNKSJON: Slett all agentdata fra serveren
             */
            window.resetAllServerData = async function() {
                if (!confirm("ADVARSEL: Dette vil slette fremdriften til ALLE agenter fra databasen. Handlingen kan ikke angres. Er du sikker?")) {
                    return;
                }
                
                playClick();
                renderInstant('<h4>SYSTEM-TILBAKESTILLING</h4><div class="loader">SLETTER DATA...</div>');
                
                try {
                    const agents = await fetchAllAgents();
                    const agentIds = Object.keys(agents);
                    
                    if (agentIds.length === 0) {
                        renderInstant('<h4>SYSTEM-TILBAKESTILLING</h4><p>Ingen data funnet å slette.</p><button class="download-button" onclick="showSystemReset()">Tilbake</button>');
                        return;
                    }

                    // Slett operations
                    const deletePromises = agentIds.map(async (agentId) => {
                        // Slett hoved-agent-dokumentet
                        await deleteDoc(doc(db, appId, agentId));
                        // Slett fremdrifts-dokumentet
                        await deleteDoc(doc(db, appId, agentId, "progress", "main"));
                    });
                    
                    await Promise.all(deletePromises);
                    
                    playSuccess();
                    renderInstant(`
                        <h4>SYSTEM-TILBAKESTILLING</h4>
                        <p style="color: #55ff55;">SUKSESS: Data for ${agentIds.length} agenter er slettet fra serveren.</p>
                        <button class="download-button" onclick="showSystemReset()">Tilbake til Meny</button>
                    `);
                    
                } catch (error) {
                    console.error("Sletting feilet:", error);
                    playError();
                    renderInstant(`
                        <h4>SYSTEM-TILBAKESTILLING</h4>
                        <p class="warning">FEIL UNDER SLETTING: ${error.message}</p>
                        <button class="download-button" onclick="showSystemReset()">Prøv igjen</button>
                    `);
                }
            }

            // --- MODUL 4: MELDINGER (NY) ---
            window.showMessagingInterface = async function() {
                playClick();
                currentView = 'master';
                renderInstant('<h4>SEND MELDING</h4><div class="loader">HENTER MOTTAKERE...</div>');
                
                const agents = await fetchAllAgents();
                let optionsHtml = '<option value="all">ALLE AGENTER (Kringkasting)</option>';
                
                Object.keys(agents).forEach(id => {
                    const agent = agents[id];
                    optionsHtml += `<option value="${id}">${agent.codename.toUpperCase()} (ID: ${id.substring(0,5)}...)</option>`;
                });
                
                // HURTIGVALG: KOGNITIVE TESTER (FASE 4)
                let quickMsgHtml = `
                    <p style="font-size:0.8rem; color:#888; margin-top:20px;">HURTIGVALG: VED LANDING (kl 19:45 - KOGNITIV SJEKK)</p>
                    <div style="display:flex; flex-wrap:wrap; gap:5px;">
                        <button class="quick-msg-btn" onclick="setQuickMsg('viper', 'Det har kommet inn en kryptert melding fra Echelon kommandøren. For å lese meldingen må du løse følgende kode:\\n\\n4 – 6 – 9 – 14 – 21 – 32 – 45 – ?\\n\\nSummer svarene deres og skriv svaret inn i Echelonportalen for å lese meldingen.')">VIPER (Primtall)</button>
                        <button class="quick-msg-btn" onclick="setQuickMsg('cobra', 'Det har kommet inn en kryptert melding fra Echelon kommandøren. For å lese meldingen må du løse følgende kode:\\n\\n2 – 5 – 10 – 17 – 26 – 37 – 50 – ?\\n\\nSummer svarene deres og skriv svaret inn i Echelonportalen for å lese meldingen.')">COBRA (Oddetall)</button>
                        <button class="quick-msg-btn" onclick="setQuickMsg('raven', 'Det har kommet inn en kryptert melding fra Echelon kommandøren. For å lese meldingen må du løse følgende kode:\\n\\n10 – 11 – 13 – 17 – 25 – 32 – ?\\n\\nSummer svarene deres og skriv svaret inn i Echelonportalen for å lese meldingen.')">RAVEN (Tverrsum)</button>
                        <button class="quick-msg-btn" onclick="setQuickMsg('falcon', 'Det har kommet inn en kryptert melding fra Echelon kommandøren. For å lese meldingen må du løse følgende kode:\\n\\n3 – 4 – 8 – 17 – 33 – 58 – ?\\n\\nSummer svarene deres og skriv svaret inn i Echelonportalen for å lese meldingen.')">FALCON (Kvadrat)</button>
                    </div>
                    
                    <p style="font-size:0.8rem; color:#888; margin-top:10px;">OPPFØLGING (NÅR DE HAR SVART):</p>
                    <div style="display:flex; flex-wrap:wrap; gap:5px;">
                        <button class="quick-msg-btn" style="width:100%; text-align:center;" onclick="setQuickMsg('all', 'MELDING TIL ALLE ENHETER:\\nDere har mottatt individuelle fragmenter.\\nSummen av deres svar utgjør &quot;Fail-Safe&quot;-koden for morgendagens operasjon.\\nKalkuler og bekreft summen til SHADOW.\\n(Summen er koden for neste steg).')">SEND TIL ALLE: "Summen av svarene..."</button>
                    </div>
                `;

                let messagingHtml = `
                    <a href="#" onclick="showMasterPortal(); return false;">&laquo; Tilbake til Hovedmeny</a><br><br>
                    <h5>KOMMUNIKASJONSSENTRAL</h5>
                    <p>Send kryptert melding direkte til agentenes terminaler.</p>
                    
                    <label for="msg-recipient" style="display:block; margin-bottom:5px; color:#ff9900;">MOTTAKER:</label>
                    <select id="msg-recipient">${optionsHtml}</select>
                    
                    <label for="msg-text" style="display:block; margin-bottom:5px; color:#ff9900;">MELDING:</label>
                    <textarea id="msg-text" placeholder="Skriv melding her..."></textarea>
                    
                    <button class="download-button" onclick="sendAdminMessage()">SEND MELDING</button>
                    <div id="msg-feedback" style="margin-top:10px; text-align:center;"></div>
                    
                    ${quickMsgHtml}
                `;
                renderInstant(messagingHtml);
            }
            
            // Hjelpefunksjon for hurtigvalg av meldinger
            window.setQuickMsg = async function(targetCodename, messageText) {
                // Hvis target er 'all', trenger vi ikke søke
                if (targetCodename === 'all') {
                    document.getElementById('msg-recipient').value = 'all';
                    document.getElementById('msg-text').value = messageText;
                    return;
                }

                // Finn riktig mottaker-ID basert på kodenavn
                const agents = await fetchAllAgents(); // Vi trenger ferske data
                let targetId = null;
                
                Object.keys(agents).forEach(id => {
                    if (agents[id].codename.toLowerCase() === targetCodename.toLowerCase()) {
                        targetId = id;
                    }
                });
                
                const recipientSelect = document.getElementById('msg-recipient');
                const textField = document.getElementById('msg-text');
                
                if (targetId) {
                    recipientSelect.value = targetId;
                    textField.value = messageText;
                } else {
                    alert(`Fant ikke agent med kodenavn ${targetCodename}. Er de logget inn?`);
                }
            }

            window.sendAdminMessage = async function() {
                const recipient = document.getElementById('msg-recipient').value;
                const message = document.getElementById('msg-text').value;
                const feedback = document.getElementById('msg-feedback');
                
                if (!message.trim()) {
                    feedback.innerHTML = '<span class="warning">Melding kan ikke være tom.</span>';
                    playError();
                    return;
                }
                
                feedback.innerHTML = 'Sender...';
                playClick();
                
                // Formatert melding med avsender
                const signedMessage = `// INNKOMMENDE TRANSMISJON //\nFRA: ECHELON KOMMANDØR\n\n${message}`;

                try {
                    if (recipient === 'all') {
                        // Send til alle
                        const agents = await fetchAllAgents();
                        const promises = Object.keys(agents).map(agentId => {
                            const docRef = doc(db, appId, agentId, "progress", "main");
                            return updateDoc(docRef, { 
                                inbox: signedMessage 
                            });
                        });
                        await Promise.all(promises);
                        feedback.innerHTML = '<span style="color:#55ff55;">MELDING SENDT TIL ALLE ENHETER.</span>';
                    } else {
                        // Send til enkeltagent
                        const docRef = doc(db, appId, recipient, "progress", "main");
                        await updateDoc(docRef, { 
                            inbox: signedMessage 
                        });
                        feedback.innerHTML = '<span style="color:#55ff55;">MELDING SENDT.</span>';
                    }
                    playSuccess();
                    document.getElementById('msg-text').value = '';
                } catch (error) {
                    console.error("Meldingsfeil:", error);
                    feedback.innerHTML = '<span class="warning">FEIL VED SENDING. Sjekk konsoll.</span>';
                    playError();
                }
            }
            
            /**
             * NY FUNKSJON: Detaljvisning for en enkelt agent i Admin Dashboard
             */
            window.showAdminAgentDetail = function(agentId) {
                playClick();
                const agent = allAgentData[agentId];
                if (!agent) {
                    renderInstant(`<h4>FEIL</h4><p class="warning">Kunne ikke finne detaljer for Agent ${agentId}</p>`);
                    return;
                }
                
                const lastCodeTitle = masterViewData.find(m => m.id === agent.lastCode)?.title || 'Ukjent kode';
                const team = (agent.codename === 'raven' || agent.codename === 'falcon') ? 'Oslo (Airborne)' : 'Stavanger (Ground)';
                
                const detailHtml = `
                    <a href="#" onclick="showAgentStatusDashboard(); return false;">&laquo; Tilbake til Dashboard</a>
                    <h4 style="margin-top: 15px;">AGENT RAPPORT: ${agent.codename.toUpperCase()}</h4>
                    <p><strong>Team/Rolle:</strong> ${team}</p>
                    <p><strong>Siste Aktiverte Kode:</strong> <strong>${agent.lastCode}</strong> (${lastCodeTitle})</p>
                    <p><strong>Sist Oppdatert:</strong> ${agent.lastUpdated ? agent.lastUpdated.toLocaleString() : 'N/A'}</p>
                    <p class="agent-id"><strong>UserID:</strong> ${agentId}</p>
                    
                    <h5 style="margin-top: 30px;">TVING FREMDRIFT (PUSH)</h5>
                    <p>Velg neste oppdrag for å tvinge agenten fremover. Agenten får en varselmelding.</p>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${masterViewData.map(mission => {
                        // Kan ikke pushe til 'initial' eller hvis allerede fullført
                        const isDisabled = mission.id === '_initial_' || masterViewData.findIndex(m => m.id === mission.id) <= masterViewData.findIndex(m => m.id === agent.lastCode);
                        
                        return `<button 
                            class="push-button" 
                            style="background-color: ${isDisabled ? '#444' : '#ff5555'}; cursor: ${isDisabled ? 'not-allowed' : 'pointer'};"
                            onclick="${isDisabled ? 'return false;' : `pushAgentToCode('${agentId}', '${mission.id}'); return false;`}"
                            ${isDisabled ? 'disabled' : ''}
                        >
                            ${mission.title}
                        </button>`;
                    }).join('')}
                    </div>
                    
                    <h5 style="margin-top: 30px; border-top: 1px solid #444; padding-top: 20px;">SIKKERHETSPROTOKOLL</h5>
                    <button class="download-button" style="background-color: #ff0000; color: #fff; border: 2px solid #fff;" onclick="deleteSingleAgent('${agentId}');">SLETT DENNE AGENTEN (RESET)</button>
                    
                    <p style="margin-top: 20px;"><small>Merk: Du kan også sende personlige meldinger via hovedmenyen.</small></p>
                `;
                renderInstant(detailHtml);
            }


            /**
             * Viser detaljsiden for ett oppdrag i Master-portalen
             */
            window.showMasterDetailView = function(code) {
                playClick();
                currentView = 'master-detail';
                const mission = masterViewData.find(m => m.id === code);
                const messageHtml = (typeof briefings[code] === 'function')
                    ? briefings[code]('SHADOW') // Viser bare "SHADOW" som eksempel for admin
                    : briefings[code];
                    
                // Finner alle agenter som har fullført dette oppdraget
                const agentsCompleted = Object.values(allAgentData).filter(agent => agent.lastCode === code);

                let detailHtml = `
                    <a href="#" onclick="showMissionOverview(); return false;">&laquo; Tilbake til Oversikt</a>
                    <h4 style="margin-top: 15px;">ADMIN: ${mission.title}</h4>
                    <p><strong>KODEORD:</strong> ${mission.id}</p>
                    <p><strong>ADMIN-NOTAT:</strong> <em>${mission.adminNote}</em></p>
                    
                    <h5 style="margin-top: 30px;">AGENTSTATUS FOR DETTE STEGET</h5>
                    <p>Følgende ${agentsCompleted.length} agenter er for øyeblikket på dette steget:</p>
                    <ul style="list-style: none; margin-left: 0; padding-left: 0;">
                    ${agentsCompleted.map(agent => 
                        `<li style="font-weight: bold; color: #ffc266;">- ${agent.codename.toUpperCase()}</li>`
                    ).join('') || '<li>Ingen agenter på dette steget.</li>'}
                    </ul>

                `;

                // --- GPS OVERRIDE KNAPP ---
                if (mission.overrideCode) {
                    detailHtml += `
                        <div style="border: 2px dashed #ff5555; padding: 15px; margin: 20px 0; background: rgba(255, 85, 85, 0.1);">
                            <h5 style="margin-top:0; color: #ff5555;">⚠️ NO-FAIL OVERRIDE (For din økt)</h5>
                            <p style="font-size: 0.9em;">Dette steget krever GPS. Hvis GPS feiler for agentene, trykk her for å tvinge godkjenning for <strong>DIN LOKALE AGENT</strong> og låse opp neste steg ("${mission.overrideCode}").</p>
                            <button class="download-button" style="background-color: #ff5555; margin-top: 10px;" 
                                onclick="saveProgress('${mission.overrideCode}', true);">
                                🚨 TVING GPS-GODKJENNING (Kun for din agent)
                            </button>
                        </div>
                    `;
                }

                detailHtml += `
                    <hr style="border-color: #444; margin: 20px 0;">
                    <h4>EKSEMPEL PÅ MELDING (for 'SHADOW'):</h4>
                    <div>${messageHtml}</div>
                `;
                
                renderInstant(detailHtml);
            }
            
            // ... (Resten av arkiv- og hjelpefunksjonene er uendret) ...

            window.showCompletedMissionsMenu = function() {
                playClick();
                currentView = 'archive';
                
                const agentTeam = (currentCodename === 'raven' || currentCodename === 'falcon') ? 'oslo' : 'stavanger';
                let listHtml = '<h4>OPPDRAGSARKIV</h4><div class="master-list">';
                const lastCodeIndex = masterViewData.findIndex(m => m.id === currentUserLastCode);
                
                if (lastCodeIndex === -1) {
                    listHtml += '<p>Ingen oppdrag fullført ennå.</p>';
                } else {
                    for (let i = 0; i <= lastCodeIndex; i++) {
                        const mission = masterViewData[i];
                        if (mission.id === '_initial_') {
                            continue;
                        }
                        if (mission.team === 'felles' || mission.team === agentTeam) {
                            listHtml += `
                                <a href="#" class="master-link" onclick="showArchiveDetailView('${mission.id}'); return false;">
                                    <span>#${i}</span>
                                    <strong>${mission.title}</strong>
                                </a>
                            `;
                        }
                    }
                }
                
                listHtml += '</div>';
                // Use currentUserLastCode directly in the template literal
                listHtml += `<button class="download-button" onclick="showUnlockedMessage('${currentUserLastCode}', true);">Tilbake til Siste Oppdrag</button>`;
                typeText(listHtml);
            }
            
            // --- NY FUNKSJON: VIS INNBOKS ---
            window.showInboxView = function() {
                playClick();
                currentView = 'inbox';
                
                const messages = JSON.parse(localStorage.getItem('echelonMessages') || '[]');
                
                let inboxHtml = '<h4>MELDINGSINNBOKS</h4><div class="master-list">';
                
                // MANUELL VARSLINGSKNAPP
                if (Notification.permission !== "granted") {
                    inboxHtml += `
                        <div style="background:#333; padding:10px; margin-bottom:15px; border-left:3px solid #ff9900;">
                            <p style="margin:0; font-size:0.9em; color:#ff9900;">SYSTEMVARSEL: Varslinger er ikke aktivert.</p>
                            <button class="download-button" style="margin-top:5px; padding:5px; font-size:0.8em;" onclick="window.requestNotificationPermission();">AKTIVER VARSLER PÅ DENNE ENHETEN</button>
                        </div>
                    `;
                }
                
                if (messages.length === 0) {
                    inboxHtml += '<p style="text-align:center; color:#888; margin-top:20px;">Ingen meldinger mottatt.</p>';
                } else {
                    messages.forEach(msg => {
                        const date = new Date(msg.timestamp);
                        const timeString = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        inboxHtml += `
                            <div class="inbox-item">
                                <div class="inbox-time">MOTTATT: ${timeString}</div>
                                <div class="inbox-msg">${msg.text}</div>
                            </div>
                        `;
                    });
                }
                
                inboxHtml += '</div>';
                // Use currentUserLastCode directly in the template literal
                inboxHtml += `<button class="download-button" onclick="showUnlockedMessage('${currentUserLastCode}', true);">Tilbake til Oppdrag</button>`;
                
                typeText(inboxHtml);
            }

            window.showArchiveDetailView = function(code) {
                playClick();
                currentView = 'archive-detail';
                const messageHtml = (typeof briefings[code] === 'function')
                    ? briefings[code](currentCodename)
                    : briefings[code];

                const detailHtml = `
                    <a href="#" onclick="showCompletedMissionsMenu(); return false;">&laquo; Tilbake til Arkiv</a>
                    <div style="margin-top: 15px;">${messageHtml}</div>
                `;
                typeText(detailHtml);
            }

            window.resetLocalAgent = function() {
                playError();
                localStorage.removeItem('echelonAgentCodename');
                // SKJUL IKONER VED RESET
                setNavVisibility(false);
                showCodenameLogin();
            }

            window.handleCodenameLogin = function() {
                playClick();
                const codenameInput = document.getElementById('codename-input');
                const loginFeedback = document.getElementById('login-feedback');
                const input = codenameInput.value.toLowerCase().trim();
                
                if (validCodenames.includes(input)) {
                    // NYTT: BE OM VARSLINGSTILLATELSE
                    window.requestNotificationPermission();
                    
                    playSuccess();
                    setLocalCodename(input);
                    loadProgress();
                    // VIS IKONER ETTER SUKSESS
                    setNavVisibility(true);
                } else {
                    playError();
                    loginFeedback.innerHTML = '<p class="warning">KODENAVN IKKE GJENKJENT.</p>';
                    codenameInput.value = '';
                }
            };
            
            /**
             * Hjelpefunksjon for å vise/skjule ikoner i header
             */
            function setNavVisibility(visible) {
                if (headerNav) {
                    headerNav.style.display = visible ? 'flex' : 'none';
                }
            }
            
            /**
             * NYTT: Robust funksjon for å be om varslingstillatelse
             */
            window.requestNotificationPermission = function() {
                if (!("Notification" in window)) {
                    alert("Denne nettleseren støtter ikke systemvarsler.");
                    return;
                }

                Notification.requestPermission().then((permission) => {
                    if (permission === "granted") {
                        // Send et testvarsel umiddelbart for å bekrefte
                        new Notification("Systemtest", { 
                            body: "Varsler er aktivert for Echelon 5.", 
                            icon: "https://cdn-icons-png.flaticon.com/512/3062/3062634.png"
                        });
                        
                        // Oppdater UI i innboksen hvis vi er der
                        if(currentView === 'inbox') showInboxView(); 
                        
                    } else if (permission === "denied") {
                        alert("Du har blokkert varsler. Du må gå inn i nettleserens innstillinger for å aktivere dem igjen.");
                    }
                });
            }
            
            // --- SLUTT PÅ SKRIVEMASKIN & INNBOKS-MODUL ---


            
            // --- 9. START APPLIKASJONEN ---
            
            inputForm.onsubmit = (e) => {
                e.preventDefault();
                submitCode();
            };
            
            // HEADER-IKON EVENT LISTENERS
            headerArchiveBtn.onclick = () => {
                playClick();
                if (currentView === 'archive' || currentView === 'archive-detail') {
                    showUnlockedMessage(currentUserLastCode, true); // Tilbake hvis man allerede er der
                } else {
                    showCompletedMissionsMenu();
                }
            };
            
            headerInboxBtn.onclick = () => {
                playClick();
                if (currentView === 'inbox') {
                    showUnlockedMessage(currentUserLastCode, true); // Tilbake hvis man allerede er der
                } else {
                    showInboxView();
                }
            };

            inboxCloseBtn.onclick = closeInboxMessage;

            initFirebase();
            
        }); // Slutt på DOMContentLoaded

    </script>
    
    <!-- CSS for Riste-animasjon (valgfritt) -->
    <style>
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { translateX(-5px); }
            50% { translateX(5px); }
            75% { translateX(-5px); }
            100% { transform: translateX(0); }
        }
    </style>

</body>
</html>
